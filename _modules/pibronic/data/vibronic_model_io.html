
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pibronic.data.vibronic_model_io &#8212; Pibronic 0.1.2 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pibronic.data.vibronic_model_io</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;vibronic_model_io.py should handle the majority of file I/O&quot;&quot;&quot;</span>

<span class="c1"># system imports</span>
<span class="c1"># from pathlib import Path</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
<span class="c1"># import functools as ft</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="c1"># import fileinput</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="c1"># import math</span>
<span class="kn">import</span> <span class="nn">mmap</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># third party imports</span>
<span class="kn">import</span> <span class="nn">fortranformat</span> <span class="k">as</span> <span class="nn">ff</span>  <span class="c1"># Fortran format for VIBRON</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># from numpy import newaxis as NEW</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">float64</span> <span class="k">as</span> <span class="n">F64</span>
<span class="kn">import</span> <span class="nn">parse</span>

<span class="c1"># local imports</span>
<span class="kn">from</span> <span class="nn">..log_conf</span> <span class="k">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">helper</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">file_structure</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">file_name</span>


<span class="c1"># this function should most likely be removed</span>
<div class="viewcode-block" id="checkOS"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.checkOS">[docs]</a><span class="k">def</span> <span class="nf">checkOS</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;define OS dependent paths to files&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">path_default_root</span><span class="p">,</span> <span class="n">dir_workspace</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;linux&#39;</span><span class="p">):</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="s2">&quot;linux&quot;</span>
        <span class="c1"># identify between different versions of linux</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s1">&#39;hostid&#39;</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="n">hostid</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">hostid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;007f&quot;</span><span class="p">:</span>
            <span class="n">path_default_root</span> <span class="o">=</span> <span class="s2">&quot;/home/neil/Desktop/pimc/&quot;</span>
            <span class="c1"># dir_workspace = &quot;~&quot;</span>
        <span class="k">elif</span> <span class="n">hostid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;360a&quot;</span><span class="p">:</span>
            <span class="n">path_default_root</span> <span class="o">=</span> <span class="s2">&quot;/work/ngraymon/pimc/&quot;</span>
            <span class="c1"># dir_workspace = &quot;~&quot;&quot;</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;darwin&#39;</span><span class="p">):</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="s2">&quot;darwin&quot;</span>
        <span class="c1"># path_default_root = &quot;~&quot;</span>
        <span class="c1"># dir_workspace = &quot;~&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;not linux or OSX, problem with filestructure&quot;</span><span class="p">)</span>
    <span class="k">return</span></div>


<span class="c1"># Print Precision!</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># by default the following name is used for the json file</span>
<span class="c1"># json_filename = &quot;coupled_model.json&quot;</span>


<span class="c1"># Number of minima [energy wells]</span>
<span class="n">nel</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1"># Number of normal modes</span>
<span class="n">nmode</span> <span class="o">=</span> <span class="mi">12</span>  <span class="c1"># default value</span>

<span class="n">mode_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmode</span><span class="p">)</span>
<span class="n">el_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nel</span><span class="p">)</span>


<span class="n">dir_vib</span> <span class="o">=</span> <span class="s2">&quot;data_set_</span><span class="si">{:d}</span><span class="s2">/&quot;</span>
<span class="n">dir_rho</span> <span class="o">=</span> <span class="s2">&quot;rho_</span><span class="si">{:d}</span><span class="s2">/&quot;</span>

<span class="c1"># the names of the sub directories</span>
<span class="n">list_sub_dirs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;parameters/&quot;</span><span class="p">,</span>
    <span class="s2">&quot;results/&quot;</span><span class="p">,</span>
    <span class="s2">&quot;execution_output/&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plots/&quot;</span><span class="p">,</span>
    <span class="p">]</span>


<span class="c1"># current template for all possible parameters</span>
<span class="n">template_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;number of modes&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="s2">&quot;number of surfaces&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="s2">&quot;energies&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="s2">&quot;frequencies&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="s2">&quot;linear couplings&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="s2">&quot;quadratic couplings&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="s2">&quot;cubic couplings&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="s2">&quot;quartic couplings&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="p">}</span>


<div class="viewcode-block" id="verify_model_parameters"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.verify_model_parameters">[docs]</a><span class="k">def</span> <span class="nf">verify_model_parameters</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;make sure the provided model parameters follow the file conventions&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;number of modes&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;need the number of modes&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;number of surfaces&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;need the number of surfaces&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;energies&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;energies are required&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;frequencies&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;frequencies are required&quot;</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;number of modes&quot;</span><span class="p">])</span>
    <span class="n">A</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;number of surfaces&quot;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;energies&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span> <span class="s2">&quot;energies have incorrect shape&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;frequencies&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="p">),</span> <span class="s2">&quot;frequencies have incorrect shape&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;linear couplings&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span> <span class="s2">&quot;linear couplings have incorrect shape&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;quadratic couplings&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span> <span class="s2">&quot;quadratic couplings have incorrect shape&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;cubic couplings&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span> <span class="s2">&quot;cubic couplings have incorrect shape&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;quartic couplings&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span> <span class="s2">&quot;quartic couplings have incorrect shape&quot;</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="verify_sample_parameters"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.verify_sample_parameters">[docs]</a><span class="k">def</span> <span class="nf">verify_sample_parameters</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;make sure the provided sample parameters follow the file conventions&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;number of modes&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;need the number of modes&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;number of surfaces&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;need the number of surfaces&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;energies&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;energies are required&quot;</span>
    <span class="k">assert</span> <span class="s2">&quot;frequencies&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;frequencies are required&quot;</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;number of modes&quot;</span><span class="p">])</span>
    <span class="n">A</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;number of surfaces&quot;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;energies&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="p">),</span> <span class="s2">&quot;energies have incorrect shape&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;frequencies&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="p">),</span> <span class="s2">&quot;frequencies have incorrect shape&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;linear couplings&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span> <span class="s2">&quot;linear couplings have incorrect shape&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;quadratic couplings&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span> <span class="s2">&quot;quadratic couplings have incorrect shape&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;cubic couplings&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span> <span class="s2">&quot;cubic couplings have incorrect shape&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;quartic couplings&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span> <span class="s2">&quot;quartic couplings have incorrect shape&quot;</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="pretty_print_model"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.pretty_print_model">[docs]</a><span class="k">def</span> <span class="nf">pretty_print_model</span><span class="p">(</span><span class="n">id_data</span><span class="p">,</span> <span class="n">unitsOfeV</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;one method of printing the models in a human readable format&quot;&quot;&quot;</span>
    <span class="c1"># checkOS()</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="kn">from</span> <span class="nn">xarray</span> <span class="k">import</span> <span class="n">DataArray</span> <span class="k">as</span> <span class="n">dArr</span>

    <span class="c1"># parameter values</span>
    <span class="n">N</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="n">get_nmode_nsurf_from_coupled_model</span><span class="p">(</span><span class="n">id_data</span><span class="p">)</span>
    <span class="n">numStates</span> <span class="o">=</span> <span class="n">A</span>
    <span class="n">numModes</span> <span class="o">=</span> <span class="n">N</span>
    <span class="n">States</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">numStates</span><span class="p">)</span>
    <span class="n">Modes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">numModes</span><span class="p">)</span>

    <span class="c1"># formatting</span>
    <span class="n">a_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">A</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">b_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">A</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">i_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;i</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">j_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;j</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>

    <span class="c1"># load the data</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">path_default_root</span> <span class="o">+</span> <span class="n">dir_vib</span> <span class="o">+</span> <span class="s2">&quot;parameters/&quot;</span> <span class="o">+</span> <span class="s2">&quot;coupled_model.json&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_data</span><span class="p">)</span>
    <span class="n">target_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF8&#39;</span><span class="p">)</span>
    <span class="n">input_dictionary</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">target_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="c1"># isolate the lists</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;energies&quot;</span><span class="p">]</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">]</span>
    <span class="n">linear</span> <span class="o">=</span> <span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;linear couplings&quot;</span><span class="p">]</span>
    <span class="n">quadratic</span> <span class="o">=</span> <span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;quadratic couplings&quot;</span><span class="p">]</span>

    <span class="c1"># by default convert the output to wavenumbers</span>
    <span class="n">conversionFactor</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">unitsOfeV</span> <span class="k">else</span> <span class="n">constants</span><span class="o">.</span><span class="n">wavenumber_per_eV</span>

    <span class="c1"># stringify the lists</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Modes</span><span class="p">:</span>
        <span class="n">omega</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">conversionFactor</span>
        <span class="n">omega</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">States</span><span class="p">,</span> <span class="n">States</span><span class="p">):</span>
        <span class="n">energy</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span> <span class="o">*=</span> <span class="n">conversionFactor</span>
        <span class="n">energy</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">energy</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">States</span><span class="p">,</span> <span class="n">States</span><span class="p">,</span> <span class="n">Modes</span><span class="p">):</span>
        <span class="n">linear</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span> <span class="o">*=</span> <span class="n">conversionFactor</span>
        <span class="n">linear</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">linear</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">States</span><span class="p">,</span> <span class="n">States</span><span class="p">,</span> <span class="n">Modes</span><span class="p">,</span> <span class="n">Modes</span><span class="p">):</span>
        <span class="n">quadratic</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span> <span class="o">*=</span> <span class="n">conversionFactor</span>
        <span class="n">quadratic</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">quadratic</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">])</span>

    <span class="c1"># load the data into xarray&#39;s DataArrays</span>
    <span class="n">omegaArray</span> <span class="o">=</span> <span class="n">dArr</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span>
                      <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="n">i_labels</span><span class="p">],</span>
                      <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mode i&#39;</span><span class="p">],</span>
                      <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Frequencies&quot;</span>
                      <span class="p">)</span>

    <span class="n">energyArray</span> <span class="o">=</span> <span class="n">dArr</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span>
                       <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="n">a_labels</span><span class="p">,</span> <span class="n">b_labels</span><span class="p">],</span>
                       <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;surface a&#39;</span><span class="p">,</span> <span class="s1">&#39;surface b&#39;</span><span class="p">],</span>
                       <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Energies&quot;</span>
                       <span class="p">)</span>

    <span class="n">linArray</span> <span class="o">=</span> <span class="n">dArr</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span>
                    <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="n">i_labels</span><span class="p">,</span> <span class="n">a_labels</span><span class="p">,</span> <span class="n">b_labels</span><span class="p">],</span>
                    <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mode i&#39;</span><span class="p">,</span> <span class="s1">&#39;surface a&#39;</span><span class="p">,</span> <span class="s1">&#39;surface b&#39;</span><span class="p">],</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;linear terms&quot;</span>
                    <span class="p">)</span>

    <span class="n">quadArray</span> <span class="o">=</span> <span class="n">dArr</span><span class="p">(</span><span class="n">quadratic</span><span class="p">,</span>
                     <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="n">i_labels</span><span class="p">,</span> <span class="n">j_labels</span><span class="p">,</span> <span class="n">a_labels</span><span class="p">,</span> <span class="n">b_labels</span><span class="p">],</span>
                     <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mode i&#39;</span><span class="p">,</span> <span class="s1">&#39;mode j &#39;</span><span class="p">,</span> <span class="s1">&#39;surface a&#39;</span><span class="p">,</span> <span class="s1">&#39;surface b&#39;</span><span class="p">],</span>
                     <span class="n">name</span><span class="o">=</span><span class="s2">&quot;quadratic terms&quot;</span>
                     <span class="p">)</span>

    <span class="c1"># print the data, relying on panda&#39;s DataArrays</span>
    <span class="c1"># to printin a human legible manner</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">omegaArray</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(),</span>
          <span class="n">energyArray</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(),</span>
          <span class="n">linArray</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(),</span>
          <span class="n">quadArray</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(),</span>
          <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span></div>


<span class="c1"># this function should probably be removed - no longer needed</span>
<div class="viewcode-block" id="parse_model_params"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.parse_model_params">[docs]</a><span class="k">def</span> <span class="nf">parse_model_params</span><span class="p">(</span><span class="n">path_full</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;this one could probably be removed? parses model_parameters_source.txt&quot;&quot;&quot;</span>
    <span class="c1"># does the file exist?</span>
    <span class="n">helper</span><span class="o">.</span><span class="n">verify_file_exists</span><span class="p">(</span><span class="n">path_full</span><span class="p">)</span>

    <span class="n">parameter_dictionary</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;number_of_surfaces&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;number_of_modes&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;energy_range&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;frequency_range&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;quadratic_scaling&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;linear_scaling&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;temperature_list&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;sample_list&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;bead_list&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_full</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">source_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">source_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">source_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span><span class="p">(</span>    <span class="n">header</span> <span class="o">==</span> <span class="s2">&quot;quadratic_scaling&quot;</span>
                <span class="ow">or</span> <span class="n">header</span> <span class="o">==</span> <span class="s2">&quot;linear_scaling&quot;</span>
                <span class="p">):</span>
                <span class="n">parameter_dictionary</span><span class="p">[</span><span class="n">header</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">elif</span><span class="p">(</span>  <span class="n">header</span> <span class="o">==</span> <span class="s2">&quot;number_of_surfaces&quot;</span>
                <span class="ow">or</span> <span class="n">header</span> <span class="o">==</span> <span class="s2">&quot;number_of_modes&quot;</span>
                <span class="p">):</span>
                <span class="n">parameter_dictionary</span><span class="p">[</span><span class="n">header</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">elif</span><span class="p">(</span>  <span class="n">header</span> <span class="o">==</span> <span class="s2">&quot;temperature_list&quot;</span>
                <span class="ow">or</span> <span class="n">header</span> <span class="o">==</span> <span class="s2">&quot;memory_list&quot;</span>
                <span class="ow">or</span> <span class="n">header</span> <span class="o">==</span> <span class="s2">&quot;sample_list&quot;</span>
                <span class="ow">or</span> <span class="n">header</span> <span class="o">==</span> <span class="s2">&quot;bead_list&quot;</span>
                <span class="p">):</span>
                <span class="n">parameter_dictionary</span><span class="p">[</span><span class="n">header</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="k">elif</span><span class="p">(</span>  <span class="n">header</span> <span class="o">==</span> <span class="s2">&quot;frequency_range&quot;</span>
                <span class="ow">or</span> <span class="n">header</span> <span class="o">==</span> <span class="s2">&quot;energy_range&quot;</span>
                <span class="p">):</span>
                <span class="n">parameter_dictionary</span><span class="p">[</span><span class="n">header</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;header </span><span class="si">{:}</span><span class="s2"> is not valid</span><span class="se">\n</span><span class="s2">&quot;</span>
                                 <span class="s2">&quot;Check that your model_parameters_source.txt&quot;</span>
                                 <span class="s2">&quot;has the correct formatting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                                 <span class="p">)</span>
    <span class="k">return</span> <span class="n">parameter_dictionary</span></div>


<div class="viewcode-block" id="generate_vibronic_model_data"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.generate_vibronic_model_data">[docs]</a><span class="k">def</span> <span class="nf">generate_vibronic_model_data</span><span class="p">(</span><span class="n">paramDict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;redo this one but otherwise its fine returns e,w,l,q filled with appropriate values&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">paramDict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># default values</span>
        <span class="n">paramDict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;frequency_range&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">],</span>
                    <span class="s1">&#39;energy_range&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>
                    <span class="s1">&#39;quadratic_scaling&#39;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span>
                    <span class="s1">&#39;linear_scaling&#39;</span><span class="p">:</span> <span class="mf">0.04</span><span class="p">,</span>
                    <span class="s1">&#39;nonadiabatic&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;numStates&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="s1">&#39;numModes&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="p">}</span>

    <span class="c1"># withdraw input values</span>
    <span class="n">nonadiabatic</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;nonadiabatic&#39;</span><span class="p">]</span>
    <span class="n">numStates</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;numStates&#39;</span><span class="p">]</span>
    <span class="n">numModes</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;numModes&#39;</span><span class="p">]</span>

    <span class="c1"># ranges</span>
    <span class="n">States</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">numStates</span><span class="p">)</span>
    <span class="n">Modes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">numModes</span><span class="p">)</span>

    <span class="c1"># for readability and clarity we use these letters</span>
    <span class="n">size</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">numModes</span><span class="p">),</span>
            <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">numStates</span><span class="p">),</span>
            <span class="s1">&#39;AA&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">numStates</span><span class="p">,</span> <span class="n">numStates</span><span class="p">),</span>
            <span class="s1">&#39;NAA&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">numModes</span><span class="p">,</span> <span class="n">numStates</span><span class="p">,</span> <span class="n">numStates</span><span class="p">),</span>
            <span class="s1">&#39;NNAA&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">numModes</span><span class="p">,</span> <span class="n">numModes</span><span class="p">,</span> <span class="n">numStates</span><span class="p">,</span> <span class="n">numStates</span><span class="p">),</span>
            <span class="p">}</span>

    <span class="c1"># data</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">])</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="s1">&#39;AA&#39;</span><span class="p">])</span>
    <span class="n">linear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="s1">&#39;NAA&#39;</span><span class="p">])</span>
    <span class="n">quadratic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="s1">&#39;NNAA&#39;</span><span class="p">])</span>

    <span class="c1"># readability</span>
    <span class="n">minFreq</span><span class="p">,</span> <span class="n">maxFreq</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;frequency_range&#39;</span><span class="p">]</span>
    <span class="n">minE</span><span class="p">,</span> <span class="n">maxE</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;energy_range&#39;</span><span class="p">]</span>

    <span class="c1"># generate omega</span>
    <span class="n">omega</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minFreq</span><span class="p">,</span> <span class="n">maxFreq</span><span class="p">,</span>
                           <span class="n">num</span><span class="o">=</span><span class="n">numModes</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>

    <span class="c1"># generate energy</span>
    <span class="n">energy</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">minE</span><span class="p">,</span> <span class="n">maxE</span><span class="p">,</span> <span class="n">size</span><span class="p">[</span><span class="s1">&#39;AA&#39;</span><span class="p">])</span>
    <span class="c1"># force the energy to be symmetric</span>
    <span class="n">energy</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># calculate the linear displacement</span>
    <span class="n">l_shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">omega</span> <span class="o">/</span> <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;linear_scaling&#39;</span><span class="p">])</span>

    <span class="c1"># generate linear terms</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Modes</span><span class="p">:</span>
        <span class="n">upTri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">l_shift</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">l_shift</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="s1">&#39;AA&#39;</span><span class="p">])</span>
        <span class="c1"># force the linear terms to be symmetric</span>
        <span class="n">linear</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">upTri</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">upTri</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># calculate the quadratic displacement</span>
    <span class="n">q_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">omega</span><span class="p">))</span> <span class="o">/</span> <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;quadratic_scaling&#39;</span><span class="p">]</span>

    <span class="c1"># generate quadratic terms</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Modes</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">numModes</span><span class="p">):</span>
            <span class="n">upTri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">q_shift</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">q_shift</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="s1">&#39;AA&#39;</span><span class="p">])</span>
            <span class="c1"># force the quadratic terms to be symmetric</span>
            <span class="n">quadratic</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">upTri</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">upTri</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">quadratic</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">upTri</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">upTri</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># if we are building a harmonic model</span>
    <span class="c1"># then zero out all off-diagonal entries</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nonadiabatic</span><span class="p">:</span>
        <span class="c1"># energy</span>
        <span class="n">energy</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagflat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">energy</span><span class="p">))</span>
        <span class="c1"># linear terms</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Modes</span><span class="p">:</span>
            <span class="n">linear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">linear</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="c1"># quadratic terms</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">Modes</span><span class="p">,</span> <span class="n">Modes</span><span class="p">):</span>
            <span class="n">quadratic</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">quadratic</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="o">...</span><span class="p">]))</span>

    <span class="c1"># check for symmetry in surfaces</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">energy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">linear</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">quadratic</span><span class="p">,</span> <span class="n">quadratic</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
    <span class="c1"># check for symmetry in modes</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">quadratic</span><span class="p">,</span> <span class="n">quadratic</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">energy</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">linear</span><span class="p">,</span> <span class="n">quadratic</span>
    <span class="c1"># and we are done</span>
    <span class="n">return_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;number of modes&quot;</span><span class="p">:</span> <span class="n">numModes</span><span class="p">,</span>
                   <span class="s2">&quot;number of surfaces&quot;</span><span class="p">:</span> <span class="n">numStates</span><span class="p">,</span>
                   <span class="s2">&quot;energies&quot;</span><span class="p">:</span> <span class="n">energy</span><span class="p">,</span>
                   <span class="s2">&quot;frequencies&quot;</span><span class="p">:</span> <span class="n">omega</span><span class="p">,</span>
                   <span class="s2">&quot;linear couplings&quot;</span><span class="p">:</span> <span class="n">linear</span><span class="p">,</span>
                   <span class="s2">&quot;quadratic couplings&quot;</span><span class="p">:</span> <span class="n">quadratic</span><span class="p">,</span>
                   <span class="p">}</span>
    <span class="k">return</span> <span class="n">return_dict</span></div>


<div class="viewcode-block" id="read_model_h_file"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.read_model_h_file">[docs]</a><span class="k">def</span> <span class="nf">read_model_h_file</span><span class="p">(</span><span class="n">path_file_h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; reads/parses molecule_vibron.h file&quot;&quot;&quot;</span>
    <span class="n">path_file_params</span> <span class="o">=</span> <span class="n">path_file_h</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.in&quot;</span>

    <span class="c1"># declare the arrays used to store the model&#39;s paramters</span>
    <span class="c1"># all numbers have units of electron volts</span>
    <span class="n">excitation_energies</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">frequencies</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">linear_couplings</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">quadratic_couplings</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># the frequencies with units of wavenumbers</span>
    <span class="n">wavenumber_freq</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">helper</span><span class="o">.</span><span class="n">verify_file_exists</span><span class="p">(</span><span class="n">path_file_h</span><span class="p">)</span>
    <span class="n">helper</span><span class="o">.</span><span class="n">verify_file_exists</span><span class="p">(</span><span class="n">path_file_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_number_of_electronic_states</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
        <span class="c1"># skip first line</span>
        <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="c1"># read in line with electronic states</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="c1"># verify that we have the correct line</span>
        <span class="n">targetString</span> <span class="o">=</span> <span class="s1">&#39;Number of electronic states&#39;</span>
        <span class="k">if</span> <span class="n">targetString</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">number_of_electronic_states</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># States = range(number_of_electronic_states)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Electronic states: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number_of_electronic_states</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Input file </span><span class="si">{:s}</span><span class="s2"> does not contain </span><span class="si">{:s}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_file_h</span><span class="p">,</span> <span class="n">targetString</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">number_of_electronic_states</span>

    <span class="k">def</span> <span class="nf">get_number_of_normal_modes</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
        <span class="c1"># read in line with symmetric normal modes</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="c1"># verify that we have the correct line</span>
        <span class="n">targetString</span> <span class="o">=</span> <span class="s1">&#39;Number of symmetric normal modes&#39;</span>
        <span class="k">if</span> <span class="n">targetString</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">number_of_symmetric_modes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">number_of_normal_modes</span> <span class="o">=</span> <span class="n">number_of_symmetric_modes</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Symmetric normal modes: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number_of_symmetric_modes</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Total normal modes: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number_of_normal_modes</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Input file </span><span class="si">{:s}</span><span class="s2"> does not contain </span><span class="si">{:s}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_file_h</span><span class="p">,</span> <span class="n">targetString</span><span class="p">))</span>

        <span class="c1"># read in line with non-A1 normal modes</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="c1"># verify that we have the correct line</span>
        <span class="n">targetString</span> <span class="o">=</span> <span class="s1">&#39;Number of non-A1 normal modes&#39;</span>
        <span class="k">if</span> <span class="n">targetString</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">other_modes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">number_of_normal_modes</span> <span class="o">+=</span> <span class="n">other_modes</span>
            <span class="c1"># Modes = range(number_of_normal_modes)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;non-A1 normal modes: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">other_modes</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Total normal modes: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number_of_normal_modes</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Input file </span><span class="si">{:s}</span><span class="s2"> does not contain </span><span class="si">{:s}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_file_h</span><span class="p">,</span> <span class="n">targetString</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">number_of_normal_modes</span><span class="p">,</span> <span class="n">number_of_symmetric_modes</span>

    <span class="k">def</span> <span class="nf">extract_normal_mode_frequencies</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">frequency_array</span><span class="p">,</span> <span class="n">symmetric_modes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;store output in frequency_array&quot;&quot;&quot;</span>
        <span class="c1"># skip headers</span>
        <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># read in symmetric normal modes</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">frequency_array</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">symmetric_modes</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">frequency_array</span><span class="p">)</span>

        <span class="c1"># skip header</span>
        <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># read in non-A1 normal modes</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">frequency_array</span><span class="p">[</span><span class="n">symmetric_modes</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">frequency_array</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># set the number of normal modes and electronic surfaces</span>
    <span class="c1"># store the normal mode frequencies</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_file_params</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
        <span class="c1"># we will overwrite these default values</span>
        <span class="k">global</span> <span class="n">numModes</span><span class="p">,</span> <span class="n">numStates</span>
        <span class="k">global</span> <span class="n">Modes</span><span class="p">,</span> <span class="n">States</span>

        <span class="n">numStates</span> <span class="o">=</span> <span class="n">get_number_of_electronic_states</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span>
        <span class="n">States</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">numStates</span><span class="p">)</span>
        <span class="n">numModes</span><span class="p">,</span> <span class="n">numSymmetricModes</span> <span class="o">=</span> <span class="n">get_number_of_normal_modes</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span>
        <span class="n">Modes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">numModes</span><span class="p">)</span>

        <span class="c1"># for readability and clarity we use these letters</span>
        <span class="k">global</span> <span class="n">size</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">numModes</span><span class="p">),</span>
                <span class="s1">&#39;AA&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">numStates</span><span class="p">,</span> <span class="n">numStates</span><span class="p">),</span>
                <span class="s1">&#39;NAA&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">numModes</span><span class="p">,</span> <span class="n">numStates</span><span class="p">,</span> <span class="n">numStates</span><span class="p">),</span>
                <span class="s1">&#39;NNAA&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">numModes</span><span class="p">,</span> <span class="n">numModes</span><span class="p">,</span> <span class="n">numStates</span><span class="p">,</span> <span class="n">numStates</span><span class="p">),</span>
                <span class="p">}</span>

        <span class="c1"># Initialize Variables</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">])</span>
        <span class="n">excitation_energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="s1">&#39;AA&#39;</span><span class="p">])</span>
        <span class="n">linear_couplings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="s1">&#39;NAA&#39;</span><span class="p">])</span>
        <span class="n">quadratic_couplings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="s1">&#39;NNAA&#39;</span><span class="p">])</span>

        <span class="n">extract_normal_mode_frequencies</span><span class="p">(</span><span class="n">source_file</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="n">numSymmetricModes</span><span class="p">)</span>

        <span class="c1"># convert to wavenumers up to 2 decimal places</span>
        <span class="n">wavenumber_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">frequencies</span> <span class="o">*</span> <span class="mf">8065.5</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">wavenumber_freq</span><span class="p">)</span>
        <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">extract_energies</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">memmap</span><span class="p">,</span> <span class="n">energies</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
        <span class="c1"># find the begining and ending of the important region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># start looking from the begining of the file</span>
        <span class="n">beginString</span> <span class="o">=</span> <span class="s1">&#39;Reference Hamiltonian&#39;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">)</span>
        <span class="n">endString</span> <span class="o">=</span> <span class="s1">&#39;Gradients of heff along normal modes&#39;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">endString</span><span class="p">)</span>

        <span class="c1"># go to the begining of that region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

        <span class="c1"># skip the header</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># read all the relevant data</span>
        <span class="n">byteData</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">memmap</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="n">stringData</span> <span class="o">=</span> <span class="n">byteData</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">stringData</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

        <span class="c1"># save the reference hamiltonian into the energies array</span>
        <span class="k">for</span> <span class="n">d1</span> <span class="ow">in</span> <span class="n">States</span><span class="p">:</span>
            <span class="n">energies</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="c1"># print(energies)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">extract_linear_couplings</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">memmap</span><span class="p">,</span> <span class="n">coupling_terms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;frequencies need to be provided in wavenumbers&quot;&quot;&quot;</span>
        <span class="c1"># find the begining and ending of the important region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># start looking from the begining of the file</span>
        <span class="n">beginString</span> <span class="o">=</span> <span class="s1">&#39;Gradients of heff along normal modes&#39;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">)</span>
        <span class="n">endString</span> <span class="o">=</span> <span class="s1">&#39;Diagonal second order corrections of heff&#39;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">endString</span><span class="p">)</span>

        <span class="c1"># go to the begining of that region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frequencies</span><span class="p">):</span>
            <span class="c1"># find the next block of linear coupling_terms terms</span>
            <span class="n">next_block</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="c1"># error handling</span>
            <span class="k">if</span> <span class="n">next_block</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Frequency </span><span class="si">{:f}</span><span class="s2"> in wavenumber_freq did not match any &quot;</span>
                     <span class="s2">&quot;frequencies in file </span><span class="si">{:s}</span><span class="s2"> while parsing the &quot;</span>
                     <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2"> region.&quot;</span>
                     <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">))</span>
            <span class="c1"># go there</span>
            <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">next_block</span><span class="p">)</span>
            <span class="c1"># skip header</span>
            <span class="n">memmap</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="c1"># store each line in the array</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">States</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="n">coupling_terms</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="c1"># print(coupling_terms[idx])</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">extract_quadratic_couplings</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">memmap</span><span class="p">,</span> <span class="n">coupling_terms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;frequencies need to be provided in wavenumbers&quot;&quot;&quot;</span>
        <span class="c1"># find the begining and ending of the important region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># start looking from the begining of the file</span>
        <span class="n">beginString</span> <span class="o">=</span> <span class="s1">&#39;Diagonal second order corrections of heff&#39;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">)</span>
        <span class="n">endString</span> <span class="o">=</span> <span class="s1">&#39;Off-diagonal second order corrections heff&#39;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">endString</span><span class="p">)</span>

        <span class="c1"># go to the begining of that region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frequencies</span><span class="p">):</span>
            <span class="c1"># find the next block of quadratic coupling terms</span>
            <span class="n">next_block</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="c1"># error handling</span>
            <span class="k">if</span> <span class="n">next_block</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Frequency </span><span class="si">{:f}</span><span class="s2"> in wavenumber_freq did not match any &quot;</span>
                     <span class="s2">&quot;frequencies in file </span><span class="si">{:s}</span><span class="s2"> while parsing the &quot;</span>
                     <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2"> region.&quot;</span>
                     <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">))</span>
            <span class="c1"># go there</span>
            <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">next_block</span><span class="p">)</span>
            <span class="c1"># skip header</span>
            <span class="n">memmap</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="c1"># store each line in the array</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">States</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="n">coupling_terms</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="c1"># print(coupling_terms[idx, idx])</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">extract_offdiag_quadratic_couplings</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">memmap</span><span class="p">,</span> <span class="n">coupling_terms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;frequencies need to be provided in wavenumbers&quot;&quot;&quot;</span>
        <span class="c1"># find the begining and ending of the important region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># start looking from the begining of the file</span>
        <span class="n">beginString</span> <span class="o">=</span> <span class="s1">&#39;Off-diagonal second order corrections heff&#39;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">)</span>
        <span class="n">endString</span> <span class="o">=</span> <span class="s1">&#39;Diagonal Cubic corrections of heff&#39;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">endString</span><span class="p">)</span>

        <span class="c1"># go to the begining of that region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx1</span><span class="p">,</span> <span class="n">w1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frequencies</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">idx2</span><span class="p">,</span> <span class="n">w2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frequencies</span><span class="p">[:</span><span class="n">idx1</span><span class="p">]):</span>
                <span class="c1"># find the next block of quadratic coupling terms</span>
                <span class="n">next_block</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">w1</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> <span class="n">memmap</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">end</span><span class="p">)</span>
                <span class="c1"># error handling</span>
                <span class="k">if</span> <span class="n">next_block</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Frequency </span><span class="si">{:f}</span><span class="s2"> in wavenumber_freq did not &quot;</span>
                         <span class="s2">&quot;match any frequencies in file </span><span class="si">{:s}</span><span class="s2"> &quot;</span>
                         <span class="s2">&quot;while parsing the </span><span class="si">{:s}</span><span class="s2"> region.&quot;</span>
                         <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">))</span>

                <span class="c1"># find the next block of quadratic coupling terms</span>
                <span class="n">next_block</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">w2</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> <span class="n">memmap</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">end</span><span class="p">)</span>
                <span class="c1"># error handling</span>
                <span class="k">if</span> <span class="n">next_block</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Frequency </span><span class="si">{:f}</span><span class="s2"> in wavenumber_freq did not &quot;</span>
                         <span class="s2">&quot;match any frequencies in file </span><span class="si">{:s}</span><span class="s2"> &quot;</span>
                         <span class="s2">&quot;while parsing the </span><span class="si">{:s}</span><span class="s2"> region.&quot;</span>
                         <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">))</span>

                <span class="c1"># go there</span>
                <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">next_block</span><span class="p">)</span>
                <span class="c1"># skip header</span>
                <span class="n">memmap</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

                <span class="c1"># store each line in the array</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">States</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                    <span class="n">coupling_terms</span><span class="p">[</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="c1"># print(coupling_terms[idx1, idx2])</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">extract_cubic_couplings</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">memmap</span><span class="p">,</span> <span class="n">coupling_terms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;not implemented at this time&quot;&quot;&quot;</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">extract_quartic_couplings</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">memmap</span><span class="p">,</span> <span class="n">coupling_terms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;not implemented at this time&quot;&quot;&quot;</span>
        <span class="k">return</span>

    <span class="c1"># store the energy offsets, and all the coupling terms</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_file_h</span><span class="p">,</span> <span class="s2">&quot;r+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
        <span class="c1"># access the file using memory map for efficiency</span>
        <span class="k">with</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">source_file</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prot</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">PROT_READ</span><span class="p">)</span> <span class="k">as</span> <span class="n">mm</span><span class="p">:</span>
            <span class="n">extract_energies</span><span class="p">(</span><span class="n">path_file_h</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">excitation_energies</span><span class="p">)</span>
            <span class="n">extract_linear_couplings</span><span class="p">(</span><span class="n">path_file_h</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">wavenumber_freq</span><span class="p">,</span> <span class="n">linear_couplings</span><span class="p">)</span>
            <span class="c1"># extract_quadratic_couplings(path_file_h, mm, wavenumber_freq, quadratic_couplings)</span>
            <span class="c1"># extract_offdiag_quadratic_couplings(path_file_h, mm, wavenumber_freq, quadratic_couplings)</span>
            <span class="c1"># extract_cubic_couplings(path_file_h, mm, wavenumber_freq, cubic_couplings)</span>
            <span class="c1"># extract_quartic_couplings(path_file_h, mm, wavenumber_freq, quartic_couplings)</span>
        <span class="c1">#</span>

    <span class="c1"># duplicate the lower triangle values into the upper triangle</span>
    <span class="c1"># the couplings are a symmetric matrix</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">States</span><span class="p">,</span> <span class="n">States</span><span class="p">):</span>
        <span class="n">quadratic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">quadratic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># check for symmetry in surfaces</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">excitation_energies</span><span class="p">,</span> <span class="n">excitation_energies</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">linear_couplings</span><span class="p">,</span> <span class="n">linear_couplings</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">quadratic_couplings</span><span class="p">,</span> <span class="n">quadratic_couplings</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
    <span class="c1"># check for symmetry in modes</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">quadratic_couplings</span><span class="p">,</span> <span class="n">quadratic_couplings</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>

    <span class="c1"># and we are done</span>
    <span class="n">return_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;number of modes&quot;</span><span class="p">:</span> <span class="n">numModes</span><span class="p">,</span>
                   <span class="s2">&quot;number of surfaces&quot;</span><span class="p">:</span> <span class="n">numStates</span><span class="p">,</span>
                   <span class="s2">&quot;energies&quot;</span><span class="p">:</span> <span class="n">excitation_energies</span><span class="p">,</span>
                   <span class="s2">&quot;frequencies&quot;</span><span class="p">:</span> <span class="n">frequencies</span><span class="p">,</span>
                   <span class="s2">&quot;linear couplings&quot;</span><span class="p">:</span> <span class="n">linear_couplings</span><span class="p">,</span>
                   <span class="s2">&quot;quadratic couplings&quot;</span><span class="p">:</span> <span class="n">quadratic_couplings</span><span class="p">,</span>
                   <span class="p">}</span>
    <span class="k">return</span> <span class="n">return_dict</span></div>


<div class="viewcode-block" id="read_model_op_file"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.read_model_op_file">[docs]</a><span class="k">def</span> <span class="nf">read_model_op_file</span><span class="p">(</span><span class="n">path_file_op</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;reads/parses molecule_vibron.op file&quot;&quot;&quot;</span>

    <span class="c1"># declare the arrays used to store the model&#39;s paramters</span>
    <span class="c1"># all numbers have units of electron volts</span>
    <span class="n">excitation_energies</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">frequencies</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">linear_couplings</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">quadratic_couplings</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cubic_couplings</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">quartic_couplings</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">global</span> <span class="n">numStates</span><span class="p">,</span> <span class="n">numModes</span><span class="p">,</span> <span class="n">States</span><span class="p">,</span> <span class="n">Modes</span><span class="p">,</span> <span class="n">size</span>
    <span class="c1"># we will overwrite these default values</span>
    <span class="n">numStates</span> <span class="o">=</span> <span class="n">numModes</span> <span class="o">=</span> <span class="n">States</span> <span class="o">=</span> <span class="n">Modes</span> <span class="o">=</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">helper</span><span class="o">.</span><span class="n">verify_file_exists</span><span class="p">(</span><span class="n">path_file_op</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extract_energies</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">memmap</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
        <span class="c1"># find the begining and ending of the important region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># start looking from the begining of the file</span>
        <span class="n">beginString</span> <span class="o">=</span> <span class="s1">&#39;Electronic Hamitonian&#39;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">)</span>
        <span class="n">endString</span> <span class="o">=</span> <span class="s1">&#39;Electronic transition moments&#39;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">endString</span><span class="p">)</span>

        <span class="c1"># go to the begining of that region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

        <span class="c1"># skip the header</span>
        <span class="n">helper</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># read all the relevant data</span>
        <span class="n">byteData</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">memmap</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="n">stringData</span> <span class="o">=</span> <span class="n">byteData</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stringData</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="c1"># set the parameters</span>
        <span class="k">global</span> <span class="n">numStates</span><span class="p">,</span> <span class="n">States</span>
        <span class="n">numStates</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">States</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">numStates</span><span class="p">)</span>

        <span class="c1"># save the reference hamiltonian into the energies array</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">numStates</span><span class="p">,</span> <span class="n">numStates</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">States</span><span class="p">:</span>
            <span class="n">list_of_words</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">list_of_words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="s2">&quot;EH_s{a+1:02}_s{a+1:02}&quot;</span>  <span class="c1"># this is a formatted string literal (new in python3.6)</span>
            <span class="k">assert</span> <span class="n">list_of_words</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ev&quot;</span>
            <span class="n">energies</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_of_words</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">energies</span>

    <span class="k">def</span> <span class="nf">extract_normal_mode_frequencies</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">memmap</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;store output in frequency_array&quot;&quot;&quot;</span>
        <span class="c1"># find the begining and ending of the important region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># start looking from the begining of the file</span>
        <span class="n">beginString</span> <span class="o">=</span> <span class="s1">&#39;Frequencies&#39;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">)</span>
        <span class="n">endString</span> <span class="o">=</span> <span class="s1">&#39;Zeropoint energy&#39;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">endString</span><span class="p">)</span>

        <span class="c1"># go to the begining of that region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

        <span class="c1"># skip headers</span>
        <span class="n">helper</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># read all the relevant data</span>
        <span class="n">byteData</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">memmap</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="n">stringData</span> <span class="o">=</span> <span class="n">byteData</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stringData</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="c1"># set the parameters</span>
        <span class="k">global</span> <span class="n">numModes</span><span class="p">,</span> <span class="n">Modes</span>
        <span class="n">numModes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">Modes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">numModes</span><span class="p">)</span>

        <span class="c1"># extract the numbers and save them in the frequencies array</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numModes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">Modes</span><span class="p">:</span>
            <span class="n">list_of_words</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">list_of_words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="s2">&quot;w{j+1:02}&quot;</span>  <span class="c1"># this is a formatted string literal (new in python3.6)</span>
            <span class="k">assert</span> <span class="n">list_of_words</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ev&quot;</span>
            <span class="n">frequencies</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_of_words</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">frequencies</span>

    <span class="k">def</span> <span class="nf">extract_linear_couplings</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">memmap</span><span class="p">,</span> <span class="n">coupling_terms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
        <span class="c1"># find the begining and ending of the important region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># start looking from the begining of the file</span>
        <span class="n">beginString</span> <span class="o">=</span> <span class="s1">&#39;Linear Coupling Constants&#39;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">)</span>
        <span class="n">endString</span> <span class="o">=</span> <span class="s1">&#39;Diagonal Quadratic Coupling Constants&#39;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">endString</span><span class="p">)</span>

        <span class="c1"># go to the begining of that region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

        <span class="c1"># skip headers</span>
        <span class="n">helper</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># read all the relevant data</span>
        <span class="n">byteData</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">memmap</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="n">stringData</span> <span class="o">=</span> <span class="n">byteData</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">stringData</span> <span class="o">=</span> <span class="n">stringData</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;, ev&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stringData</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;C1_s</span><span class="si">{a1:d}</span><span class="s2">_s</span><span class="si">{a2:d}</span><span class="s2">_v</span><span class="si">{j:d}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">index_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;a1&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;a2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">coupling_terms</span><span class="p">[</span><span class="n">index_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># done</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">extract_quadratic_couplings</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">memmap</span><span class="p">,</span> <span class="n">coupling_terms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
        <span class="c1"># find the begining and ending of the important region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># start looking from the begining of the file</span>
        <span class="n">beginString</span> <span class="o">=</span> <span class="s1">&#39;Diagonal Quadratic Coupling Constants&#39;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">)</span>
        <span class="n">endString</span> <span class="o">=</span> <span class="s1">&#39;Cubic Coupling Constants&#39;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">endString</span><span class="p">)</span>

        <span class="c1"># go to the begining of that region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

        <span class="c1"># skip headers</span>
        <span class="n">helper</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># read all the relevant data</span>
        <span class="n">byteData</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">memmap</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="n">stringData</span> <span class="o">=</span> <span class="n">byteData</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">stringData</span> <span class="o">=</span> <span class="n">stringData</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;, ev&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stringData</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;C2_s</span><span class="si">{a1:d}</span><span class="s2">s</span><span class="si">{a2:d}</span><span class="s2">_v</span><span class="si">{j1:d}</span><span class="s2">v</span><span class="si">{j2:d}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">index_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;j1&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;j2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;a1&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;a2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">coupling_terms</span><span class="p">[</span><span class="n">index_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># done</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">extract_cubic_couplings</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">memmap</span><span class="p">,</span> <span class="n">coupling_terms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
        <span class="c1"># find the begining and ending of the important region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># start looking from the begining of the file</span>
        <span class="n">beginString</span> <span class="o">=</span> <span class="s1">&#39;Cubic Coupling Constants&#39;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">)</span>
        <span class="n">endString</span> <span class="o">=</span> <span class="s1">&#39;Quartic Coupling Constants&#39;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">endString</span><span class="p">)</span>

        <span class="c1"># go to the begining of that region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

        <span class="c1"># skip headers</span>
        <span class="n">helper</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># read all the relevant data</span>
        <span class="n">byteData</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">memmap</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="n">stringData</span> <span class="o">=</span> <span class="n">byteData</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">stringData</span> <span class="o">=</span> <span class="n">stringData</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;, ev&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stringData</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;C3_s</span><span class="si">{a1:d}</span><span class="s2">_s</span><span class="si">{a2:d}</span><span class="s2">_v</span><span class="si">{j:d}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">index_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;a1&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;a2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">coupling_terms</span><span class="p">[</span><span class="n">index_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># done</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">extract_bicubic_couplings</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">memmap</span><span class="p">,</span> <span class="n">coupling_terms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
        <span class="c1"># find the begining and ending of the important region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># start looking from the begining of the file</span>
        <span class="n">beginString</span> <span class="o">=</span> <span class="s1">&#39;Bi-Cubic Constants&#39;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">)</span>
        <span class="n">endString</span> <span class="o">=</span> <span class="s1">&#39;Bi-Quartic Constants&#39;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">endString</span><span class="p">)</span>

        <span class="c1"># go to the begining of that region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

        <span class="c1"># skip headers</span>
        <span class="n">helper</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># read all the relevant data</span>
        <span class="n">byteData</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">memmap</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="n">stringData</span> <span class="o">=</span> <span class="n">byteData</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">stringData</span> <span class="o">=</span> <span class="n">stringData</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;, ev&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stringData</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;B3_s</span><span class="si">{a1:d}</span><span class="s2">s</span><span class="si">{a2:d}</span><span class="s2">_v</span><span class="si">{j1:d}</span><span class="s2">v</span><span class="si">{j2:d}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># need to confirm this?</span>
            <span class="n">index_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;j1&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;j2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;j2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;a1&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;a2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">coupling_terms</span><span class="p">[</span><span class="n">index_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># done</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">extract_quartic_couplings</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">memmap</span><span class="p">,</span> <span class="n">coupling_terms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
        <span class="c1"># find the begining and ending of the important region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># start looking from the begining of the file</span>
        <span class="n">beginString</span> <span class="o">=</span> <span class="s1">&#39;Quartic Coupling Constants&#39;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">)</span>
        <span class="n">endString</span> <span class="o">=</span> <span class="s1">&#39;Bi-Cubic Constants&#39;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">endString</span><span class="p">)</span>

        <span class="c1"># go to the begining of that region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

        <span class="c1"># skip headers</span>
        <span class="n">helper</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># read all the relevant data</span>
        <span class="n">byteData</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">memmap</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="n">stringData</span> <span class="o">=</span> <span class="n">byteData</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">stringData</span> <span class="o">=</span> <span class="n">stringData</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;, ev&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stringData</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;C4_s</span><span class="si">{a1:d}</span><span class="s2">_s</span><span class="si">{a2:d}</span><span class="s2">_v</span><span class="si">{j:d}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">index_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;a1&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;a2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">coupling_terms</span><span class="p">[</span><span class="n">index_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># done</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">extract_biquartic_couplings</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">memmap</span><span class="p">,</span> <span class="n">coupling_terms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
        <span class="c1"># find the begining and ending of the important region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># start looking from the begining of the file</span>
        <span class="n">beginString</span> <span class="o">=</span> <span class="s1">&#39;Bi-Quartic Constants&#39;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">beginString</span><span class="p">)</span>
        <span class="n">endString</span> <span class="o">=</span> <span class="s1">&#39;end-parameter-section&#39;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">endString</span><span class="p">)</span>

        <span class="c1"># go to the begining of that region</span>
        <span class="n">memmap</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

        <span class="c1"># skip headers</span>
        <span class="n">helper</span><span class="o">.</span><span class="n">readlines</span><span class="p">(</span><span class="n">memmap</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># read all the relevant data</span>
        <span class="n">byteData</span> <span class="o">=</span> <span class="n">memmap</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">memmap</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
        <span class="n">stringData</span> <span class="o">=</span> <span class="n">byteData</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">stringData</span> <span class="o">=</span> <span class="n">stringData</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;, ev&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stringData</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>

        <span class="n">list_B4</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;B4&quot;</span><span class="p">),</span> <span class="n">lines</span><span class="p">)</span>
        <span class="n">pB4</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;B4_s</span><span class="si">{a1:d}</span><span class="s2">s</span><span class="si">{a2:d}</span><span class="s2">_v</span><span class="si">{j1:d}</span><span class="s2">v</span><span class="si">{j2:d}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">list_A4</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;A4&quot;</span><span class="p">),</span> <span class="n">lines</span><span class="p">)</span>
        <span class="n">pA4</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;A4_s</span><span class="si">{a1:d}</span><span class="s2">s</span><span class="si">{a2:d}</span><span class="s2">_v</span><span class="si">{j1:d}</span><span class="s2">v</span><span class="si">{j2:d}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">list_B4</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">pB4</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">index_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;j1&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;j2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;j2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;j2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;a1&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;a2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">coupling_terms</span><span class="p">[</span><span class="n">index_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">list_A4</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">pA4</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">index_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;j1&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;j1&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;j2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;j2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;a1&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;a2&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">coupling_terms</span><span class="p">[</span><span class="n">index_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># done</span>
        <span class="k">return</span>

    <span class="c1"># store the energy offsets, and all the coupling terms</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_file_op</span><span class="p">,</span> <span class="s2">&quot;r+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>

        <span class="c1"># access the file using memory map for efficiency</span>
        <span class="k">with</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">source_file</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prot</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">PROT_READ</span><span class="p">)</span> <span class="k">as</span> <span class="n">mm</span><span class="p">:</span>

            <span class="n">frequencies</span> <span class="o">=</span> <span class="n">extract_normal_mode_frequencies</span><span class="p">(</span><span class="n">path_file_op</span><span class="p">,</span> <span class="n">mm</span><span class="p">)</span>
            <span class="n">excitation_energies</span> <span class="o">=</span> <span class="n">extract_energies</span><span class="p">(</span><span class="n">path_file_op</span><span class="p">,</span> <span class="n">mm</span><span class="p">)</span>

            <span class="c1"># for readability and clarity we use these letters</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">numStates</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">numModes</span>
            <span class="n">size</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">N</span><span class="p">),</span>
                    <span class="s1">&#39;AA&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span>
                    <span class="s1">&#39;NAA&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span>
                    <span class="s1">&#39;NNAA&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span>
                    <span class="s1">&#39;NNNAA&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span>
                    <span class="s1">&#39;NNNNAA&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span>
                    <span class="p">}</span>
            <span class="c1"># size = {</span>
            <span class="c1">#         &#39;N&#39;: (numModes),</span>
            <span class="c1">#         &#39;AA&#39;: (numStates, numStates),</span>
            <span class="c1">#         &#39;NAA&#39;: (numModes, numStates, numStates),</span>
            <span class="c1">#         &#39;NNAA&#39;: (numModes, numModes, numStates, numStates),</span>
            <span class="c1">#         &#39;NNNAA&#39;: (numModes, numModes, numModes, numStates, numStates),</span>
            <span class="c1">#         &#39;NNNNAA&#39;: (numModes, numModes, numModes, numModes, numStates, numStates),</span>
            <span class="c1">#         }</span>

            <span class="c1"># Assert/Initialize array sizes</span>
            <span class="k">assert</span> <span class="n">frequencies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">size</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">],</span> <span class="s2">&quot;Incorrect array dimensions&quot;</span>
            <span class="k">assert</span> <span class="n">excitation_energies</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">size</span><span class="p">[</span><span class="s1">&#39;AA&#39;</span><span class="p">],</span> <span class="s2">&quot;Incorrect array dimensions&quot;</span>

            <span class="c1"># predefine these arrays now that we know the values of N and A are</span>
            <span class="n">linear_couplings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="s1">&#39;NAA&#39;</span><span class="p">])</span>
            <span class="n">quadratic_couplings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="s1">&#39;NNAA&#39;</span><span class="p">])</span>
            <span class="n">cubic_couplings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="s1">&#39;NNNAA&#39;</span><span class="p">])</span>
            <span class="n">quartic_couplings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="s1">&#39;NNNNAA&#39;</span><span class="p">])</span>

            <span class="c1"># read in the rest of the parameters</span>
            <span class="n">extract_linear_couplings</span><span class="p">(</span><span class="n">path_file_op</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">linear_couplings</span><span class="p">)</span>
            <span class="n">extract_quadratic_couplings</span><span class="p">(</span><span class="n">path_file_op</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">quadratic_couplings</span><span class="p">)</span>
            <span class="n">extract_cubic_couplings</span><span class="p">(</span><span class="n">path_file_op</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">cubic_couplings</span><span class="p">)</span>
            <span class="n">extract_quartic_couplings</span><span class="p">(</span><span class="n">path_file_op</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">quartic_couplings</span><span class="p">)</span>
            <span class="n">extract_bicubic_couplings</span><span class="p">(</span><span class="n">path_file_op</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">cubic_couplings</span><span class="p">)</span>
            <span class="n">extract_biquartic_couplings</span><span class="p">(</span><span class="n">path_file_op</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">quartic_couplings</span><span class="p">)</span>

    <span class="c1"># duplicate the lower triangle values into the upper triangle</span>

    <span class="c1"># do we not account for the symmetry in surfaces? this might be incorrect</span>

    <span class="n">linear_couplings</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">linear_couplings</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># the couplings are a symmetric matrix</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">States</span><span class="p">,</span> <span class="n">States</span><span class="p">):</span>
        <span class="n">quadratic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">quadratic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">quadratic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quadratic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>
        <span class="c1"># are these two correct?</span>
        <span class="n">cubic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">cubic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">cubic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cubic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>  <span class="c1"># this is probably incorrect</span>
        <span class="n">quartic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">quartic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">quartic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quartic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span>

    <span class="c1"># don&#39;t overcount the diagonals</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">States</span><span class="p">:</span>
        <span class="n">linear_couplings</span><span class="p">[:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">2.</span>
        <span class="n">quadratic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">2.</span>
        <span class="n">cubic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">2.</span>
        <span class="n">quartic_couplings</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">2.</span>

    <span class="c1"># check for symmetry in surfaces</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">excitation_energies</span><span class="p">,</span> <span class="n">excitation_energies</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">linear_couplings</span><span class="p">,</span> <span class="n">linear_couplings</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">quadratic_couplings</span><span class="p">,</span> <span class="n">quadratic_couplings</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">cubic_couplings</span><span class="p">,</span> <span class="n">cubic_couplings</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">quartic_couplings</span><span class="p">,</span> <span class="n">quartic_couplings</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="c1"># check for symmetry in modes</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">quadratic_couplings</span><span class="p">,</span> <span class="n">quadratic_couplings</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="c1"># either (q^3) or (q, q^2)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">cubic_couplings</span><span class="p">,</span> <span class="n">cubic_couplings</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="c1"># either (q, q^3) or (q^2, q^2)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">quartic_couplings</span><span class="p">,</span> <span class="n">quartic_couplings</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="c1"># and we are done</span>
    <span class="n">maximal_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;number of modes&quot;</span><span class="p">:</span> <span class="n">numModes</span><span class="p">,</span>
                    <span class="s2">&quot;number of surfaces&quot;</span><span class="p">:</span> <span class="n">numStates</span><span class="p">,</span>
                    <span class="s2">&quot;energies&quot;</span><span class="p">:</span> <span class="n">excitation_energies</span><span class="p">,</span>
                    <span class="s2">&quot;frequencies&quot;</span><span class="p">:</span> <span class="n">frequencies</span><span class="p">,</span>
                    <span class="s2">&quot;linear couplings&quot;</span><span class="p">:</span> <span class="n">linear_couplings</span><span class="p">,</span>
                    <span class="s2">&quot;quadratic couplings&quot;</span><span class="p">:</span> <span class="n">quadratic_couplings</span><span class="p">,</span>
                    <span class="s2">&quot;cubic couplings&quot;</span><span class="p">:</span> <span class="n">cubic_couplings</span><span class="p">,</span>
                    <span class="s2">&quot;quartic couplings&quot;</span><span class="p">:</span> <span class="n">quartic_couplings</span><span class="p">,</span>
                    <span class="p">}</span>

    <span class="c1"># if the arrays only have zeros then we might not need to store them?</span>
    <span class="n">return_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">maximal_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">return_dict</span></div>


<div class="viewcode-block" id="create_coupling_from_h_file"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.create_coupling_from_h_file">[docs]</a><span class="k">def</span> <span class="nf">create_coupling_from_h_file</span><span class="p">(</span><span class="n">FS</span><span class="p">,</span> <span class="n">path_file_h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;assumes that the path_file_h is in electronic_structure&quot;&quot;&quot;</span>
    <span class="c1"># A, N, E, w, l, q = read_model_h_file(path_file_h)</span>
    <span class="n">model_dict</span> <span class="o">=</span> <span class="n">read_model_h_file</span><span class="p">(</span><span class="n">path_file_h</span><span class="p">)</span>
    <span class="n">save_model_to_JSON</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">,</span> <span class="o">**</span><span class="n">model_dict</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created </span><span class="se">\n</span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">from</span><span class="se">\n</span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">,</span> <span class="n">path_file_h</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span></div>


<div class="viewcode-block" id="create_coupling_from_op_file"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.create_coupling_from_op_file">[docs]</a><span class="k">def</span> <span class="nf">create_coupling_from_op_file</span><span class="p">(</span><span class="n">FS</span><span class="p">,</span> <span class="n">path_file_op</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;assumes that the path_file_op is in electronic_structure&quot;&quot;&quot;</span>
    <span class="c1"># A, N, E, w, l, q = read_model_h_file(path_file_op)</span>
    <span class="n">model_dict</span> <span class="o">=</span> <span class="n">read_model_op_file</span><span class="p">(</span><span class="n">path_file_op</span><span class="p">)</span>
    <span class="n">save_model_to_JSON</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">,</span> <span class="o">**</span><span class="n">model_dict</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created </span><span class="se">\n</span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">from</span><span class="se">\n</span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">,</span> <span class="n">path_file_op</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span></div>


<span class="c1"># not working ATM</span>
<div class="viewcode-block" id="create_coupling_from_op_hyperlink"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.create_coupling_from_op_hyperlink">[docs]</a><span class="k">def</span> <span class="nf">create_coupling_from_op_hyperlink</span><span class="p">(</span><span class="n">FS</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;assumes that the path_file_op is in electronic_structure&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">urllib</span>

    <span class="n">request</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="c1"># response is now a string you can search through containing the page&#39;s html</span>
        <span class="c1"># A, N, E, w, l, q = read_model_h_file(path_file_op)</span>
        <span class="c1"># args = read_model_op_file(path_file_op)  # need to make a choice about the function here</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">save_model_to_JSON</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created </span><span class="se">\n</span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">from</span><span class="se">\n</span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># The url wasn&#39;t valid</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Incorrect https link </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span></div>


<div class="viewcode-block" id="read_model_auto_file"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.read_model_auto_file">[docs]</a><span class="k">def</span> <span class="nf">read_model_auto_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read Vibronic Model file (cp.auto) which</span>
<span class="sd">    contains all information on the approximate</span>
<span class="sd">    Born-Oppenheimer Ground State PES.</span>

<span class="sd">    Returns:</span>
<span class="sd">    number of electronic states</span>
<span class="sd">    number of normal modes</span>

<span class="sd">    Excitation energies: (nel, nel)</span>
<span class="sd">    frequencies (nmode)</span>
<span class="sd">    linear couplings: (nmode, nel, nel)</span>
<span class="sd">    quadratic couplings: (nmode, nmode, nel, nel)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Read file (Iterator object)</span>
    <span class="n">file_object</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

    <span class="c1"># first lets strip out all the blank lines and lines like ------</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file_object</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span> <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;--------&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()))]</span>
    <span class="n">f_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>  <span class="c1"># make an iterator</span>

    <span class="c1"># =====</span>
    <span class="c1"># Title</span>
    <span class="c1"># =====</span>

    <span class="n">title_header</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">FortranRecordReader</span><span class="p">(</span><span class="s1">&#39;(A50, A20)&#39;</span><span class="p">)</span>
    <span class="n">title_header</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))</span>

    <span class="c1"># ==========================</span>
    <span class="c1"># 0. Header and Normal modes</span>
    <span class="c1"># ==========================</span>

    <span class="n">numgrid</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">FortranRecordReader</span><span class="p">(</span><span class="s1">&#39;(A26, i4)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>      <span class="c1"># read the type of grid in ACESII</span>
    <span class="n">num_irreps</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">FortranRecordReader</span><span class="p">(</span><span class="s1">&#39;(A36, i4)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># number of vibrational irreps</span>
    <span class="n">nmodes</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">FortranRecordReader</span><span class="p">(</span><span class="s1">&#39;(A30, i4)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>       <span class="c1"># read the total number of modes per symmetry</span>

    <span class="c1"># Initialize Variables</span>
    <span class="n">excitation_energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nel</span><span class="p">,</span> <span class="n">nel</span><span class="p">))</span>
    <span class="n">frequencies</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nmode</span><span class="p">))</span>
    <span class="n">linear_couplings</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nmode</span><span class="p">,</span> <span class="n">nel</span><span class="p">,</span> <span class="n">nel</span><span class="p">))</span>
    <span class="n">quadratic_couplings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nmode</span><span class="p">,</span> <span class="n">nmode</span><span class="p">,</span> <span class="n">nel</span><span class="p">,</span> <span class="n">nel</span><span class="p">))</span>

    <span class="c1"># we can either grab the frequencies from the ref_freq_data, or the parent hessian</span>
    <span class="k">if</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># the frequency given here is in cm-1</span>
        <span class="n">frequencies</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">FortranRecordReader</span><span class="p">(</span><span class="s1">&#39;(A31, 12F8.2)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">)</span>

    <span class="c1"># ==================</span>
    <span class="c1"># 1. Parent Gradient</span>
    <span class="c1"># ==================</span>

    <span class="n">title_header</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))</span>
    <span class="n">gradient_header_parent</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">FortranRecordReader</span><span class="p">(</span><span class="s1">&#39;(t3, A17, i4, t22, A15, E16.10)&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mode_range</span><span class="p">:</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">)</span>

    <span class="c1"># =================</span>
    <span class="c1"># 2. Parent Hessian</span>
    <span class="c1"># =================</span>

    <span class="n">title_header</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))</span>
    <span class="n">hessian_header_parent</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">FortranRecordReader</span><span class="p">(</span><span class="s1">&#39;(t3, A17, i4, t22, A15, F8.2, A5, F12.6, A5)&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mode_range</span><span class="p">:</span>
            <span class="c1"># store the value incase exception occurs</span>
            <span class="n">temp_str</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">)</span>
            <span class="n">frequencies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">temp_str</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;cm-1&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;eV&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err_obj</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Having issues parsing the Hessian parent energy, why are the frequences not digits?&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">temp_str</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">temp_str</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;cm-1&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">temp_str</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;cm-1&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;eV&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">raise</span> <span class="n">err_obj</span>

    <span class="c1"># ========================</span>
    <span class="c1"># 3. Reference Hamiltonian</span>
    <span class="c1"># ========================</span>

    <span class="n">title_header</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))</span>
    <span class="n">energy_header</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">FortranRecordReader</span><span class="p">(</span><span class="s1">&#39;2(F12.6)&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">el_range</span><span class="p">:</span>
        <span class="n">excitation_energies</span><span class="p">[</span><span class="n">a</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">energy_header</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))</span>

    <span class="c1"># ===============================</span>
    <span class="c1"># 4. Linear couplings (gradients)</span>
    <span class="c1"># ===============================</span>

    <span class="n">title_header</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))</span>
    <span class="n">gradient_header</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">FortranRecordReader</span><span class="p">(</span><span class="s1">&#39;(t3, A15, i4, A15, F10.2)&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mode_range</span><span class="p">:</span>
        <span class="n">gradient_header</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))</span>  <span class="c1"># should &#39;read in&#39; the header</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">el_range</span><span class="p">:</span>
            <span class="n">linear_couplings</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">energy_header</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))</span>

    <span class="c1"># ========================================================</span>
    <span class="c1"># 5. Quadratic couplings [Diagonal corrections of Hessian]</span>
    <span class="c1"># ========================================================</span>
    <span class="c1">#</span>

    <span class="n">title_header</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mode_range</span><span class="p">:</span>
        <span class="n">gradient_header</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">el_range</span><span class="p">:</span>
            <span class="n">quadratic_couplings</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">energy_header</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))</span>

    <span class="c1"># ============================================================</span>
    <span class="c1"># 6. Quadratic couplings [Off-diagonal corrections of Hessian]</span>
    <span class="c1"># ============================================================</span>

    <span class="n">title_header</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mode_range</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">)</span>  <span class="c1"># &#39;reading in&#39; the first line/title</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">el_range</span><span class="p">:</span>
                <span class="n">quadratic_couplings</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">energy_header</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f_iter</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">el_range</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">el_range</span><span class="p">:</span>
            <span class="n">quadratic_couplings</span><span class="p">[:,:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">quadratic_couplings</span><span class="p">[:,:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">],</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># check for symmetry in surfaces</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">el_range</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">el_range</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">linear_couplings</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">],</span> <span class="n">linear_couplings</span><span class="p">[:,</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">]))</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">quadratic_couplings</span><span class="p">[:,:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">],</span> <span class="n">quadratic_couplings</span><span class="p">[:,:,</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">]))</span>

    <span class="c1"># check for symmetry in modes</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mode_range</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">mode_range</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">quadratic_couplings</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:,:],</span> <span class="n">quadratic_couplings</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">,:,:]))</span>

    <span class="k">return</span> <span class="n">nel</span><span class="p">,</span> <span class="n">nmode</span><span class="p">,</span> <span class="n">excitation_energies</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="n">linear_couplings</span><span class="p">,</span> <span class="n">quadratic_couplings</span></div>


<div class="viewcode-block" id="save_model_to_JSON"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.save_model_to_JSON">[docs]</a><span class="k">def</span> <span class="nf">save_model_to_JSON</span><span class="p">(</span><span class="n">path_full</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>

    <span class="n">verify_model_parameters</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Saving model to </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_full</span><span class="p">))</span>

    <span class="c1"># convert each numpy array to a list</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">generic</span><span class="p">)):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># the old way involved passing in each parameter as nonkeyword argument</span>
    <span class="c1"># output_dictionary = {</span>
    <span class="c1">#     &quot;number of modes&quot;:     N,</span>
    <span class="c1">#     &quot;number of surfaces&quot;:  A,</span>
    <span class="c1">#     &quot;energies&quot;:            kwargs[&quot;energies&quot;].tolist(),</span>
    <span class="c1">#     &quot;frequencies&quot;:         kwargs[&quot;frequencies&quot;].tolist(),</span>
    <span class="c1">#     &quot;linear couplings&quot;:    kwargs[&quot;linear_couplings&quot;].tolist(),</span>
    <span class="c1">#     &quot;quadratic couplings&quot;: kwargs[&quot;quadratic_couplings&quot;].tolist(),</span>
    <span class="c1"># }</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_full</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">target_file</span><span class="p">:</span>
        <span class="n">target_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="save_sample_to_JSON"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.save_sample_to_JSON">[docs]</a><span class="k">def</span> <span class="nf">save_sample_to_JSON</span><span class="p">(</span><span class="n">path_full</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>

    <span class="c1"># base case</span>
    <span class="n">verify_sample_parameters</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Saving model to </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_full</span><span class="p">))</span>

    <span class="c1"># convert each numpy array to a list</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">generic</span><span class="p">)):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># the old way involved passing in each parameter as nonkeyword argument</span>
    <span class="c1"># output_dictionary = {</span>
    <span class="c1">#     &quot;number of modes&quot;:     N,</span>
    <span class="c1">#     &quot;number of surfaces&quot;:  A,</span>
    <span class="c1">#     &quot;energies&quot;:            kwargs[&quot;energies&quot;].tolist(),</span>
    <span class="c1">#     &quot;frequencies&quot;:         kwargs[&quot;frequencies&quot;].tolist(),</span>
    <span class="c1">#     &quot;linear couplings&quot;:    kwargs[&quot;linear_couplings&quot;].tolist(),</span>
    <span class="c1">#     &quot;quadratic couplings&quot;: kwargs[&quot;quadratic_couplings&quot;].tolist(),</span>
    <span class="c1"># }</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_full</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">target_file</span><span class="p">:</span>
        <span class="n">target_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">return</span></div>
<span class="c1"># ------------------------------------------------------------------------</span>


<div class="viewcode-block" id="root_directories_exists"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.root_directories_exists">[docs]</a><span class="k">def</span> <span class="nf">root_directories_exists</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">id_data</span><span class="p">,</span> <span class="n">id_rho</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
    <span class="n">path_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">path_root</span> <span class="o">+</span> <span class="n">dir_vib</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_data</span><span class="p">)</span>
    <span class="n">dir_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">path_data</span><span class="p">]</span>
    <span class="n">dir_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">path_data</span> <span class="o">+</span> <span class="s2">&quot;electronic_structure/&quot;</span><span class="p">]</span>
    <span class="n">dir_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">path_data</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_sub_dirs</span><span class="p">])</span>
    <span class="n">dir_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">path_data</span> <span class="o">+</span> <span class="n">dir_rho</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_rho</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_sub_dirs</span><span class="p">])</span>
    <span class="k">if</span> <span class="kc">False</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">,</span> <span class="n">dir_list</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="make_root_directories"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.make_root_directories">[docs]</a><span class="k">def</span> <span class="nf">make_root_directories</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">id_data</span><span class="p">,</span> <span class="n">id_rho</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
    <span class="n">dir_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">path_root</span><span class="p">]</span>
    <span class="n">dir_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">path_data</span> <span class="o">+</span> <span class="s2">&quot;electronic_structure/&quot;</span><span class="p">]</span>
    <span class="n">dir_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">path_root</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_sub_dirs</span><span class="p">])</span>
    <span class="n">dir_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">path_root</span> <span class="o">+</span> <span class="n">dir_rho</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_rho</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_sub_dirs</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">dir_list</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="make_rho_directories"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.make_rho_directories">[docs]</a><span class="k">def</span> <span class="nf">make_rho_directories</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">id_rho</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
    <span class="n">dir_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">path_root</span> <span class="o">+</span> <span class="n">dir_rho</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_rho</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_sub_dirs</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">dir_list</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="load_model_from_JSON"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.load_model_from_JSON">[docs]</a><span class="k">def</span> <span class="nf">load_model_from_JSON</span><span class="p">(</span><span class="n">path_full</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; if only a path to the file is provided, arrays are returned othwerise provided arrays are filled with appropriate values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading model </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_full</span><span class="p">))</span>

    <span class="c1"># open the JSON file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_full</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">target_file</span><span class="p">:</span>
        <span class="n">input_dictionary</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">target_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="c1"># no arrays were provided so return newly created</span>
    <span class="c1"># arrays after filling them with the approriate values</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">_dict</span> <span class="o">=</span> <span class="n">template_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;number of modes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;number of modes&quot;</span><span class="p">])</span>
        <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;number of surfaces&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;number of surfaces&quot;</span><span class="p">])</span>
        <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;energies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;energies&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>
        <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;linear couplings&quot;</span> <span class="ow">in</span> <span class="n">input_dictionary</span><span class="p">:</span>
            <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;linear couplings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;linear couplings&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>
            <span class="c1"># if we don&#39;t predefine the shape, can we run into problems?</span>
            <span class="c1"># linear_couplings = np.empty((N, A, A), dtype=F64)</span>

        <span class="k">if</span> <span class="s2">&quot;quadratic couplings&quot;</span> <span class="ow">in</span> <span class="n">input_dictionary</span><span class="p">:</span>
            <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;quadratic couplings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;quadratic couplings&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>
            <span class="c1"># if we don&#39;t predefine the shape, can we run into problems?</span>
            <span class="c1"># quadratic_couplings = np.empty((N, N, A, A), dtype=F64)</span>

        <span class="k">if</span> <span class="s2">&quot;cubic couplings&quot;</span> <span class="ow">in</span> <span class="n">input_dictionary</span><span class="p">:</span>
            <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;cubic couplings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;cubic couplings&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;quartic couplings&quot;</span> <span class="ow">in</span> <span class="n">input_dictionary</span><span class="p">:</span>
            <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;quartic couplings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;quartic couplings&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>

        <span class="c1"># if the arrays only have zeros then we might not need to store them?</span>
        <span class="n">return_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">return_dict</span>

    <span class="c1"># arrays were provided so fill them with the appropriate values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">verify_model_parameters</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># it might also be good to have some way to calculate the &quot;shape&quot; based on the name?</span>
        <span class="c1"># maybe we should make an enum module that contains the naming conventions for the values in the json files?! - future work</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">generic</span><span class="p">)):</span>
                <span class="c1"># this is a safer way of forcing the input arrays that have no corresponding key in the input_dictionary to have zero values</span>
                <span class="c1"># although this might not be necessary, it is a safer alternative at the moment</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_dictionary</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="load_sample_from_JSON"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.load_sample_from_JSON">[docs]</a><span class="k">def</span> <span class="nf">load_sample_from_JSON</span><span class="p">(</span><span class="n">path_full</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;if only a path to the file is provided, arrays are returned othwerise provided arrays are filled with appropriate values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading rho model (sampling model) </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_full</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_full</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">target_file</span><span class="p">:</span>
        <span class="n">input_dictionary</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">target_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="c1"># no arrays were provided so return newly created</span>
    <span class="c1"># arrays after filling them with the approriate values</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">_dict</span> <span class="o">=</span> <span class="n">template_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;number of modes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;number of modes&quot;</span><span class="p">])</span>
        <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;number of surfaces&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;number of surfaces&quot;</span><span class="p">])</span>
        <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;energies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;energies&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>
        <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;linear couplings&quot;</span> <span class="ow">in</span> <span class="n">input_dictionary</span><span class="p">:</span>
            <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;linear couplings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;linear couplings&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>
            <span class="c1"># if we don&#39;t predefine the shape, can we run into problems?</span>
            <span class="c1"># linear_couplings = np.empty((N, A, A), dtype=F64)</span>

        <span class="k">if</span> <span class="s2">&quot;quadratic couplings&quot;</span> <span class="ow">in</span> <span class="n">input_dictionary</span><span class="p">:</span>
            <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;quadratic couplings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;quadratic couplings&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>
            <span class="c1"># if we don&#39;t predefine the shape, can we run into problems?</span>
            <span class="c1"># quadratic_couplings = np.empty((N, N, A, A), dtype=F64)</span>

        <span class="k">if</span> <span class="s2">&quot;cubic couplings&quot;</span> <span class="ow">in</span> <span class="n">input_dictionary</span><span class="p">:</span>
            <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;cubic couplings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;cubic couplings&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;quartic couplings&quot;</span> <span class="ow">in</span> <span class="n">input_dictionary</span><span class="p">:</span>
            <span class="n">_dict</span><span class="p">[</span><span class="s2">&quot;quartic couplings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;quartic couplings&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>

        <span class="c1"># if the arrays only have zeros then we might not need to store them?</span>
        <span class="n">return_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">return_dict</span>

    <span class="c1"># arrays were provided so fill them with the appropriate values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">verify_sample_parameters</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># it might also be good to have some way to calculate the &quot;shape&quot; based on the name?</span>
        <span class="c1"># maybe we should make an enum module that contains the naming conventions for the values in the json files?! - future work</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">generic</span><span class="p">)):</span>
                <span class="c1"># this is a safer way of forcing the input arrays that have no corresponding key in the input_dictionary to have zero values</span>
                <span class="c1"># although this might not be necessary, it is a safer alternative at the moment</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_dictionary</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>
    <span class="k">return</span></div>


<span class="c1"># this should not be used for the moment</span>
<div class="viewcode-block" id="setup_input_params"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.setup_input_params">[docs]</a><span class="k">def</span> <span class="nf">setup_input_params</span><span class="p">(</span><span class="n">directory_path</span><span class="p">,</span> <span class="n">new_directory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;collate the input parameters and write to a file in the execution directory&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preparing the </span><span class="si">{}</span><span class="s2"> directory</span><span class="se">\n</span><span class="s2">It is </span><span class="si">{}</span><span class="s2"> that I am a new directory&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory_path</span><span class="p">,</span> <span class="n">new_directory</span><span class="p">))</span>

    <span class="c1"># some default file paths</span>
    <span class="n">path_params</span> <span class="o">=</span> <span class="n">directory_path</span> <span class="o">+</span> <span class="s2">&quot;parameters/&quot;</span>
    <span class="n">path_results</span> <span class="o">=</span> <span class="n">directory_path</span> <span class="o">+</span> <span class="s2">&quot;results/&quot;</span>
    <span class="n">path_output</span> <span class="o">=</span> <span class="n">directory_path</span> <span class="o">+</span> <span class="s2">&quot;execution_output/&quot;</span>
    <span class="n">path_plots</span> <span class="o">=</span> <span class="n">directory_path</span> <span class="o">+</span> <span class="s2">&quot;plots/&quot;</span>
    <span class="n">path_rho_params</span> <span class="o">=</span> <span class="n">directory_path</span> <span class="o">+</span> <span class="s2">&quot;rho_0/&quot;</span> <span class="o">+</span> <span class="s2">&quot;parameters/&quot;</span>
    <span class="n">path_rho_results</span> <span class="o">=</span> <span class="n">directory_path</span> <span class="o">+</span> <span class="s2">&quot;rho_0/&quot;</span> <span class="o">+</span> <span class="s2">&quot;results/&quot;</span>
    <span class="n">path_rho_output</span> <span class="o">=</span> <span class="n">directory_path</span> <span class="o">+</span> <span class="s2">&quot;rho_0/&quot;</span> <span class="o">+</span> <span class="s2">&quot;execution_output/&quot;</span>
    <span class="n">path_rho_plots</span> <span class="o">=</span> <span class="n">directory_path</span> <span class="o">+</span> <span class="s2">&quot;rho_0/&quot;</span> <span class="o">+</span> <span class="s2">&quot;plots/&quot;</span>
    <span class="n">json_filename</span> <span class="o">=</span> <span class="s2">&quot;coupled_model.json&quot;</span>

    <span class="c1"># where we store the input parameters</span>
    <span class="n">division_quadratic_term</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">division_linear_term</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">frequency_range</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">number_of_surfaces</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">number_of_modes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">temperature_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sample_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bead_list</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">create_dirs</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_params</span><span class="p">,</span>  <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_results</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_output</span><span class="p">,</span>  <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_plots</span><span class="p">,</span>   <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_rho_params</span><span class="p">,</span>  <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_rho_results</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_rho_output</span><span class="p">,</span>  <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_rho_plots</span><span class="p">,</span>   <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">cleanup_dirs</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -r </span><span class="si">{:}</span><span class="s2">*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_results</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -r </span><span class="si">{:}</span><span class="s2">*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_output</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -r </span><span class="si">{:}</span><span class="s2">*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_plots</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">new_directory</span><span class="p">:</span>
        <span class="n">create_dirs</span><span class="p">(</span><span class="n">directory_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Do you want to remove all data in </span><span class="si">{:}</span><span class="s2">? (Y/N) &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory_path</span><span class="p">))</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">choice</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;ye&quot;</span><span class="p">]):</span>
            <span class="n">cleanup_dirs</span><span class="p">(</span><span class="n">directory_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cleaned up </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory_path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Proceedeing to only overwrite the JSON parameter file</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># copy the model_parameters_source.txt file to the new directory</span>
    <span class="c1"># shutil.copy(filename_source, path_params + filename_source[2:])</span>

    <span class="n">generating_test_data</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span><span class="p">(</span><span class="n">generating_test_data</span><span class="p">):</span>
        <span class="n">energies</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="n">linear_terms</span><span class="p">,</span> <span class="n">quadratic_terms</span> <span class="o">=</span> <span class="n">generate_vibronic_model_data</span><span class="p">(</span><span class="n">source_file</span><span class="o">=</span><span class="s2">&quot;./model_parameters_source.txt&quot;</span><span class="p">,</span> <span class="n">nonadiabatic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># nsurf, nmode, energies, frequencies, linear_terms, quadratic_terms = read_model_auto_file(&quot;./vibron_data/cp.auto&quot;)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/home/ngraymon/chem740/work_dir/scripting/ammonia/ammonia_vibron&#39;</span>
        <span class="n">nsurf</span><span class="p">,</span> <span class="n">nmode</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="n">linear_terms</span><span class="p">,</span> <span class="n">quadratic_terms</span> <span class="o">=</span> <span class="n">read_model_h_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;number of modes&quot;</span><span class="p">:</span> <span class="n">frequencies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
              <span class="s2">&quot;number of surfaces&quot;</span><span class="p">:</span> <span class="n">energies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
              <span class="s2">&quot;energies&quot;</span><span class="p">:</span> <span class="n">energies</span><span class="p">,</span>
              <span class="s2">&quot;frequencies&quot;</span><span class="p">:</span> <span class="n">frequencies</span><span class="p">,</span>
              <span class="s2">&quot;linear couplings&quot;</span><span class="p">:</span> <span class="n">linear_terms</span><span class="p">,</span>
              <span class="s2">&quot;quadratic couplings&quot;</span><span class="p">:</span> <span class="n">quadratic_terms</span><span class="p">,</span>
              <span class="p">}</span>
    <span class="n">save_model_to_JSON</span><span class="p">(</span><span class="n">path_params</span><span class="o">+</span><span class="n">json_filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_get_nmode_nsurf_from_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s2">&quot;invalid path:</span><span class="se">\n</span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">target_file</span><span class="p">:</span>
        <span class="n">input_dictionary</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">target_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="n">number_of_modes</span> <span class="o">=</span> <span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;number of modes&quot;</span><span class="p">]</span>
    <span class="n">number_of_surfaces</span> <span class="o">=</span> <span class="n">input_dictionary</span><span class="p">[</span><span class="s2">&quot;number of surfaces&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">number_of_modes</span><span class="p">,</span> <span class="n">number_of_surfaces</span>


<div class="viewcode-block" id="get_nmode_nsurf_from_coupled_model"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.get_nmode_nsurf_from_coupled_model">[docs]</a><span class="k">def</span> <span class="nf">get_nmode_nsurf_from_coupled_model</span><span class="p">(</span><span class="n">FS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return number_of_modes and number_of_surfaces for coupling_model.json files by using a FileStructure or an absolute path to the file&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">FS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;no arguments provided&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span>
    <span class="k">return</span> <span class="n">_get_nmode_nsurf_from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<span class="c1">#it might be nice to have the ability to specify id_data or id_rho, although this should be done in a way that queries file_structure so as to not &quot;leak&quot; the file structure out to other areas of the code</span>
<div class="viewcode-block" id="get_nmode_nsurf_from_sampling_model"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.get_nmode_nsurf_from_sampling_model">[docs]</a><span class="k">def</span> <span class="nf">get_nmode_nsurf_from_sampling_model</span><span class="p">(</span><span class="n">FS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return number_of_modes and number_of_surfaces for sampling_model.json files by using a FileStructure or an absolute path to the file&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">FS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;no arguments provided&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_rho_model</span>
    <span class="k">return</span> <span class="n">_get_nmode_nsurf_from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove_coupling_from_model"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.remove_coupling_from_model">[docs]</a><span class="k">def</span> <span class="nf">remove_coupling_from_model</span><span class="p">(</span><span class="n">path_source</span><span class="p">,</span> <span class="n">path_destination</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;reads in a model and sets all the coupling parameters to zero&quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">load_model_from_JSON</span><span class="p">(</span><span class="n">path_source</span><span class="p">)</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;energies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;energies&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;linear couplings&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">axis1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;quadratic couplings&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">axis1</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;cubic couplings&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">axis1</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;quartic couplings&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">axis1</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">save_sample_to_JSON</span><span class="p">(</span><span class="n">path_destination</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="create_harmonic_model"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.create_harmonic_model">[docs]</a><span class="k">def</span> <span class="nf">create_harmonic_model</span><span class="p">(</span><span class="n">FS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;wrapper function to refresh harmonic model&quot;&quot;&quot;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_vib_params</span> <span class="o">+</span> <span class="n">file_name</span><span class="o">.</span><span class="n">coupled_model</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_vib_params</span> <span class="o">+</span> <span class="n">file_name</span><span class="o">.</span><span class="n">harmonic_model</span>
    <span class="n">remove_coupling_from_model</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Created harmonic model </span><span class="si">{:s}</span><span class="s2"> by removing coupling from </span><span class="si">{:s}</span><span class="s2">&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">source</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dest</span></div>


<div class="viewcode-block" id="create_basic_sampling_model"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.create_basic_sampling_model">[docs]</a><span class="k">def</span> <span class="nf">create_basic_sampling_model</span><span class="p">(</span><span class="n">FS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;wrapper function to make the simplest sampling model&quot;&quot;&quot;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">create_harmonic_model</span><span class="p">(</span><span class="n">FS</span><span class="p">)</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_rho_params</span> <span class="o">+</span> <span class="n">file_name</span><span class="o">.</span><span class="n">sampling_model</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Sampling model </span><span class="si">{:s}</span><span class="s2"> already exists!&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest</span><span class="p">))</span>

    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Created sampling model </span><span class="si">{:s}</span><span class="s2"> by copying </span><span class="si">{:s}</span><span class="s2">&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">source</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dest</span></div>


<div class="viewcode-block" id="create_fake_coupled_model"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.create_fake_coupled_model">[docs]</a><span class="k">def</span> <span class="nf">create_fake_coupled_model</span><span class="p">(</span><span class="n">FS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; take the diagonal coupled model and preform a unitary transformation on it to get a dense matrix &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">),</span> <span class="s2">&quot;coupled_model file doesn&#39;t exist!&quot;</span>
    <span class="n">model_dict</span> <span class="o">=</span> <span class="n">load_model_from_JSON</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;number of surfaces&quot;</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;number of modes&quot;</span><span class="p">]</span>

    <span class="c1"># generate_orthogonal_matrix</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">ortho_group</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">ortho_group</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="c1"># print(&quot;U\n&quot;, U)</span>
    <span class="c1"># print(&quot;1\n&quot;, U.dot(U.T))</span>

    <span class="k">if</span> <span class="s2">&quot;linear couplings&quot;</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="p">:</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;linear couplings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c1</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="s2">&quot;c1 not diagonal in surfaces&quot;</span>
        <span class="n">new_dense_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bj,ajk,ck-&gt;abc&#39;</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="c1"># print(c1[j, ...], &#39;\n&#39;)</span>
            <span class="c1"># print(np.einsum(U, [3, 1], c1, [0, 1, 2], U, [2, 4], [0, 3, 4]), &#39;\n&#39;)</span>
            <span class="c1"># print(U.dot(c1[j, ...]), &#39;\n&#39;)</span>
            <span class="c1"># print(np.einsum(&#39;bj,ajk-&gt;abk&#39;, U, c1)[j, ...], &#39;\n&#39;)</span>
            <span class="c1"># print(&quot;\n\n\n&quot;)</span>
            <span class="c1"># print(U.dot(c1[j, ...].dot(U.T)), &#39;\n&#39;)</span>
            <span class="c1"># print(np.einsum(&#39;bj,ajk,ck-&gt;abc&#39;, U, c1, U)[j, ...], &#39;\n&#39;)</span>
            <span class="c1"># # print(np.einsum(U, [0, 1], c1[j, ...], [0, 1], [0, 1]), &#39;\n&#39;)</span>
            <span class="c1"># assert False</span>
            <span class="c1"># print(new_dense_matrix[j, ...])</span>
            <span class="c1"># print(U.dot(c1[j, ...].dot(U.T)))</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">new_dense_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
        <span class="n">c1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">new_dense_matrix</span>

    <span class="k">if</span> <span class="s2">&quot;quadratic couplings&quot;</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="p">:</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;quadratic couplings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="s2">&quot;c2 not diagonal in surfaces&quot;</span>
        <span class="n">new_dense_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cj,abjk,dk-&gt;abcd&#39;</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)):</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">new_dense_matrix</span><span class="p">[</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c1</span><span class="p">[</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
        <span class="n">c2</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">new_dense_matrix</span>

    <span class="k">if</span> <span class="s2">&quot;cubic couplings&quot;</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="p">:</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;cubic couplings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">c3</span><span class="p">,</span> <span class="n">c3</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="s2">&quot;c3 not diagonal in surfaces&quot;</span>
        <span class="n">new_dense_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;dj,abcjk,ek-&gt;abcde&#39;</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">j3</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)):</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">new_dense_matrix</span><span class="p">[</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">j3</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c1</span><span class="p">[</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">j3</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
        <span class="n">c3</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">new_dense_matrix</span>

    <span class="k">if</span> <span class="s2">&quot;quartic couplings&quot;</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="p">:</span>
        <span class="n">c4</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;quartic couplings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">c4</span><span class="p">,</span> <span class="n">c4</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span> <span class="s2">&quot;c4 not diagonal in surfaces&quot;</span>
        <span class="n">new_dense_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ej,abcdjk,fk-&gt;abcdef&#39;</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">j3</span><span class="p">,</span> <span class="n">j4</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)):</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">new_dense_matrix</span><span class="p">[</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">j3</span><span class="p">,</span> <span class="n">j4</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c1</span><span class="p">[</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">,</span> <span class="n">j3</span><span class="p">,</span> <span class="n">j4</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
        <span class="n">c4</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">new_dense_matrix</span>

    <span class="c1"># now we need to backup the old model and save the new one</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_vib_params</span> <span class="o">+</span> <span class="n">file_name</span><span class="o">.</span><span class="n">original_model</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

    <span class="n">save_model_to_JSON</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">,</span> <span class="o">**</span><span class="n">model_dict</span><span class="p">)</span>
    <span class="k">return</span></div>


<span class="c1"># this should not be used for the moment</span>
<div class="viewcode-block" id="create_new_execution_directory"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.create_new_execution_directory">[docs]</a><span class="k">def</span> <span class="nf">create_new_execution_directory</span><span class="p">(</span><span class="n">path_root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">id_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;create or overwrite an execution directory&quot;&quot;&quot;</span>
    <span class="c1"># checkOS()</span>

    <span class="c1"># data directories are named &quot;data_set_XXX&quot; where XXX can be an integer</span>
    <span class="c1"># from 1 to DIR_MAX</span>
    <span class="n">DIR_MAX</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>
    <span class="n">DIR_RANGE</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">DIR_MAX</span><span class="p">)</span>

    <span class="c1"># DIR_ARRAY = np.core.defchararray.add(np.full(shape=DIR_MAX, fill_value=&quot;data_set_&quot;, dtype=string_), np.arange(start=1, stop=DIR_MAX), dtype=string_)</span>
    <span class="c1"># print(DIR_ARRAY)</span>

    <span class="k">if</span> <span class="n">path_root</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">id_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dir_base</span> <span class="o">=</span> <span class="n">path_default_root</span> <span class="o">+</span> <span class="n">dir_vib</span>
        <span class="k">for</span> <span class="n">directory_exists</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">dir_base</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="n">counter</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">directory_exists</span><span class="p">:</span>
                <span class="n">free_dir_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                <span class="n">new_directory</span> <span class="o">=</span> <span class="n">dir_base</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">free_dir_id</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;It appears </span><span class="si">{:}</span><span class="s2"> is available, writing model ...&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_directory</span><span class="p">))</span>
                <span class="n">setup_input_params</span><span class="p">(</span><span class="n">new_directory</span><span class="p">,</span> <span class="n">new_directory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Okay... we had issues, you used up the 1e6 possible &quot;</span>
                            <span class="s2">&quot;data set names?????&quot;</span>
                            <span class="p">)</span>

    <span class="k">elif</span> <span class="n">path_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">full_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">path_default_root</span> <span class="o">+</span> <span class="n">dir_vib</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">full_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We discovered a previous execution at </span><span class="si">{:}</span><span class="s2">, &quot;</span>
                  <span class="s2">&quot;do you wish to proceed? (Y/N)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
                  <span class="p">)</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">choice</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;ye&quot;</span><span class="p">]):</span>
                <span class="n">setup_input_params</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Successfully created new model parameters at:</span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_path</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopping</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">setup_input_params</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">new_directory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Successfully created model params at:</span><span class="se">\n</span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_path</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">full_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">path_root</span> <span class="o">+</span> <span class="n">dir_vib</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">full_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We discovered a previous execution at </span><span class="si">{:}</span><span class="s2">, &quot;</span>
                  <span class="s2">&quot;do you wish to proceed? (Y/N)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
                  <span class="p">)</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">choice</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;ye&quot;</span><span class="p">]):</span>
                <span class="n">setup_input_params</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Successfully created new model parameters at:</span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_path</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopping</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">setup_input_params</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">new_directory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Successfully created model params at:</span><span class="se">\n</span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_path</span><span class="p">))</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="verify_execution_directory_exists"><a class="viewcode-back" href="../../../pibronic.data.html#pibronic.data.vibronic_model_io.verify_execution_directory_exists">[docs]</a><span class="k">def</span> <span class="nf">verify_execution_directory_exists</span><span class="p">(</span><span class="n">id_data</span><span class="p">,</span> <span class="n">path_root</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; if directory structure exists does nothing, creates the file structure otherwise&quot;&quot;&quot;</span>
    <span class="c1"># checkOS()</span>

    <span class="c1"># assume default</span>
    <span class="k">if</span> <span class="n">path_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path_root</span> <span class="o">=</span> <span class="n">path_default_root</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">file_structure</span><span class="o">.</span><span class="n">FileStructure</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">id_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">files</span><span class="o">.</span><span class="n">directories_exist</span><span class="p">():</span>
        <span class="k">return</span>

    <span class="n">files</span><span class="o">.</span><span class="n">make_directories</span><span class="p">()</span>
    <span class="k">return</span></div>


<span class="k">if</span> <span class="p">(</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">path_root</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">id_data</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">create_new_execution_directory</span><span class="p">(</span><span class="n">path_root</span><span class="o">=</span><span class="n">path_root</span><span class="p">,</span> <span class="n">id_data</span><span class="o">=</span><span class="n">id_data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">id_data</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">create_new_execution_directory</span><span class="p">(</span><span class="n">id_data</span><span class="o">=</span><span class="n">id_data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">create_new_execution_directory</span><span class="p">()</span>

    <span class="c1"># read_model_h_file(&#39;/home/ngraymon/chem740/work_dir/scripting/ammonia/ammonia_vibron&#39;)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Neil Raymond.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>