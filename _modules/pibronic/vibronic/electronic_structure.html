
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pibronic.vibronic.electronic_structure &#8212; Pibronic 0.3.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pibronic.vibronic.electronic_structure</h1><div class="highlight"><pre>
<span></span><span class="c1"># electronic_structure.py</span>
<span class="c1">#</span>
<span class="c1"># system imports</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
<span class="c1"># import threading</span>
<span class="c1"># import warnings</span>
<span class="c1"># import inspect</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="c1"># import socket</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c1"># import math</span>
<span class="kn">import</span> <span class="nn">mmap</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">isfile</span>

<span class="c1"># third party imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># local imports</span>
<span class="c1"># from ..data import vibronic_model_io as vIO</span>
<span class="c1"># from .. import constants</span>
<span class="c1"># from ..constants import hbar</span>
<span class="kn">from</span> <span class="nn">..log_conf</span> <span class="k">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">..server</span> <span class="k">import</span> <span class="n">job_boss</span>


<span class="c1"># how we identify the different steps</span>
<div class="viewcode-block" id="State"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.State">[docs]</a><span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="c1"># DROPMO   = 0</span>
    <span class="n">OPT</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">NIP</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">VIB</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">IPEOMCC</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">PREPVIB</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">VIBRON</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">FINISHED</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__members__</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__members__</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span></div>


<span class="c1"># the input filename templates that this script uses to run calculations</span>
<span class="n">default_file_in</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;parameter&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_params.txt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;zmat&quot;</span><span class="p">:</span>      <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_zmat.txt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DROPMO&quot;</span><span class="p">:</span>    <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_hartree_fock_dropmo.in&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NIP&quot;</span><span class="p">:</span>       <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_hartree_fock_nip.in&quot;</span><span class="p">,</span>
    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span>  <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_opt.in&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vib&quot;</span><span class="p">:</span>       <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_vib.in&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ipeomcc&quot;</span><span class="p">:</span>   <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_eomcc_ip_{{:d}}.in&quot;</span><span class="p">,</span>
    <span class="s2">&quot;prepVib&quot;</span><span class="p">:</span>   <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_prepvib.in&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vibronIn&quot;</span><span class="p">:</span>  <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_vibron.in&quot;</span><span class="p">,</span>
    <span class="c1"># &quot;vibronIn&quot;:  &quot;cp.in&quot;,</span>
    <span class="s2">&quot;vibronCp&quot;</span><span class="p">:</span>  <span class="s2">&quot;cp.auto&quot;</span><span class="p">,</span>
    <span class="c1"># &quot;vibronCp&quot;:  &quot;{:s}_vibron.auto&quot;,</span>
<span class="p">}</span>

<span class="c1"># the output filename templates that this script uses to run calculations</span>
<span class="n">default_file_out</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;DROPMO&quot;</span><span class="p">:</span>   <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_hartree_fock_dropmo.out0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NIP&quot;</span><span class="p">:</span>      <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_hartree_fock_nip.out0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_opt.out0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vib&quot;</span><span class="p">:</span>      <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_vib.out0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ipeomcc&quot;</span><span class="p">:</span>  <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_eomcc_ip_{{:d}}.out0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;prepVib&quot;</span><span class="p">:</span>  <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_prepvib.out0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pntheff&quot;</span><span class="p">:</span>  <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_prepvib.pntheff&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vibronIn&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_prepvib.vibron_input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vibronCp&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_prepvib.vibronic_coupling&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vibron&quot;</span><span class="p">:</span>   <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">_vibron.out0&quot;</span><span class="p">,</span>
    <span class="c1"># &quot;vibron&quot;:   &quot;cp.auto0&quot;,</span>
<span class="p">}</span>


<span class="c1"># supported calculation methods</span>
<span class="n">basis_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;TZ2P&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DZP&quot;</span><span class="p">,</span>
    <span class="c1"># &quot;6-31+G&quot;,</span>
    <span class="c1"># &quot;6-31++G**&quot;,</span>
<span class="p">]</span>

<span class="n">theory_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;MBPT(2)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CCSD&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CCSD(T)&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">calculations_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;IP&quot;</span><span class="p">,</span>
    <span class="c1"># &quot;EA&quot;,</span>
    <span class="c1"># &quot;EA&quot;,</span>
<span class="p">]</span>

<span class="sd">&quot;&quot;&quot; get the functions name &quot;&quot;&quot;</span>
<span class="c1"># inspect.currentframe().f_code.co_name</span>
<span class="sd">&quot;&quot;&quot; get the name of the function that called the current function &quot;&quot;&quot;</span>
<span class="c1"># inspect.currentframe().f_back.f_code.co_name</span>

<span class="c1"># -----------------------------------------------------------</span>
<span class="c1"># MEMORY MAPPED HELPER FUNCTIONS</span>
<span class="c1"># -----------------------------------------------------------</span>


<div class="viewcode-block" id="find_string_in_file"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.find_string_in_file">[docs]</a><span class="k">def</span> <span class="nf">find_string_in_file</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">target_string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;wrapper that raises error if no substr can be found finds the first occurrence of a substring in memory mapped file&quot;&quot;&quot;</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">target_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># couldn&#39;t find target string in file</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;It seems </span><span class="se">\&quot;</span><span class="si">{:s}</span><span class="se">\&quot;</span><span class="s2"> was not present in the file</span><span class="se">\n\&quot;</span><span class="si">{:s}</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;Check that the previous calculation didn&#39;t fail&quot;</span>
             <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_string</span><span class="p">,</span> <span class="n">file_path</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">location</span></div>


<div class="viewcode-block" id="rfind_string_in_file"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.rfind_string_in_file">[docs]</a><span class="k">def</span> <span class="nf">rfind_string_in_file</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">target_string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;wrapper that raises error if no substr can be found finds the last occurrence of a substring in memory mapped file&quot;&quot;&quot;</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">target_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># couldn&#39;t find target string in file</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;It seems </span><span class="se">\&quot;</span><span class="si">{:s}</span><span class="se">\&quot;</span><span class="s2"> was not present in the file</span><span class="se">\n\&quot;</span><span class="si">{:s}</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;Check that the previous calculation didn&#39;t fail&quot;</span>
             <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_string</span><span class="p">,</span> <span class="n">file_path</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">location</span></div>


<div class="viewcode-block" id="skip_back_n_lines"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.skip_back_n_lines">[docs]</a><span class="k">def</span> <span class="nf">skip_back_n_lines</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">start_index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;gives the byte location n lines before the given byte location start_index&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">temporary_start_index</span> <span class="o">=</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">start_index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temporary_start_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">start_index</span> <span class="o">=</span> <span class="n">temporary_start_index</span>

    <span class="k">return</span> <span class="n">start_index</span></div>


<div class="viewcode-block" id="skip_forward_n_lines"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.skip_forward_n_lines">[docs]</a><span class="k">def</span> <span class="nf">skip_forward_n_lines</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">start_index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;gives the byte location n lines after the given byte location start_index&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">temporary_start_index</span> <span class="o">=</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">start_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temporary_start_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">start_index</span> <span class="o">=</span> <span class="n">temporary_start_index</span>

    <span class="k">return</span> <span class="n">start_index</span></div>

<span class="c1"># -----------------------------------------------------------</span>
<span class="c1"># HELPER FUNCTIONS</span>
<span class="c1"># -----------------------------------------------------------</span>


<span class="n">number_dictionary</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span>    <span class="p">(</span><span class="s2">&quot;acetonitrile&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
    <span class="mi">1</span><span class="p">:</span>    <span class="p">(</span><span class="s2">&quot;ammonia&quot;</span><span class="p">,</span> <span class="mi">201</span><span class="p">),</span>
    <span class="mi">2</span><span class="p">:</span>    <span class="p">(</span><span class="s2">&quot;boron_trifluoride&quot;</span><span class="p">,</span> <span class="mi">202</span><span class="p">),</span>
    <span class="mi">3</span><span class="p">:</span>    <span class="p">(</span><span class="s2">&quot;formaldehyde&quot;</span><span class="p">,</span> <span class="mi">203</span><span class="p">),</span>
    <span class="mi">4</span><span class="p">:</span>    <span class="p">(</span><span class="s2">&quot;methane&quot;</span><span class="p">,</span> <span class="mi">204</span><span class="p">),</span>
    <span class="mi">5</span><span class="p">:</span>    <span class="p">(</span><span class="s2">&quot;formamide&quot;</span><span class="p">,</span> <span class="mi">205</span><span class="p">),</span>
    <span class="mi">6</span><span class="p">:</span>    <span class="p">(</span><span class="s2">&quot;formic_acid&quot;</span><span class="p">,</span> <span class="mi">206</span><span class="p">),</span>
    <span class="mi">7</span><span class="p">:</span>    <span class="p">(</span><span class="s2">&quot;hydrogen_peroxide&quot;</span><span class="p">,</span> <span class="mi">207</span><span class="p">),</span>
    <span class="mi">8</span><span class="p">:</span>    <span class="p">(</span><span class="s2">&quot;water&quot;</span><span class="p">,</span> <span class="mi">208</span><span class="p">),</span>
    <span class="mi">9</span><span class="p">:</span>    <span class="p">(</span><span class="s2">&quot;pyridine&quot;</span><span class="p">,</span> <span class="mi">209</span><span class="p">),</span>
    <span class="mi">10</span><span class="p">:</span>   <span class="p">(</span><span class="s2">&quot;furan&quot;</span><span class="p">,</span> <span class="mi">210</span><span class="p">),</span>
    <span class="mi">11</span><span class="p">:</span>   <span class="p">(</span><span class="s2">&quot;trichloroethylene&quot;</span><span class="p">,</span> <span class="mi">211</span><span class="p">),</span>
    <span class="mi">12</span><span class="p">:</span>   <span class="p">(</span><span class="s2">&quot;chloroethylene&quot;</span><span class="p">,</span> <span class="mi">212</span><span class="p">),</span>
    <span class="mi">13</span><span class="p">:</span>   <span class="p">(</span><span class="s2">&quot;acrolein&quot;</span><span class="p">,</span> <span class="mi">213</span><span class="p">),</span>
    <span class="mi">14</span><span class="p">:</span>   <span class="p">(</span><span class="s2">&quot;acrylonitrile&quot;</span><span class="p">,</span> <span class="mi">214</span><span class="p">),</span>
    <span class="mi">15</span><span class="p">:</span>   <span class="p">(</span><span class="s2">&quot;cis_12_dichloroethylene&quot;</span><span class="p">,</span> <span class="mi">215</span><span class="p">),</span>
    <span class="mi">16</span><span class="p">:</span>   <span class="p">(</span><span class="s2">&quot;trans_12_dichloroethylene&quot;</span><span class="p">,</span> <span class="mi">216</span><span class="p">),</span>
    <span class="mi">17</span><span class="p">:</span>   <span class="p">(</span><span class="s2">&quot;11_dichloroethylene&quot;</span><span class="p">,</span> <span class="mi">217</span><span class="p">),</span>
    <span class="c1"># 18:   (&quot;&quot;, 218),</span>
    <span class="c1"># 19:   (&quot;&quot;, 219),</span>
    <span class="c1"># 20:   (&quot;&quot;, 220),</span>
    <span class="c1"># 21:   (&quot;&quot;, 221),</span>
    <span class="p">}</span>

<span class="n">name_of_state_file</span> <span class="o">=</span> <span class="s2">&quot;execution_state.txt&quot;</span>


<div class="viewcode-block" id="pretty_print_job_status"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.pretty_print_job_status">[docs]</a><span class="k">def</span> <span class="nf">pretty_print_job_status</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;quick hack for scripting, path should look something like</span>
<span class="sd">    `/**/data_set_{:d}/electronic_structure/execution_state.txt`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># use the default path</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="s2">&quot;/work/ngraymon/pimc/data_set_</span><span class="si">{:d}</span><span class="s2">/electronic_structure/&quot;</span><span class="p">,</span> <span class="n">name_of_state_file</span><span class="p">)</span>

    <span class="c1"># assume that we we&#39;re provided with the root of the path</span>
    <span class="k">if</span> <span class="s2">&quot;data_set_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;data_set_</span><span class="si">{:d}</span><span class="s2">/electronic_structure/&quot;</span><span class="p">,</span> <span class="n">name_of_state_file</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">number_dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">path_file_state</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">path_file_state</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_file_state</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="n">last_state</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">break</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">{:}</span><span class="s2">, </span><span class="si">{:}</span><span class="s2">) last state was </span><span class="si">{:}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">last_state</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;(</span><span class="si">{:}</span><span class="s2">, </span><span class="si">{:}</span><span class="s2">) does not have an </span><span class="si">{:s}</span><span class="s2"> file&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">name_of_state_file</span><span class="p">))</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="verify_file_exists"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.verify_file_exists">[docs]</a><span class="k">def</span> <span class="nf">verify_file_exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;raises FileNotFoundError exception if input is not a file, or does not exist&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Cannot find </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="pairwise"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.pairwise">[docs]</a><span class="k">def</span> <span class="nf">pairwise</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;returns an iterator over pairs of elements in the iterable&quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">tee</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
    <span class="nb">next</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_yes_no_from_user"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.get_yes_no_from_user">[docs]</a><span class="k">def</span> <span class="nf">get_yes_no_from_user</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return the Boolean value of the users response the a yes/no question&quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">yes_no</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sorry, I didn&#39;t understand that</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">yes_no</span></div>


<div class="viewcode-block" id="get_integer_from_user"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.get_integer_from_user">[docs]</a><span class="k">def</span> <span class="nf">get_integer_from_user</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return the integer value of the users response to a input prompt&quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_integer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">user_integer</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sorry, I didn&#39;t understand that</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide a non negative value</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">user_integer</span></div>


<div class="viewcode-block" id="wait_on_results"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.wait_on_results">[docs]</a><span class="k">def</span> <span class="nf">wait_on_results</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">job_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;synchronizes with the submitted job and verifies that the job&#39;s output is successful&quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">flow</span><span class="p">(</span><span class="s2">&quot;Waiting on job&quot;</span><span class="p">)</span>

    <span class="c1"># wait for the job to queue up</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">job_boss</span><span class="o">.</span><span class="n">synchronize_with_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">job_type</span><span class="p">)</span>

    <span class="c1"># get the recorded state of the job</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">job_boss</span><span class="o">.</span><span class="n">check_acct_state</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>

    <span class="c1"># check if the job failed</span>
    <span class="k">if</span> <span class="s2">&quot;FAILED&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2"> script (JOBID=</span><span class="si">{:d}</span><span class="s2">) failed for some reason&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_type</span><span class="p">,</span> <span class="n">job_id</span><span class="p">))</span>

    <span class="c1"># needs to be completed</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="s2">&quot;COMPLETED&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unknown result in </span><span class="si">{:s}</span><span class="s2"> parsing&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_type</span><span class="p">))</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="verify_aces2_completed"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.verify_aces2_completed">[docs]</a><span class="k">def</span> <span class="nf">verify_aces2_completed</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;verifies that the aces2 output file has completed successfully&quot;&quot;&quot;</span>
    <span class="n">final_string</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;The ACES2 program has completed successfully in&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">source_file</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prot</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">PROT_READ</span><span class="p">)</span> <span class="k">as</span> <span class="n">memmap_file</span><span class="p">:</span>
            <span class="c1"># the target string should be in the last couple lines of the file</span>
            <span class="c1"># first we find the byte location of the beginning of the 10th last line</span>
            <span class="n">ten_lines_back</span> <span class="o">=</span> <span class="n">skip_back_n_lines</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># then we search from there to the end of the file for our target string</span>
            <span class="k">if</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">final_string</span><span class="p">,</span> <span class="n">ten_lines_back</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># if we don&#39;t find it then the calculation was a failure</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Output for ACES2 jobid=</span><span class="si">{:d}</span><span class="s2"> did not complete successfully!</span><span class="se">\n</span><span class="s2">&quot;</span>
                     <span class="s2">&quot;Check output file</span><span class="se">\n</span><span class="si">{:s}</span><span class="s2">&quot;</span>
                     <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">file_path</span><span class="p">))</span>

                <span class="c1"># verify that the slurm job didn&#39;t fail</span>
                <span class="n">job_boss</span><span class="o">.</span><span class="n">check_slurm_output</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>

                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Could not find an issue with slurm output in file</span><span class="se">\n</span><span class="s2">slurm-</span><span class="si">{:d}</span><span class="s2">.out</span><span class="se">\n</span><span class="s2">&quot;</span>
                     <span class="s2">&quot;It appears that slurm job didn&#39;t fail but ACES2 did?</span><span class="se">\n</span><span class="s2">&quot;</span>
                     <span class="s2">&quot;This appears to be a theory/numerical/symmetry issue.</span><span class="se">\n</span><span class="s2">&quot;</span>
                     <span class="p">)</span>
                <span class="c1"># only the aces2 job failed?</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">))</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="submit_job"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.submit_job">[docs]</a><span class="k">def</span> <span class="nf">submit_job</span><span class="p">(</span><span class="n">parameter_dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;wrapper for job_boss job submission&quot;&quot;&quot;</span>

    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;sbatch&quot;</span>
    <span class="n">command</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot; --mem=</span><span class="si">{memory_size:d}</span><span class="s2">G&quot;</span>
                <span class="s2">&quot; --ntasks=1&quot;</span>
                <span class="s2">&quot; --job-name=</span><span class="si">{file_name:s}</span><span class="s2">&quot;</span>
                <span class="s2">&quot; --cpus-per-task=</span><span class="si">{cpus:d}</span><span class="s2">&quot;</span>
                <span class="s2">&quot; --workdir=</span><span class="si">{work_dir:s}</span><span class="s2">&quot;</span>
                <span class="c1"># &quot; --output={output:s}/%x.o%j&quot;</span>
                <span class="s2">&quot; --partition=</span><span class="si">{partition:s}</span><span class="s2">&quot;</span>
                <span class="s2">&quot; --export=&quot;</span>
                <span class="c1"># &quot;MK_SCRATCH_DIR={make_scratch:s}&quot;</span>
                <span class="c1"># &quot;,SCRATCH_COPY_IN={scratch_in:s}&quot;</span>
                <span class="c1"># &quot;,SCRATCH_COPY_OUT={scratch_out:s}&quot;</span>
                <span class="s2">&quot;,HEADNODE=</span><span class="si">{hostname:s}</span><span class="s2">&quot;</span>
                <span class="s2">&quot;,PREAMBLE=</span><span class="si">{pre_amble:s}</span><span class="s2">&quot;</span>
                <span class="s2">&quot;,JOB=</span><span class="si">{job_name:s}</span><span class="s2">&quot;</span>
                <span class="s2">&quot;,POSTAMBLE=</span><span class="si">{post_amble:s}</span><span class="s2">&quot;</span>
                <span class="s2">&quot;,PARENT_PID=</span><span class="si">{parent_pid:d}</span><span class="s2">&quot;</span>
                <span class="s2">&quot; /home/ngraymon/chem740/work_dir/submit_template&quot;</span>
                <span class="p">)</span>

    <span class="n">job_id</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">job_boss</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">parameter_dictionary</span><span class="p">)</span>

    <span class="c1"># check for any errors</span>
    <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Failed to execute script </span><span class="se">\n</span><span class="si">{:s}</span><span class="se">\n</span><span class="s2"> due to </span><span class="si">{:s}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">job_id</span></div>
<span class="c1"># -----------------------------------------------------------</span>


<div class="viewcode-block" id="parse_input_parameters"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.parse_input_parameters">[docs]</a><span class="k">def</span> <span class="nf">parse_input_parameters</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span>  <span class="c1"># does not work - decommission for now</span>
    <span class="c1"># Default is to assume parameter file is in the same directory</span>
    <span class="c1"># if file_path is None:</span>
    <span class="c1">#     file_path = os.path.dirname(os.path.realpath(__file__))</span>
    <span class="c1">#     file_path = join(file_path, default_file_in[&quot;parameter&quot;].format(&quot;default&quot;))</span>

    <span class="c1"># where we store the data</span>
    <span class="n">data_dictionary</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;calculation&quot;</span><span class="p">:</span>  <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;zmat path&quot;</span><span class="p">:</span>    <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;theory&quot;</span><span class="p">:</span>       <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;basis&quot;</span><span class="p">:</span>        <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># # read in the file contents</span>
    <span class="c1"># try:</span>
    <span class="c1">#     verify_file_exists(file_path)</span>

    <span class="c1">#     with open(file_path, &#39;r&#39;) as source_file:</span>
    <span class="c1">#         for line in source_file:</span>
    <span class="c1">#             if not (line == &quot;&quot; or line.startswith(&quot;#&quot;)):</span>
    <span class="c1">#                 header = line.strip()</span>
    <span class="c1">#                 data = source_file.readline().strip()</span>
    <span class="c1">#                 if header in [&quot;zmat path&quot;, &quot;basis&quot;, &quot;theory&quot;, &quot;calculation&quot;]:</span>
    <span class="c1">#                     data_dictionary[header] = data</span>
    <span class="c1">#                 else:</span>
    <span class="c1">#                     s = (&quot;Header {:s} is not valid\n&quot;</span>
    <span class="c1">#                          &quot;Check that your {:s} has the correct formatting&quot;</span>
    <span class="c1">#                          )</span>
    <span class="c1">#                     raise ValueError(s.format(header, file_path))</span>
    <span class="c1"># except ValueError as error_object:</span>
    <span class="c1">#     raise error_object</span>

    <span class="c1"># # check the validity of the parameter file</span>
    <span class="c1"># assert data_dictionary[&quot;basis&quot;] in basis_list, &quot;invalid parameter provided for basis&quot;</span>
    <span class="c1"># assert data_dictionary[&quot;theory&quot;] in theory_list, &quot;invalid parameter provided for theory&quot;</span>
    <span class="c1"># assert data_dictionary[&quot;calculation&quot;] in calculations_list, &quot;invalid parameter provided for calculation&quot;</span>
    <span class="c1"># assert isfile(data_dictionary[&quot;zmat path&quot;]), &quot;path to zmat file is not a valid path!&quot;</span>

    <span class="k">return</span> <span class="n">data_dictionary</span></div>


<div class="viewcode-block" id="hartree_fock_calculation"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.hartree_fock_calculation">[docs]</a><span class="k">def</span> <span class="nf">hartree_fock_calculation</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">zmat</span><span class="p">,</span> <span class="n">parameter_dictionary</span><span class="p">,</span> <span class="n">hf_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;creates and populates the input file and submission file for the job&quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">flow</span><span class="p">(</span><span class="s2">&quot;Setting up </span><span class="si">{:s}</span><span class="s2"> calculation&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hf_type</span><span class="p">))</span>

    <span class="n">memory_size</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># in GB&#39;s</span>

    <span class="c1"># file location</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">default_file_in</span><span class="p">[</span><span class="n">hf_type</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="c1"># create the input file template</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">zmat</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;*ACES2( BASIS=</span><span class="si">{basis:s}</span><span class="s2">,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;CALC=SCF,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;MEMORY_SIZE=</span><span class="si">{:d}</span><span class="s2">GB,&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memory_size</span><span class="p">)</span>
    <span class="c1"># template += &quot;\n\t&quot; + &quot;{DROPMO:s},&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># populate the template using the input dictionary</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="n">parameter_dictionary</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest_file</span><span class="p">:</span>
        <span class="n">dest_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="c1"># &quot;/scratch/$USER/pimc/data_set_${DATA_SET_ID}/&quot;</span>
    <span class="c1"># copy_out = &quot;mv --force /scratch/$USER/pimc/data_set_${DATA_SET_ID}/&quot;</span>
    <span class="c1"># path_output = &quot;/scratch/$USER/pimc/data_set_{:d}/execution_output/&quot;</span>

    <span class="c1"># nothing for now</span>
    <span class="n">copy_in</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">copy_out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">path_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">slurm_parameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;memory_size&quot;</span><span class="p">:</span> <span class="n">memory_size</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
        <span class="s2">&quot;cpus&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;work_dir&quot;</span><span class="p">:</span> <span class="n">path_root</span><span class="p">,</span>
        <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">path_output</span><span class="p">,</span>
        <span class="s2">&quot;partition&quot;</span><span class="p">:</span> <span class="n">job_boss</span><span class="o">.</span><span class="n">partition</span><span class="p">,</span>
        <span class="s2">&quot;make_scratch&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;scratch_in&quot;</span><span class="p">:</span> <span class="n">copy_in</span><span class="p">,</span>
        <span class="s2">&quot;scratch_out&quot;</span><span class="p">:</span> <span class="n">copy_out</span><span class="p">,</span>
        <span class="s2">&quot;pre_amble&quot;</span><span class="p">:</span> <span class="s2">&quot;jobaces&quot;</span><span class="p">,</span>
        <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.in&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;post_amble&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">job_boss</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
        <span class="s2">&quot;parent_pid&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="c1"># run the job</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="n">submit_job</span><span class="p">(</span><span class="n">slurm_parameters</span><span class="p">)</span>

    <span class="n">wait_on_results</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="s2">&quot;SCF&quot;</span><span class="p">)</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="n">default_file_out</span><span class="p">[</span><span class="n">hf_type</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="n">verify_aces2_completed</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span></div>
<div class="viewcode-block" id="temp_file_path"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.temp_file_path">[docs]</a><span class="k">def</span> <span class="nf">temp_file_path</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>

    <span class="k">return</span></div>


<span class="k">def</span> <span class="nf">_estimate_dropmo</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;read the output file from a scf calculation and attempt to choose a DROPMO value &quot;&quot;&quot;</span>

    <span class="c1"># access the file using memory map for efficiency</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">source_file</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prot</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">PROT_READ</span><span class="p">)</span> <span class="k">as</span> <span class="n">memmap_file</span><span class="p">:</span>

            <span class="c1"># find the beginning and ending of the important region</span>
            <span class="n">target_begin</span> <span class="o">=</span> <span class="s1">&#39;ORBITAL EIGENVALUES (ALPHA)&#39;</span>
            <span class="n">target_end</span> <span class="o">=</span> <span class="s1">&#39;+++++++++++++++++++++++++++++++++++++++++++&#39;</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">target_begin</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">target_end</span><span class="p">)</span>

            <span class="c1"># go there</span>
            <span class="n">memmap_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

            <span class="c1"># throw away the header lines</span>
            <span class="n">past_headers</span> <span class="o">=</span> <span class="n">skip_forward_n_lines</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
            <span class="n">memmap_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">past_headers</span><span class="p">)</span>

            <span class="c1"># read all the relevant data</span>
            <span class="n">data_in_bytes</span> <span class="o">=</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
            <span class="n">data_as_string</span> <span class="o">=</span> <span class="n">data_in_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">data_as_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

    <span class="c1"># attempt to guess a DROPMO value</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># where we store the data</span>
        <span class="n">list_ev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">5</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;list_ev &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">list_ev</span><span class="p">))</span>

        <span class="c1"># the differences in each pair of eV&#39;s</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">pairwise</span><span class="p">(</span><span class="n">list_ev</span><span class="p">)))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;diffs &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">diffs</span><span class="p">))</span>

        <span class="c1"># biggest gap in eV&#39;s</span>
        <span class="n">max_diff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">diffs</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;max_diff: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">max_diff</span><span class="p">))</span>

        <span class="c1"># getguess_dropmo</span>
        <span class="n">guess_dropmo</span> <span class="o">=</span> <span class="n">diffs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">max_diff</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;guess_dropmo: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">guess_dropmo</span><span class="p">))</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">guess_dropmo</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;We failed to guess a dropmo&quot;</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="n">string_orbital</span> <span class="o">=</span> <span class="s2">&quot;Here are the orbital energies</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">string_orbital</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">string_orbital</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">list_ev</span><span class="p">])</span>
    <span class="n">string_orbital</span> <span class="o">+=</span> <span class="s2">&quot;+&quot;</span><span class="o">*</span><span class="mi">30</span>

    <span class="c1"># show the user the orbital energies</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">string_orbital</span><span class="p">)</span>

    <span class="c1"># ask user if our guess of dropmo is appropriate</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">guess_dropmo</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;We guessed that dropmo should be </span><span class="si">{:d}</span><span class="s2"> is that acceptable?</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">get_yes_no_from_user</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">guess_dropmo</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We failed to guess a dropmo value&quot;</span><span class="p">)</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># if the dropmo value is bad then get a new value from the user</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
        <span class="n">guess_dropmo</span> <span class="o">=</span> <span class="n">get_integer_from_user</span><span class="p">(</span><span class="s2">&quot;Please provide an alternative dropmo value</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;You provided a new dropmo value of </span><span class="si">{:d}</span><span class="s2"> is that acceptable?</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">get_yes_no_from_user</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">guess_dropmo</span><span class="p">))</span>

    <span class="c1"># if zero then don&#39;t put any typeword</span>
    <span class="n">string_dropmo</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">guess_dropmo</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">string_dropmo</span> <span class="o">=</span> <span class="s2">&quot;DROPMO=1&quot;</span>

    <span class="k">if</span> <span class="n">guess_dropmo</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># a range of orbitals is indicated by &#39;1-X&#39;</span>
        <span class="n">string_dropmo</span> <span class="o">=</span> <span class="s2">&quot;DROPMO=1-</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">guess_dropmo</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">string_dropmo</span>


<span class="k">def</span> <span class="nf">_extract_lines_for_estimating_NIP</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; does what it says &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
        <span class="c1"># access the file using memory map for efficiency</span>
        <span class="k">with</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">source_file</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prot</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">PROT_READ</span><span class="p">)</span> <span class="k">as</span> <span class="n">memmap_file</span><span class="p">:</span>

            <span class="c1"># find the beginning and ending of the important region</span>
            <span class="n">target_begin</span> <span class="o">=</span> <span class="s1">&#39;ORBITAL EIGENVALUES (ALPHA)&#39;</span>
            <span class="n">target_end</span> <span class="o">=</span> <span class="s1">&#39;+++++++++++++++++++++++++++++++++++++++++++&#39;</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">target_begin</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">target_end</span><span class="p">)</span>

            <span class="c1"># go there</span>
            <span class="n">memmap_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

            <span class="c1"># throw away the header lines</span>
            <span class="n">past_headers</span> <span class="o">=</span> <span class="n">skip_forward_n_lines</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
            <span class="n">memmap_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">past_headers</span><span class="p">)</span>

            <span class="c1"># read all the relevant data</span>
            <span class="n">data_in_bytes</span> <span class="o">=</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
            <span class="n">data_as_string</span> <span class="o">=</span> <span class="n">data_in_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">data_as_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">lines</span>


<span class="k">def</span> <span class="nf">_guess_NIP_value</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">guess_dropmo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; attempt to guess a NIP value &quot;&quot;&quot;</span>
    <span class="n">list_ev</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># where we store the data</span>
        <span class="n">list_ev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">5</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">lin</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;list_ev &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">list_ev</span><span class="p">))</span>

        <span class="c1"># the differences in each pair of eV&#39;s</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">pairwise</span><span class="p">(</span><span class="n">list_ev</span><span class="p">)))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;diffs &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">diffs</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">guess_dropmo</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_ev</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Can&#39;t remove orbitals that don&#39;t exist&quot;</span><span class="p">)</span>

        <span class="n">list_dropped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">list_ev</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">guess_dropmo</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;list_dropped &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">list_dropped</span><span class="p">))</span>

        <span class="c1"># the differences in each pair of eV&#39;s</span>
        <span class="n">diffs2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">pairwise</span><span class="p">(</span><span class="n">list_dropped</span><span class="p">)))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;diffs2 &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">diffs2</span><span class="p">))</span>

        <span class="c1"># biggest gap in eV&#39;s</span>
        <span class="n">second_highest</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">diffs2</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;second_highest: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">second_highest</span><span class="p">))</span>

        <span class="c1"># the suggested nip value</span>
        <span class="n">guess_nip</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">diffs</span><span class="p">)</span> <span class="o">-</span> <span class="n">diffs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">second_highest</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;guess_nip: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">guess_nip</span><span class="p">))</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">guess_nip</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;We failed to guess a nip&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">guess_nip</span><span class="p">,</span> <span class="n">list_ev</span>


<span class="k">def</span> <span class="nf">_estimate_NIP</span><span class="p">(</span><span class="n">vibron</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; read the output file from a scf calculation and attempt to choose a NIP value&quot;&quot;&quot;</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="n">_extract_lines_for_estimating_NIP</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="c1"># grab the guess_dropmo as a number</span>
    <span class="n">string_dropmo</span> <span class="o">=</span> <span class="n">vibron</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="s2">&quot;DROPMO&quot;</span><span class="p">]</span>
    <span class="n">guess_dropmo</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">string_dropmo</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">string_dropmo</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">guess_dropmo</span><span class="p">)</span>

    <span class="n">guess_nip</span><span class="p">,</span> <span class="n">list_ev</span> <span class="o">=</span> <span class="n">_guess_NIP_value</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">guess_dropmo</span><span class="p">)</span>

    <span class="n">string_orbital</span> <span class="o">=</span> <span class="s2">&quot;Here are the orbital energies</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">string_orbital</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">30</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">string_orbital</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">list_ev</span><span class="p">])</span>
    <span class="n">string_orbital</span> <span class="o">+=</span> <span class="s2">&quot;+&quot;</span><span class="o">*</span><span class="mi">30</span>

    <span class="c1"># show the user the orbital energies</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">string_orbital</span><span class="p">)</span>

    <span class="c1"># ask user if our guess of nip is appropriate</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">guess_nip</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;We guessed that nip should be </span><span class="si">{:d}</span><span class="s2"> is that acceptable?</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">get_yes_no_from_user</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">guess_nip</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We failed to guess a nip value&quot;</span><span class="p">)</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># if the nip value is bad then get a new value from the user</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
        <span class="n">guess_nip</span> <span class="o">=</span> <span class="n">get_integer_from_user</span><span class="p">(</span><span class="s2">&quot;Please provide an alternative nip value</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;You provided a new nip value of </span><span class="si">{:d}</span><span class="s2"> is that acceptable?</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">get_yes_no_from_user</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">guess_nip</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">guess_nip</span>


<div class="viewcode-block" id="parse_hartree_fock_output"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.parse_hartree_fock_output">[docs]</a><span class="k">def</span> <span class="nf">parse_hartree_fock_output</span><span class="p">(</span><span class="n">vibron</span><span class="p">,</span> <span class="n">execution_state</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; extracts relevant data from output of job &quot;&quot;&quot;</span>
    <span class="n">hf_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">State</span><span class="p">(</span><span class="n">execution_state</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">vibron</span><span class="o">.</span><span class="n">file_out</span><span class="p">[</span><span class="n">hf_type</span><span class="p">]</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">vibron</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="n">verify_file_exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="c1"># this could possibly be redesigned</span>
    <span class="c1"># first scf estimates the DROPMO parameter</span>
    <span class="k">if</span> <span class="n">hf_type</span> <span class="ow">is</span> <span class="s2">&quot;DROPMO&quot;</span><span class="p">:</span>
        <span class="c1"># save the estimate in the vibron object</span>
        <span class="n">vibron</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="s2">&quot;DROPMO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_estimate_dropmo</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="c1"># second scf estimates the new DROPMO parameter</span>
    <span class="c1"># and checks which orbitals to include at the optimized geometry</span>
    <span class="k">elif</span> <span class="n">hf_type</span> <span class="ow">is</span> <span class="s2">&quot;NIP&quot;</span><span class="p">:</span>
        <span class="c1"># vibron.parameter_dictionary[&quot;DROPMO&quot;] = estimate_dropmo(file_path)</span>
        <span class="n">vibron</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="s2">&quot;nip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_estimate_NIP</span><span class="p">(</span><span class="n">vibron</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Tried to call parse_hartree_fock_output &quot;</span>
             <span class="s2">&quot;with hf_type argument of </span><span class="si">{:s}</span><span class="s2"> which is not implemented&quot;</span>
             <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hf_type</span><span class="p">))</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="geometry_optimization"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.geometry_optimization">[docs]</a><span class="k">def</span> <span class="nf">geometry_optimization</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">zmat</span><span class="p">,</span> <span class="n">parameter_dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;creates and populates the input file and submission file for the job&quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">flow</span><span class="p">(</span><span class="s2">&quot;Setting up calculation&quot;</span><span class="p">)</span>

    <span class="c1"># in GB&#39;s</span>
    <span class="n">memory_size</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="c1"># file location</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">default_file_in</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="c1"># create the input file template</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">zmat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opt_zmat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;*ACES2( BASIS=</span><span class="si">{basis:s}</span><span class="s2">,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;CALC=</span><span class="si">{theory:s}</span><span class="s2">,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;MEMORY_SIZE=</span><span class="si">{:d}</span><span class="s2">GB,&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memory_size</span><span class="p">)</span>
    <span class="c1"># template += &quot;\n\t&quot; + &quot;{DROPMO:s},&quot;</span>
    <span class="k">if</span> <span class="n">zmat</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;cartesian&#39;</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;GEOM_OPT=RIC,&quot;</span>
        <span class="c1"># template += &quot;\n\t&quot; + &quot;GEOM_OPT=CART,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># populate the template using the input dictionary</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="n">parameter_dictionary</span><span class="p">)</span>

    <span class="c1"># write the input file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest_file</span><span class="p">:</span>
        <span class="n">dest_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="n">slurm_parameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;memory_size&quot;</span><span class="p">:</span> <span class="n">memory_size</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
        <span class="s2">&quot;cpus&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;work_dir&quot;</span><span class="p">:</span> <span class="n">path_root</span><span class="p">,</span>
        <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;partition&quot;</span><span class="p">:</span> <span class="n">job_boss</span><span class="o">.</span><span class="n">partition</span><span class="p">,</span>
        <span class="s2">&quot;make_scratch&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scratch_in&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scratch_out&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pre_amble&quot;</span><span class="p">:</span> <span class="s2">&quot;jobaces&quot;</span><span class="p">,</span>
        <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.in&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;post_amble&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">job_boss</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
        <span class="s2">&quot;parent_pid&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="c1"># run the job</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="n">submit_job</span><span class="p">(</span><span class="n">slurm_parameters</span><span class="p">)</span>

    <span class="n">wait_on_results</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="s2">&quot;geometry optimization&quot;</span><span class="p">)</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="n">default_file_out</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="n">verify_aces2_completed</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="parse_opt_output"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.parse_opt_output">[docs]</a><span class="k">def</span> <span class="nf">parse_opt_output</span><span class="p">(</span><span class="n">vibron</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;extract substrings describing the optimized geometry from the output file generated by a geometry optimization calculation&quot;&quot;&quot;</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">vibron</span><span class="o">.</span><span class="n">file_out</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">vibron</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="n">verify_file_exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extract_internal</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;assume that the substrings describing the geometry are in internal coordinates&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
            <span class="c1"># access the file using memory map for efficiency</span>
            <span class="k">with</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">source_file</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prot</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">PROT_READ</span><span class="p">)</span> <span class="k">as</span> <span class="n">memmap_file</span><span class="p">:</span>

                <span class="c1"># find the beginning of the important region</span>
                <span class="n">target_string</span> <span class="o">=</span> <span class="s1">&#39;Summary of optimized internal coordinates&#39;</span>
                <span class="n">begin</span> <span class="o">=</span> <span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">target_string</span><span class="p">)</span>

                <span class="c1"># go there</span>
                <span class="n">memmap_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

                <span class="c1"># throw away the headers</span>
                <span class="n">memmap_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="n">memmap_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Frequencies of the updated Hessian at convergence&quot;</span><span class="p">]:</span>
                        <span class="k">break</span>

                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="n">new_internal_geometry</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">new_internal_geometry</span>

    <span class="k">def</span> <span class="nf">extract_cartesian</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;assume that the substrings describing the geometry are in cartesian coordinates&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
            <span class="c1"># access the file using memory map for efficiency</span>
            <span class="k">with</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">source_file</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prot</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">PROT_READ</span><span class="p">)</span> <span class="k">as</span> <span class="n">memmap_file</span><span class="p">:</span>

                <span class="c1"># find the beginning of the important region</span>
                <span class="n">target_string</span> <span class="o">=</span> <span class="s1">&#39;Summary of optimized Cartesian coordinates (Ang)&#39;</span>
                <span class="n">begin</span> <span class="o">=</span> <span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">target_string</span><span class="p">)</span>

                <span class="c1"># go there</span>
                <span class="n">memmap_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

                <span class="c1"># throw away the headers</span>
                <span class="n">memmap_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="n">memmap_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Frequencies of the updated Hessian at convergence&quot;</span><span class="p">]:</span>
                        <span class="k">break</span>

                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="c1"># create list of updated geometry</span>
                <span class="n">list_of_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>

                <span class="n">new_cartesian_geometry</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">list_of_lines</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">new_cartesian_geometry</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                    <span class="n">new_cartesian_geometry</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">new_cartesian_geometry</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">new_cartesian_geometry</span>

    <span class="c1"># return optimized geometry</span>
    <span class="k">if</span> <span class="n">vibron</span><span class="o">.</span><span class="n">zmat</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="s2">&quot;internal&quot;</span><span class="p">:</span>
        <span class="n">vibron</span><span class="o">.</span><span class="n">zmat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">extract_internal</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vibron</span><span class="o">.</span><span class="n">zmat</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">extract_cartesian</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="vibrational_frequency"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.vibrational_frequency">[docs]</a><span class="k">def</span> <span class="nf">vibrational_frequency</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">zmat</span><span class="p">,</span> <span class="n">parameter_dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;creates and populates the input file and submission file for the job&quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">flow</span><span class="p">(</span><span class="s2">&quot;Setting up calculation&quot;</span><span class="p">)</span>

    <span class="c1"># in GB&#39;s</span>
    <span class="n">memory_size</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="c1"># file location</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">default_file_in</span><span class="p">[</span><span class="s2">&quot;vib&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="c1"># create the input file template</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">zmat</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;*ACES2( BASIS=</span><span class="si">{basis:s}</span><span class="s2">,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;CALC=</span><span class="si">{theory:s}</span><span class="s2">,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;MEMORY_SIZE=</span><span class="si">{:d}</span><span class="s2">GB,&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memory_size</span><span class="p">)</span>
    <span class="c1"># template += &quot;\n\t&quot; + &quot;{DROPMO:s},&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;VIB=FINDIF,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># populate the template using the input dictionary</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="n">parameter_dictionary</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest_file</span><span class="p">:</span>
        <span class="n">dest_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="n">slurm_parameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;memory_size&quot;</span><span class="p">:</span> <span class="n">memory_size</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
        <span class="s2">&quot;cpus&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;work_dir&quot;</span><span class="p">:</span> <span class="n">path_root</span><span class="p">,</span>
        <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;partition&quot;</span><span class="p">:</span> <span class="n">job_boss</span><span class="o">.</span><span class="n">partition</span><span class="p">,</span>
        <span class="s2">&quot;make_scratch&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scratch_in&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scratch_out&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pre_amble&quot;</span><span class="p">:</span> <span class="s2">&quot;jobaces&quot;</span><span class="p">,</span>
        <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.in&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;post_amble&quot;</span><span class="p">:</span> <span class="s2">&quot;fcm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">job_boss</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
        <span class="s2">&quot;parent_pid&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="c1"># run the job</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="n">submit_job</span><span class="p">(</span><span class="n">slurm_parameters</span><span class="p">)</span>

    <span class="n">wait_on_results</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="s2">&quot;vibrational frequency&quot;</span><span class="p">)</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="n">default_file_out</span><span class="p">[</span><span class="s2">&quot;vib&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="n">verify_aces2_completed</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>

    <span class="c1"># make sure the output files we expect to be present are present</span>
    <span class="c1"># verify_file_exists(join(path_root, &quot;fcmint&quot;))</span>
    <span class="c1"># verify_file_exists(join(path_root, file_name))</span>
    <span class="c1"># verify_file_exists(join(path_root, file_name))</span>
    <span class="c1"># verify_file_exists(join(path_root, file_name))</span>
    <span class="c1"># verify_file_exists(join(path_root, file_name))</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="ip_calculation"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.ip_calculation">[docs]</a><span class="k">def</span> <span class="nf">ip_calculation</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">zmat</span><span class="p">,</span> <span class="n">parameter_dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;creates and populates the input file and submission file for the job&quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">flow</span><span class="p">(</span><span class="s2">&quot;Setting up calculation&quot;</span><span class="p">)</span>

    <span class="c1"># in GB&#39;s</span>
    <span class="n">memory_size</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="c1"># file location</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">default_file_in</span><span class="p">[</span><span class="s2">&quot;ipeomcc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="s2">&quot;nip&quot;</span><span class="p">])</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="n">template</span> <span class="o">=</span> <span class="n">zmat</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;*ACES2( BASIS=</span><span class="si">{basis:s}</span><span class="s2">,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;CALC=</span><span class="si">{theory:s}</span><span class="s2">,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;MEMORY_SIZE=</span><span class="si">{:d}</span><span class="s2">GB,&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memory_size</span><span class="p">)</span>
    <span class="c1"># template += &quot;\n\t&quot; + &quot;{DROPMO:s},&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;IP_CALC=IP_EOMCC,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;*mrcc_gen&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;nip=</span><span class="si">{nip:d}</span><span class="s2">&quot;</span>
    <span class="c1"># template += &quot;\n\t&quot; + &quot;ip_low=-25&quot;</span>
    <span class="c1"># template += &quot;\n\t&quot; + &quot;ea_high=0&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;*end&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># populate the template using the input dictionary</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="n">parameter_dictionary</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest_file</span><span class="p">:</span>
        <span class="n">dest_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="n">slurm_parameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;memory_size&quot;</span><span class="p">:</span> <span class="n">memory_size</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
        <span class="s2">&quot;cpus&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;work_dir&quot;</span><span class="p">:</span> <span class="n">path_root</span><span class="p">,</span>
        <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;partition&quot;</span><span class="p">:</span> <span class="n">job_boss</span><span class="o">.</span><span class="n">partition</span><span class="p">,</span>
        <span class="s2">&quot;make_scratch&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scratch_in&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scratch_out&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pre_amble&quot;</span><span class="p">:</span> <span class="s2">&quot;jobaces&quot;</span><span class="p">,</span>
        <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.in&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;post_amble&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">job_boss</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
        <span class="s2">&quot;parent_pid&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="c1"># run the job</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="n">submit_job</span><span class="p">(</span><span class="n">slurm_parameters</span><span class="p">)</span>

    <span class="n">wait_on_results</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="s2">&quot;IP_EOM&quot;</span><span class="p">)</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="n">default_file_out</span><span class="p">[</span><span class="s2">&quot;ipeomcc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="s2">&quot;nip&quot;</span><span class="p">])</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="n">verify_aces2_completed</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="parse_ip_output"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.parse_ip_output">[docs]</a><span class="k">def</span> <span class="nf">parse_ip_output</span><span class="p">(</span><span class="n">vibron</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;extracts relevant data from output of job&quot;&quot;&quot;</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">vibron</span><span class="o">.</span><span class="n">file_out</span><span class="p">[</span><span class="s2">&quot;ipeomcc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vibron</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="s2">&quot;nip&quot;</span><span class="p">])</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">vibron</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="n">verify_file_exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">verify_percent_singles</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;read the output file from an ionization potential calculation extract the \% singles and verify they they are above a cutoff&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
            <span class="c1"># access the file using memory map for efficiency</span>
            <span class="k">with</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">source_file</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prot</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">PROT_READ</span><span class="p">)</span> <span class="k">as</span> <span class="n">memmap_file</span><span class="p">:</span>

                <span class="c1"># find the beginning and ending of the important region</span>
                <span class="n">target_begin</span> <span class="o">=</span> <span class="s1">&#39;Summary of ionization-potential eom-cc calculation&#39;</span>
                <span class="n">begin</span> <span class="o">=</span> <span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">target_begin</span><span class="p">)</span>

                <span class="c1"># go there</span>
                <span class="n">memmap_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span>

                <span class="c1"># throw away the header lines</span>
                <span class="n">past_headers</span> <span class="o">=</span> <span class="n">skip_forward_n_lines</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
                <span class="n">memmap_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">past_headers</span><span class="p">)</span>

                <span class="c1"># store the lines with the relevant information</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">line</span> <span class="ow">is</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">or</span> <span class="s2">&quot;--------&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                        <span class="k">break</span>

                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="c1"># extract the relevant information</span>
                <span class="n">percent_singles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">5</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">boolean_array</span> <span class="o">=</span> <span class="p">(</span><span class="n">percent_singles</span> <span class="o">&lt;=</span> <span class="n">vibron</span><span class="o">.</span><span class="n">singles_cutoff</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="c1"># verify that all %singles are above our cutoff point</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">boolean_array</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">return</span> <span class="kc">True</span>

                <span class="c1"># otherwise record a warning</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;We found </span><span class="si">{:d}</span><span class="s2"> states with less than </span><span class="si">{:f}</span><span class="s2">\</span><span class="si">% s</span><span class="s2">ingles&quot;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">boolean_array</span><span class="p">),</span> <span class="n">vibron</span><span class="o">.</span><span class="n">singles_cutoff</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">verify_percent_singles</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">vibron</span><span class="o">.</span><span class="n">singles_cutoff</span><span class="p">)</span></div>


<div class="viewcode-block" id="verify_ip_states"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.verify_ip_states">[docs]</a><span class="k">def</span> <span class="nf">verify_ip_states</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;run calculations to verify the range of states selected&quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">job</span><span class="o">.</span><span class="n">ip_calc</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">parse_ip_output</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;We verified that </span><span class="si">{:d}</span><span class="s2"> states had \</span><span class="si">% s</span><span class="s2">ingles above </span><span class="si">{:f}</span><span class="s2">&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="s2">&quot;nip&quot;</span><span class="p">],</span> <span class="n">job</span><span class="o">.</span><span class="n">singles_cutoff</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">state</span> <span class="ow">is</span> <span class="n">State</span><span class="o">.</span><span class="n">IPEOMCC</span><span class="p">:</span>
                <span class="n">job</span><span class="o">.</span><span class="n">advance</span><span class="p">()</span>  <span class="c1"># this is a problem</span>
            <span class="c1"># we only want to advance if we aren&#39;t already at prepVibron or vibron calc</span>
            <span class="k">break</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Reducing the nip from </span><span class="si">{:d}</span><span class="s2"> to </span><span class="si">{:d}</span><span class="s2">&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="s2">&quot;nip&quot;</span><span class="p">],</span> <span class="n">job</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="s2">&quot;nip&quot;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">job</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="s2">&quot;nip&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="s2">&quot;nip&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;We failed to get \</span><span class="si">% s</span><span class="s2">ingles above 85\% and ended up with a nip of 0&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># Don&#39;t know how to handle this right now</span>
    <span class="k">return</span></div>


<span class="k">def</span> <span class="nf">_create_template</span><span class="p">(</span><span class="n">zmat</span><span class="p">,</span> <span class="n">memory_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; wrapper for the template creation</span>
<span class="sd">    this is the most flexible way in case it needs to be changed in the future</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">zmat</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;*ACES2( BASIS=</span><span class="si">{basis:s}</span><span class="s2">,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;CALC=</span><span class="si">{theory:s}</span><span class="s2">,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;MEMORY_SIZE=</span><span class="si">{:d}</span><span class="s2">GB,&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memory_size</span><span class="p">)</span>
    <span class="c1"># template += &quot;\n\t&quot; + &quot;{DROPMO:s},&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;IP_CALC=IP_EOMCC,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;PREP_VIBRON=ON,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;GRID_VIBRON=</span><span class="si">{gridVibron:d}</span><span class="s2">,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;CC_CONV=</span><span class="si">{ccConv:d}</span><span class="s2">,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;SCF_CONV=</span><span class="si">{scfConv:d}</span><span class="s2">,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;ESTATE_TOL=</span><span class="si">{estateTol:d}</span><span class="s2">,&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;*mrcc_gen&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;nip=</span><span class="si">{nip:d}</span><span class="s2">&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;*ip_eom&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;diabatize=on&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;heff_low=0&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;heff_high=200&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;*end&quot;</span>
    <span class="n">template</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span>


<div class="viewcode-block" id="prepVibron_calculation"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.prepVibron_calculation">[docs]</a><span class="k">def</span> <span class="nf">prepVibron_calculation</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">zmat</span><span class="p">,</span> <span class="n">parameter_dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;creates and populates the input file and submission file for the job&quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">flow</span><span class="p">(</span><span class="s2">&quot;Setting up calculation&quot;</span><span class="p">)</span>

    <span class="c1"># in GB&#39;s</span>
    <span class="n">memory_size</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="c1"># file location</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">default_file_in</span><span class="p">[</span><span class="s2">&quot;prepVib&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="n">template</span> <span class="o">=</span> <span class="n">_create_template</span><span class="p">(</span><span class="n">zmat</span><span class="p">,</span> <span class="n">memory_size</span><span class="p">)</span>

    <span class="c1"># populate the template using the input dictionary</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="n">parameter_dictionary</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest_file</span><span class="p">:</span>
        <span class="n">dest_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="n">slurm_parameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;memory_size&quot;</span><span class="p">:</span> <span class="n">memory_size</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
        <span class="s2">&quot;cpus&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;work_dir&quot;</span><span class="p">:</span> <span class="n">path_root</span><span class="p">,</span>
        <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;partition&quot;</span><span class="p">:</span> <span class="n">job_boss</span><span class="o">.</span><span class="n">partition</span><span class="p">,</span>
        <span class="s2">&quot;make_scratch&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scratch_in&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scratch_out&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pre_amble&quot;</span><span class="p">:</span> <span class="s2">&quot;jobaces&quot;</span><span class="p">,</span>
        <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.in&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;post_amble&quot;</span><span class="p">:</span> <span class="s2">&quot;vibron&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">job_boss</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
        <span class="s2">&quot;parent_pid&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="c1"># run the job</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="n">submit_job</span><span class="p">(</span><span class="n">slurm_parameters</span><span class="p">)</span>

    <span class="n">wait_on_results</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="s2">&quot;preparing for vibron&quot;</span><span class="p">)</span>

    <span class="n">job_boss</span><span class="o">.</span><span class="n">check_slurm_output</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>

    <span class="n">verify_file_exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="s2">&quot;fcmfinal&quot;</span><span class="p">))</span>
    <span class="n">verify_file_exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">default_file_out</span><span class="p">[</span><span class="s2">&quot;pntheff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
    <span class="n">verify_file_exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">default_file_out</span><span class="p">[</span><span class="s2">&quot;vibronCp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
    <span class="n">verify_file_exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">default_file_out</span><span class="p">[</span><span class="s2">&quot;vibronIn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
    <span class="k">return</span></div>


<span class="k">def</span> <span class="nf">_remove_extra_heff</span><span class="p">(</span><span class="n">vibron</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">target_string</span><span class="o">=</span><span class="s1">&#39;HEFF_IP2&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;remove non relevant data from output files kind argument does nothing at the moment&quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">vibron</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
    <span class="c1"># access the file using memory map for efficiency</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">source_file</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">memmap_file</span><span class="p">:</span>
            <span class="c1"># store the original file size</span>
            <span class="n">size_original</span> <span class="o">=</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">size_original</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">target_string</span><span class="p">)</span>

            <span class="c1"># find the first occurrence of the target_string</span>
            <span class="n">start_in_bytes</span> <span class="o">=</span> <span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">target_string</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start_in_bytes</span><span class="p">)</span>
            <span class="c1"># get the byte location of the start of the line</span>
            <span class="n">start_in_bytes</span> <span class="o">=</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">start_in_bytes</span><span class="p">)</span>
            <span class="c1"># we want to ignore that newline character however</span>
            <span class="n">start_in_bytes</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">start_in_bytes</span><span class="p">)</span>

            <span class="c1"># get the EOF location in numBytes</span>
            <span class="n">memmap_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
            <span class="n">end_of_file_in_bytes</span> <span class="o">=</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">end_of_file_in_bytes</span><span class="p">)</span>

            <span class="c1"># the length of our source</span>
            <span class="n">length_in_bytes</span> <span class="o">=</span> <span class="n">end_of_file_in_bytes</span> <span class="o">-</span> <span class="n">start_in_bytes</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">length_in_bytes</span><span class="p">)</span>

            <span class="c1"># copy the file, resize it and write the change to disk</span>
            <span class="n">memmap_file</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_in_bytes</span><span class="p">,</span> <span class="n">length_in_bytes</span><span class="p">)</span>
            <span class="n">memmap_file</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">length_in_bytes</span><span class="p">)</span>
            <span class="n">memmap_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="c1"># # store the original file size</span>
            <span class="c1"># size_original = memmap_file.size()</span>

            <span class="c1"># # find the beginning and ending of the important region</span>
            <span class="c1"># destStart = find_string_in_file(memmap_file, file_path, target_string)</span>
            <span class="c1"># destEnd = rfind_string_in_file(memmap_file, file_path, target_string)</span>
            <span class="c1"># log.debug(destStart, destEnd)</span>

            <span class="c1"># # find the byte location of the end of the line</span>
            <span class="c1"># destStart = memmap_file.rfind(b&#39;\n&#39;, 0, destStart)</span>
            <span class="c1"># destEnd = memmap_file.find(b&#39;\n&#39;, destEnd)</span>
            <span class="c1"># log.debug(destStart, destEnd)</span>

            <span class="c1"># # if we can&#39;t find a newline character</span>
            <span class="c1"># # that means the substring was found</span>
            <span class="c1"># # in the first line of the file</span>
            <span class="c1"># if destStart == -1:</span>
            <span class="c1">#     destStart = 0</span>

            <span class="c1"># destEnd += 1</span>
            <span class="c1"># log.debug(destStart, destEnd)</span>

            <span class="c1"># # find the start of the section to copy</span>
            <span class="c1"># start_in_bytes = memmap_file.find(b&#39;HEFF_IP2&#39;, destEnd)</span>
            <span class="c1"># log.debug(start_in_bytes)</span>

            <span class="c1"># # get the location of the beginning of the line</span>
            <span class="c1"># start_in_bytes = memmap_file.rfind(b&#39;\n&#39;, 0, start_in_bytes)</span>
            <span class="c1"># log.debug(start_in_bytes)</span>

            <span class="c1"># # get the EOF location in numBytes</span>
            <span class="c1"># memmap_file.seek(0, os.SEEK_END)</span>
            <span class="c1"># EOF = memmap_file.tell()</span>

            <span class="c1"># # check file sizes</span>
            <span class="c1"># destLength = destEnd - destStart</span>
            <span class="c1"># length_in_bytes = EOF - start_in_bytes</span>

            <span class="c1"># log.debug(memmap_file.size(), EOF)</span>
            <span class="c1"># log.debug(destStart, start_in_bytes, length_in_bytes)</span>
            <span class="c1"># log.debug(size_original - destLength)</span>

            <span class="c1"># memmap_file.move(destStart, start_in_bytes, length_in_bytes)</span>
            <span class="c1"># memmap_file.resize(size_original - destLength)</span>
            <span class="c1"># memmap_file.flush()</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">_copy_output_file</span><span class="p">(</span><span class="n">vibron</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; verifies source file exists before copying it to destination  &quot;&quot;&quot;</span>
    <span class="n">path_source</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">vibron</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
    <span class="n">verify_file_exists</span><span class="p">(</span><span class="n">path_source</span><span class="p">)</span>
    <span class="n">path_destination</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">vibron</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">path_source</span><span class="p">,</span> <span class="n">path_destination</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">_add_nip_to_file</span><span class="p">(</span><span class="n">vibron</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; modify file to contain the nip &quot;&quot;&quot;</span>
    <span class="n">nip</span> <span class="o">=</span> <span class="n">vibron</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="s2">&quot;nip&quot;</span><span class="p">]</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">vibron</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">destFile</span><span class="p">:</span>
        <span class="c1"># access the file using memory map for efficiency</span>
        <span class="k">with</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">destFile</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">memmap_file</span><span class="p">:</span>

            <span class="c1"># we assume that there is only one &#39;xxx&#39; substring in the whole file</span>
            <span class="n">startTarget</span> <span class="o">=</span> <span class="s1">&#39;xxx&#39;</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">find_string_in_file</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">startTarget</span><span class="p">)</span>
            <span class="c1"># go there</span>
            <span class="n">memmap_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&gt;6,d}</span><span class="s2">&quot;</span>
            <span class="c1"># attempt to write 3 bytes over the &#39;xxx&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bytesWritten</span> <span class="o">=</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nip</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">((</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)))</span>
                <span class="c1"># make sure we wrote the right amount</span>
                <span class="k">assert</span> <span class="n">bytesWritten</span> <span class="o">==</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;incorrect number of bytes written to file </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="n">memmap_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>  <span class="c1"># write the changes from memory to disk</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Failed to write the nip=</span><span class="si">{:d}</span><span class="s2"> to </span><span class="si">{:s}</span><span class="s2">&quot;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nip</span><span class="p">,</span> <span class="n">file_path</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">e</span>    <span class="c1"># 1</span>
    <span class="k">return</span>


<div class="viewcode-block" id="parse_prepVibron_output"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.parse_prepVibron_output">[docs]</a><span class="k">def</span> <span class="nf">parse_prepVibron_output</span><span class="p">(</span><span class="n">vibron</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;extracts relevant data from output of job&quot;&quot;&quot;</span>

    <span class="n">src</span> <span class="o">=</span> <span class="n">vibron</span><span class="o">.</span><span class="n">file_out</span><span class="p">[</span><span class="s2">&quot;pntheff&quot;</span><span class="p">]</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="s2">&quot;PNTHEFF&quot;</span>
    <span class="n">_copy_output_file</span><span class="p">(</span><span class="n">vibron</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    <span class="n">_remove_extra_heff</span><span class="p">(</span><span class="n">vibron</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    <span class="c1"># _remove_extra_heff(vibron, dst, &#39;HEFF_0&#39;)</span>

    <span class="n">src</span> <span class="o">=</span> <span class="n">vibron</span><span class="o">.</span><span class="n">file_out</span><span class="p">[</span><span class="s2">&quot;vibronCp&quot;</span><span class="p">]</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">vibron</span><span class="o">.</span><span class="n">file_in</span><span class="p">[</span><span class="s2">&quot;vibronCp&quot;</span><span class="p">]</span>
    <span class="n">_copy_output_file</span><span class="p">(</span><span class="n">vibron</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    <span class="n">_remove_extra_heff</span><span class="p">(</span><span class="n">vibron</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    <span class="c1"># _remove_extra_heff(vibron, dst, &#39;Heff_0&#39;)</span>

    <span class="n">src</span> <span class="o">=</span> <span class="n">vibron</span><span class="o">.</span><span class="n">file_out</span><span class="p">[</span><span class="s2">&quot;vibronIn&quot;</span><span class="p">]</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">vibron</span><span class="o">.</span><span class="n">file_in</span><span class="p">[</span><span class="s2">&quot;vibronIn&quot;</span><span class="p">]</span>
    <span class="n">_copy_output_file</span><span class="p">(</span><span class="n">vibron</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    <span class="n">_add_nip_to_file</span><span class="p">(</span><span class="n">vibron</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="vibron_calculation"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.vibron_calculation">[docs]</a><span class="k">def</span> <span class="nf">vibron_calculation</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">zmat</span><span class="p">,</span> <span class="n">parameter_dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;creates and populates the input file and submission file for the job&quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">flow</span><span class="p">(</span><span class="s2">&quot;Setting up calculation&quot;</span><span class="p">)</span>

    <span class="c1"># in GB&#39;s</span>
    <span class="n">memory_size</span> <span class="o">=</span> <span class="mi">15</span>

    <span class="c1"># file location</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">default_file_in</span><span class="p">[</span><span class="s2">&quot;vibronIn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="n">slurm_parameters</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;memory_size&quot;</span><span class="p">:</span> <span class="n">memory_size</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
        <span class="s2">&quot;cpus&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;work_dir&quot;</span><span class="p">:</span> <span class="n">path_root</span><span class="p">,</span>
        <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;partition&quot;</span><span class="p">:</span> <span class="n">job_boss</span><span class="o">.</span><span class="n">partition</span><span class="p">,</span>
        <span class="s2">&quot;make_scratch&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scratch_in&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scratch_out&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pre_amble&quot;</span><span class="p">:</span> <span class="s2">&quot;jobvibron&quot;</span><span class="p">,</span>
        <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.in&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;post_amble&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">job_boss</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
        <span class="s2">&quot;parent_pid&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="c1"># run the job</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="n">submit_job</span><span class="p">(</span><span class="n">slurm_parameters</span><span class="p">)</span>

    <span class="n">wait_on_results</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="s2">&quot;VIBRON&quot;</span><span class="p">)</span>

    <span class="n">job_boss</span><span class="o">.</span><span class="n">check_slurm_output</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="parse_vibron_output"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.parse_vibron_output">[docs]</a><span class="k">def</span> <span class="nf">parse_vibron_output</span><span class="p">(</span><span class="n">vibron</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;extracts relevant data from output of job&quot;&quot;&quot;</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">vibron</span><span class="o">.</span><span class="n">file_out</span><span class="p">[</span><span class="s2">&quot;vibron&quot;</span><span class="p">]</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">vibron</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="n">verify_file_exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="n">final_string</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;All done in main_vibron&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">source_file</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prot</span><span class="o">=</span><span class="n">mmap</span><span class="o">.</span><span class="n">PROT_READ</span><span class="p">)</span> <span class="k">as</span> <span class="n">memmap_file</span><span class="p">:</span>
            <span class="c1"># the target string should be in the last couple lines of the file</span>
            <span class="c1"># first we find the byte location of the beginning of the 10th last line</span>
            <span class="n">ten_lines_back</span> <span class="o">=</span> <span class="n">skip_back_n_lines</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">memmap_file</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># then we search from there to the end of the file for our target string</span>
            <span class="k">if</span> <span class="n">memmap_file</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">final_string</span><span class="p">,</span> <span class="n">ten_lines_back</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># if we don&#39;t find it then the calculation was a failure</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;The vibron calculation failed to successfully complete&quot;</span>\
                  <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Check output file </span><span class="si">{:s}</span><span class="s2">&quot;</span>
                <span class="c1"># log.error(s.format(file_path))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;vibron calculation successfully completed!&quot;</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="ZmatClass"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.ZmatClass">[docs]</a><span class="k">class</span> <span class="nc">ZmatClass</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;handles all details related to zmat file which represents the geometry of the molecule can hold internal or cartesian coordinates&quot;&quot;&quot;</span>

    <span class="n">kind</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cartesian&quot;</span><span class="p">,</span> <span class="s2">&quot;internal&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># string that holds the relational ZMAT info</span>
    <span class="c1"># in internal coordinates (without the bond/angle values)</span>
    <span class="n">_internal</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># dictionary that holds the coordinate bond/angle values</span>
    <span class="c1"># for internal coordinates type of ZMAT</span>
    <span class="n">_coord</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># string that holds the relational ZMAT info</span>
    <span class="c1"># in cartesian coordinates</span>
    <span class="n">_cartesian</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="n">verify_file_exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># parse file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
            <span class="c1"># make sure there is at least one newline at the end</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">source_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="c1"># determine which coordinates are used in the ZMAT</span>
            <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;internal&quot;</span>

            <span class="c1"># process the input</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="s2">&quot;internal&quot;</span><span class="p">:</span>
                <span class="c1"># split along the blank line</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># this is the relational ZMAT info</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_internal</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

                <span class="c1"># create a dictionary that maps the angles/bonds to their values</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coord</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()])</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="s2">&quot;cartesian&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cartesian</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Invalid ZMAT file located at </span><span class="si">{:s}</span><span class="s2">&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>

        <span class="k">return</span>

<div class="viewcode-block" id="ZmatClass.get"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.ZmatClass.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt_zmat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns a string which represents the coordinates&quot;&quot;&quot;</span>

        <span class="c1"># creates a string from zmat and self.coord</span>
        <span class="c1"># that represents a valid ZMAT file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="s2">&quot;internal&quot;</span><span class="p">:</span>
            <span class="n">completeZMAT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="c1"># if we aren&#39;t optimizing then remove the asterisks</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">opt_zmat</span><span class="p">:</span>
                <span class="n">completeZMAT</span> <span class="o">=</span> <span class="n">completeZMAT</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># add the geometry values</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coord</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">completeZMAT</span> <span class="o">+=</span> <span class="n">key</span><span class="o">+</span><span class="s2">&quot;=&quot;</span><span class="o">+</span><span class="n">value</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="c1"># need a blank line coordinate list</span>
            <span class="n">completeZMAT</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="n">completeZMAT</span>

        <span class="c1"># no modification is needed for the cartesian version</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="s2">&quot;cartesian&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cartesian</span></div>

<div class="viewcode-block" id="ZmatClass.set"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.ZmatClass.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry_new</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;updates geometry data&quot;&quot;&quot;</span>

        <span class="c1"># just update the dict values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="s2">&quot;internal&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">geometry_new</span><span class="p">)</span>

        <span class="c1"># special treatment is necessary</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="s2">&quot;cartesian&quot;</span><span class="p">:</span>
            <span class="n">geometry_new</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">geometry_new</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
            <span class="n">geometry_old</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cartesian</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">geometry_old</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">geometry_new</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cartesian</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">geometry_new</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>

            <span class="k">elif</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">geometry_new</span><span class="p">)):</span>
                    <span class="n">geometry_old</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">diff</span><span class="p">]</span> <span class="o">=</span> <span class="n">geometry_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_cartesian</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">geometry_old</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;The new geometries have MORE? atoms than before???&quot;</span>\
                  <span class="o">+</span> <span class="s2">&quot;Old geometry</span><span class="se">\n</span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">New Geometry</span><span class="se">\n</span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cartesian</span><span class="p">,</span> <span class="n">geometry_new</span><span class="p">))</span>

            <span class="k">return</span>

        <span class="k">return</span></div></div>


<div class="viewcode-block" id="VibronExecutionClass"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.VibronExecutionClass">[docs]</a><span class="k">class</span> <span class="nc">VibronExecutionClass</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;handles all details related to the execution&quot;&quot;&quot;</span>

    <span class="c1"># the molecule of interest</span>
    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># ZmatClass object that contains the ZMAT information</span>
    <span class="n">zmat</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># the directory in which we execute jobs</span>
    <span class="n">path_root</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># parameters</span>
    <span class="n">parameter_dictionary</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;calculation&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;theory&quot;</span><span class="p">:</span>      <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;basis&quot;</span><span class="p">:</span>       <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;DROPMO&quot;</span><span class="p">:</span>      <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NIP&quot;</span><span class="p">:</span>         <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;gridVibron&quot;</span><span class="p">:</span>  <span class="mi">3</span><span class="p">,</span>  <span class="c1"># or 4</span>
        <span class="s2">&quot;ccConv&quot;</span><span class="p">:</span>      <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;scfConv&quot;</span><span class="p">:</span>     <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;estateTol&quot;</span><span class="p">:</span>   <span class="mi">10</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">file_in</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">file_out</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># our cut off for % singles</span>
    <span class="n">singles_cutoff</span> <span class="o">=</span> <span class="mf">85.00</span>

    <span class="c1"># our cut off for % triples</span>
    <span class="n">triples_cutoff</span> <span class="o">=</span> <span class="mf">92.00</span>

    <span class="c1"># State enum that corresponds to location in execution workflow</span>
    <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_root</span> <span class="o">=</span> <span class="n">root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_in</span> <span class="o">=</span> <span class="n">default_file_in</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_out</span> <span class="o">=</span> <span class="n">default_file_out</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_state</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="n">name_of_state_file</span><span class="p">)</span>

        <span class="c1"># fill in names</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_in</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_in</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_out</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
        <span class="k">return</span>

<div class="viewcode-block" id="VibronExecutionClass.record_state"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.VibronExecutionClass.record_state">[docs]</a>    <span class="k">def</span> <span class="nf">record_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_state</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_state</span><span class="p">:</span>
            <span class="n">string_state</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">file_state</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_state</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="VibronExecutionClass.advance"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.VibronExecutionClass.advance">[docs]</a>    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;increase state counter and log it IF not already at the highest state&quot;&quot;&quot;</span>
        <span class="c1"># create state file if it doesn&#39;t exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_state</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;State file </span><span class="si">{:s}</span><span class="s2"> doesn&#39;t exist, creating a blank file&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_state</span><span class="p">))</span>
            <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_state</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">record_state</span><span class="p">()</span>

        <span class="c1"># advance or write down that we are complete</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">FINISHED</span><span class="p">:</span>
            <span class="c1"># we have finished!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_state</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">State</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="n">old_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">old_state</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Advancing from state </span><span class="si">{:s}</span><span class="s2"> to state </span><span class="si">{:s}</span><span class="s2">&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This code should not be executed&quot;</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="VibronExecutionClass.setup_zmat"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.VibronExecutionClass.setup_zmat">[docs]</a>    <span class="k">def</span> <span class="nf">setup_zmat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;assumes that you formatted the ZMAT file correctly&quot;&quot;&quot;</span>
        <span class="c1"># Default is to assume parameter file is in /path_root/*</span>
        <span class="k">if</span> <span class="n">file_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span>
                             <span class="c1"># &quot;parameters&quot;,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">file_in</span><span class="p">[</span><span class="s2">&quot;zmat&quot;</span><span class="p">]</span>
                             <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zmat</span> <span class="o">=</span> <span class="n">ZmatClass</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_set_state_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; sets self.state to the value stored in the file located at self.path_state</span>
<span class="sd">        if the file is empty it defaults to the initial state State.min()&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting to set state using state file&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_state</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;State file </span><span class="si">{:s}</span><span class="s2"> is empty, defaulting to initial State&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_state</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="k">return</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_state</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_state</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">file_state</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>

            <span class="c1"># I believe there is a cleaner way to do this, should clean this up</span>
            <span class="c1"># low priority</span>
            <span class="k">if</span> <span class="n">line</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">old_state</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">old_state</span> <span class="o">==</span> <span class="n">State</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">max</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

            <span class="k">elif</span> <span class="n">old_state</span> <span class="ow">in</span> <span class="n">State</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">State</span><span class="p">(</span><span class="n">old_state</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">State</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">member</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">member</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;State file </span><span class="si">{:s}</span><span class="s2"> contained an invalid state: </span><span class="si">{:s}</span><span class="s2">&quot;</span>
                     <span class="s2">&quot;Defaulting to initial state&quot;</span>
                     <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_state</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                <span class="k">break</span>

        <span class="k">return</span>

<div class="viewcode-block" id="VibronExecutionClass.parse_input_parameters"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.VibronExecutionClass.parse_input_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">parse_input_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;loads data into the object&quot;&quot;&quot;</span>
        <span class="c1"># Default is to assume parameter file is in /path_root/*</span>
        <span class="k">if</span> <span class="n">file_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span>
                             <span class="c1"># &quot;parameters&quot;,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">file_in</span><span class="p">[</span><span class="s2">&quot;parameter&quot;</span><span class="p">]</span>
                             <span class="p">)</span>

        <span class="c1"># attempt to read in file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">verify_file_exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">source_file</span><span class="p">:</span>
                    <span class="c1"># if line is not blank AND is not a comment</span>
                    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">^</span> <span class="nb">bool</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)):</span>
                        <span class="n">header</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">header</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Header </span><span class="si">{:s}</span><span class="s2"> is not valid</span><span class="se">\n</span><span class="s2"> Check that your </span><span class="si">{:s}</span><span class="s2"> has the correct formatting&quot;</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">file_path</span><span class="p">))</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="n">header</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">error_object</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error_object</span>

        <span class="c1"># check the validity of the parameter file</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">basis_list</span><span class="p">,</span> <span class="s2">&quot;invalid parameter provided for basis&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="s2">&quot;theory&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">theory_list</span><span class="p">,</span> <span class="s2">&quot;invalid parameter provided for theory&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">[</span><span class="s2">&quot;calculation&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">calculations_list</span><span class="p">,</span> <span class="s2">&quot;invalid parameter provided for calculation&quot;</span>

        <span class="c1"># create state file if it doesn&#39;t exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_state</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;State file </span><span class="si">{:s}</span><span class="s2"> doesn&#39;t exist, creating a blank file&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_state</span><span class="p">))</span>
            <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_state</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># retrieve the previous state which was saved</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_state_from_file</span><span class="p">()</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="VibronExecutionClass.hf"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.VibronExecutionClass.hf">[docs]</a>    <span class="k">def</span> <span class="nf">hf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matching_state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;wrapper method&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">matching_state</span><span class="p">:</span>
            <span class="n">hartree_fock_calculation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmat</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">advance</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="VibronExecutionClass.geom"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.VibronExecutionClass.geom">[docs]</a>    <span class="k">def</span> <span class="nf">geom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;wrapper method&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">OPT</span><span class="p">:</span>
            <span class="n">geometry_optimization</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">advance</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="VibronExecutionClass.vib"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.VibronExecutionClass.vib">[docs]</a>    <span class="k">def</span> <span class="nf">vib</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;wrapper method&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">VIB</span><span class="p">:</span>
            <span class="n">vibrational_frequency</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">advance</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="VibronExecutionClass.ip_calc"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.VibronExecutionClass.ip_calc">[docs]</a>    <span class="k">def</span> <span class="nf">ip_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;wrapper method&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">IPEOMCC</span><span class="p">:</span>
            <span class="n">ip_calculation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="VibronExecutionClass.prepVibron"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.VibronExecutionClass.prepVibron">[docs]</a>    <span class="k">def</span> <span class="nf">prepVibron</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;wrapper method&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">PREPVIB</span><span class="p">:</span>
            <span class="n">prepVibron_calculation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">advance</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="VibronExecutionClass.vibron_calc"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.VibronExecutionClass.vibron_calc">[docs]</a>    <span class="k">def</span> <span class="nf">vibron_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;wrapper method&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">State</span><span class="o">.</span><span class="n">VIBRON</span><span class="p">:</span>
            <span class="n">vibron_calculation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_dictionary</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">advance</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="VibronExecutionClass.calculate_vibronic_model"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.VibronExecutionClass.calculate_vibronic_model">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_vibronic_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># prepare signal handler - this is used to synchronize with the submitted jobs</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="n">job_boss</span><span class="o">.</span><span class="n">SIGUSR1_handle</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parse_input_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_zmat</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">State</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="c1"># self.hf(State.DROPMO)</span>
            <span class="c1"># parse_hartree_fock_output(self, State.DROPMO)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">geom</span><span class="p">()</span>
            <span class="n">parse_opt_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hf</span><span class="p">(</span><span class="n">State</span><span class="o">.</span><span class="n">NIP</span><span class="p">)</span>
            <span class="n">parse_hartree_fock_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">State</span><span class="o">.</span><span class="n">NIP</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">vib</span><span class="p">()</span>

            <span class="n">verify_ip_states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">prepVibron</span><span class="p">()</span>
            <span class="n">parse_prepVibron_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">vibron_calc</span><span class="p">()</span>
            <span class="n">parse_vibron_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">advance</span><span class="p">()</span>  <span class="c1"># important to do after parsing vibron_output</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;We have reached the end of execution.&quot;</span><span class="p">)</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="test_one"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.test_one">[docs]</a><span class="k">def</span> <span class="nf">test_one</span><span class="p">(</span><span class="n">molecule_name</span><span class="o">=</span><span class="s2">&quot;ch2o&quot;</span><span class="p">,</span> <span class="n">inital_job_state</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;runs the job in the current directory stores results in folder named by the molecule&quot;&quot;&quot;</span>

    <span class="c1"># create execution directory</span>
    <span class="n">path_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="n">path_root</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span>  <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">job</span> <span class="o">=</span> <span class="n">VibronExecutionClass</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">,</span> <span class="n">path_root</span><span class="p">,</span> <span class="n">inital_job_state</span><span class="p">)</span>
    <span class="n">job</span><span class="o">.</span><span class="n">calculate_vibronic_model</span><span class="p">()</span>
    <span class="k">return</span></div>


<span class="c1"># need a better naming - distinguishing scheme between</span>
<span class="c1"># build_vibronic_model and calculate_vibronic_model</span>
<div class="viewcode-block" id="calculate_vibronic_model_wrapper_one"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.calculate_vibronic_model_wrapper_one">[docs]</a><span class="k">def</span> <span class="nf">calculate_vibronic_model_wrapper_one</span><span class="p">(</span><span class="n">data_set_num</span><span class="p">,</span> <span class="n">molecule_name</span><span class="o">=</span><span class="s2">&quot;ch2o&quot;</span><span class="p">,</span> <span class="n">inital_job_state</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;executes jobs using exists data_set_# file structure&quot;&quot;&quot;</span>

    <span class="c1"># create execution directory</span>
    <span class="n">path_root</span> <span class="o">=</span> <span class="s1">&#39;/work/ngraymon/pimc/data_set_</span><span class="si">{:d}</span><span class="s1">/electronic_structure/&#39;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_root</span><span class="p">,</span>  <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">job</span> <span class="o">=</span> <span class="n">VibronExecutionClass</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">,</span> <span class="n">path_root</span><span class="p">,</span> <span class="n">inital_job_state</span><span class="p">)</span>
    <span class="n">job</span><span class="o">.</span><span class="n">calculate_vibronic_model</span><span class="p">()</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.electronic_structure.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># we provide a specific named file</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="ow">is</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">test_one</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># we provide a specific named file</span>
    <span class="c1"># and we provide a integer parameter</span>
    <span class="c1"># which indicates what stage of the calculation to start at</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="ow">is</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">test_one</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">test_one</span><span class="p">()</span></div>


<span class="k">if</span> <span class="p">(</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">):</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Pibronic</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pibronic.html">pibronic package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Neil Raymond.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>