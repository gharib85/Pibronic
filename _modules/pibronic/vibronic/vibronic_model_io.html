
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pibronic.vibronic.vibronic_model_io &#8212; Pibronic 0.3.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pibronic.vibronic.vibronic_model_io</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;vibronic_model_io.py should handle the majority of file I/O&quot;&quot;&quot;</span>

<span class="c1"># system imports</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">isfile</span>

<span class="c1"># third party imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">float64</span> <span class="k">as</span> <span class="n">F64</span>

<span class="c1"># local imports</span>
<span class="kn">from</span> <span class="nn">..log_conf</span> <span class="k">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">.vibronic_model_keys</span> <span class="k">import</span> <span class="n">VibronicModelKeys</span> <span class="k">as</span> <span class="n">VMK</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">model_op</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">model_h</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">orthonormal</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">model_auto</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="n">ModuleNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">_FakeModule</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">read_model_auto_file</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;fortranformat not installed, cannot call read_model_auto_file() from model_auto&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="n">model_auto</span> <span class="o">=</span> <span class="n">_FakeModule</span><span class="p">()</span>


<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Print Precision!</span>

<span class="c1"># TODO - made the design decision that if a key is not present in the json file that implies all the values are zero</span>
<span class="c1"># - need to make sure this is enforced across all the code</span>


<div class="viewcode-block" id="model_shape_dict"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.model_shape_dict">[docs]</a><span class="k">def</span> <span class="nf">model_shape_dict</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns a dictionary with the same keys as the .json file whose values are tuples representing the dimensionality of the associated value in the .json file</span>
<span class="sd">    Takes A - number of surfaces and N - number of modes</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">:</span>  <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">w</span><span class="p">:</span>  <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">:</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G2</span><span class="p">:</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G3</span><span class="p">:</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G4</span><span class="p">:</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span>
                  <span class="p">}</span>

    <span class="k">return</span> <span class="n">dictionary</span></div>


<div class="viewcode-block" id="diagonal_model_shape_dict"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.diagonal_model_shape_dict">[docs]</a><span class="k">def</span> <span class="nf">diagonal_model_shape_dict</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns a dictionary with the same keys as the .json file whose values are tuples representing the dimensionality of the associated value in the .json file</span>
<span class="sd">    Takes A - number of surfaces and N - number of modes</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">:</span>  <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">w</span><span class="p">:</span>  <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">:</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G2</span><span class="p">:</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G3</span><span class="p">:</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G4</span><span class="p">:</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span>
                  <span class="p">}</span>

    <span class="k">return</span> <span class="n">dictionary</span></div>


<span class="k">def</span> <span class="nf">_array_is_symmetric_in_A</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Boolean function that returns true if the provided numpy array is symmetric in the surface dimension</span>
<span class="sd">    where the surface dimensions (A) are by convention the last two dimensions</span>
<span class="sd">    this function assumes that the array is properly formatted</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">ndim</span><span class="p">))</span>
    <span class="c1"># swap the last two dimensions, which by convention are the surface dimensions</span>
    <span class="n">new_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">new_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">new_dims</span><span class="p">))</span>


<div class="viewcode-block" id="model_parameters_are_symmetric_in_surfaces"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.model_parameters_are_symmetric_in_surfaces">[docs]</a><span class="k">def</span> <span class="nf">model_parameters_are_symmetric_in_surfaces</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Boolean function that returns true if the provided model&#39;s arrays are all symmetric in the surface dimension</span>
<span class="sd">    where the surface dimensions (A) are by convention the last two dimensions</span>
<span class="sd">    this function assumes that the arrays is properly formatted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">verify_model_parameters</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_array_is_symmetric_in_A</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{key}</span><span class="s2"> not symmetric in surfaces&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="model_parameters_are_symmetric_in_modes"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.model_parameters_are_symmetric_in_modes">[docs]</a><span class="k">def</span> <span class="nf">model_parameters_are_symmetric_in_modes</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Boolean function that returns true if the provided model&#39;s quadratic and quartic arrays are symmetric in their mode dimensions</span>
<span class="sd">    this is a bit trickier than the surface dimension</span>
<span class="sd">    this function assumes that the arrays is properly formatted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">verify_model_parameters</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># do the quadratic case</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">VMK</span><span class="o">.</span><span class="n">G2</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">new_dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span><span class="p">))</span>
        <span class="n">new_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">new_dims</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># I don&#39;t think there is a general approach for the cubic case</span>

    <span class="c1"># do the quartic case</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">VMK</span><span class="o">.</span><span class="n">G4</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">new_dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span><span class="p">))</span>
        <span class="n">new_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">new_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">new_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dims</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">new_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">new_dims</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="model_zeros_template_json_dict"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.model_zeros_template_json_dict">[docs]</a><span class="k">def</span> <span class="nf">model_zeros_template_json_dict</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns a dictionary that is a valid model, where all values (other than states and modes) are set to 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">model_shape_dict</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">N</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">A</span><span class="p">:</span> <span class="n">A</span><span class="p">,</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">w</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G3</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G4</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">),</span>
                  <span class="p">}</span>

    <span class="k">return</span> <span class="n">dictionary</span></div>


<div class="viewcode-block" id="diagonal_model_zeros_template_json_dict"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.diagonal_model_zeros_template_json_dict">[docs]</a><span class="k">def</span> <span class="nf">diagonal_model_zeros_template_json_dict</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns a dictionary that is a valid diagonal model, where all values (other than states and modes) are set to 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">diagonal_model_shape_dict</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">N</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">A</span><span class="p">:</span> <span class="n">A</span><span class="p">,</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">w</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G3</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">),</span>
                  <span class="n">VMK</span><span class="o">.</span><span class="n">G4</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">),</span>
                  <span class="p">}</span>

    <span class="k">return</span> <span class="n">dictionary</span></div>


<div class="viewcode-block" id="verify_model_parameters"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.verify_model_parameters">[docs]</a><span class="k">def</span> <span class="nf">verify_model_parameters</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;make sure the provided model parameters follow the file conventions&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">VMK</span><span class="o">.</span><span class="n">N</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;need the number of modes&quot;</span>
    <span class="k">assert</span> <span class="n">VMK</span><span class="o">.</span><span class="n">A</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;need the number of surfaces&quot;</span>

    <span class="n">A</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">_extract_dimensions_from_dictionary</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">shape_dict</span> <span class="o">=</span> <span class="n">model_shape_dict</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">shape_dict</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">shape_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{key}</span><span class="s2"> have incorrect shape&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Found key </span><span class="si">{key}</span><span class="s2"> which is not present in the default dictionary&quot;</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="verify_diagonal_model_parameters"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.verify_diagonal_model_parameters">[docs]</a><span class="k">def</span> <span class="nf">verify_diagonal_model_parameters</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;make sure the provided sample parameters follow the file conventions&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">VMK</span><span class="o">.</span><span class="n">N</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;need the number of modes&quot;</span>
    <span class="k">assert</span> <span class="n">VMK</span><span class="o">.</span><span class="n">A</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s2">&quot;need the number of surfaces&quot;</span>

    <span class="n">A</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">_extract_dimensions_from_dictionary</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">shape_dict</span> <span class="o">=</span> <span class="n">diagonal_model_shape_dict</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">shape_dict</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">shape_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{key}</span><span class="s2"> have incorrect shape&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Found key </span><span class="si">{key}</span><span class="s2"> which is not present in the default dictionary&quot;</span><span class="p">)</span>

    <span class="k">return</span></div>


<span class="k">def</span> <span class="nf">_same_model</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns True if all parameters of the two dictionaries have the same dimensions</span>
<span class="sd">    and the same floating point numbers up to standard precision comparison</span>
<span class="sd">    raises an assertion error if either dictionary has incorrect parameters&quot;&quot;&quot;</span>

    <span class="n">verify_model_parameters</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
    <span class="n">verify_model_parameters</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>

    <span class="n">A1</span><span class="p">,</span> <span class="n">N1</span> <span class="o">=</span> <span class="n">_extract_dimensions_from_dictionary</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
    <span class="n">A2</span><span class="p">,</span> <span class="n">N2</span> <span class="o">=</span> <span class="n">_extract_dimensions_from_dictionary</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">A1</span> <span class="o">!=</span> <span class="n">A2</span> <span class="ow">or</span> <span class="n">N1</span> <span class="o">!=</span> <span class="n">N2</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">new_d1</span> <span class="o">=</span> <span class="n">model_zeros_template_json_dict</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">N1</span><span class="p">)</span>
    <span class="n">new_d1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>

    <span class="n">new_d2</span> <span class="o">=</span> <span class="n">model_zeros_template_json_dict</span><span class="p">(</span><span class="n">A2</span><span class="p">,</span> <span class="n">N2</span><span class="p">)</span>
    <span class="n">new_d2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_d1</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">new_d1</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">new_d2</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;These models differ for key </span><span class="si">{key}</span><span class="se">\n</span><span class="s2">d1: </span><span class="si">{new_d1[key]}</span><span class="se">\n</span><span class="s2">d2: </span><span class="si">{new_d2[key]}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># elif (key not in d2 and np.count_nonzero(d1[key]) &gt; 0) or \</span>
        <span class="c1">#      (key not in d1 and np.count_nonzero(d2[key]) &gt; 0):</span>
        <span class="c1">#     print(f&quot;These models differ for key {key}\nd1: {d1[key]}\nd2: {d2[key]}&quot;)</span>
        <span class="c1">#     return False</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This line of code should not be reached!?&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_same_diagonal_model</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns True if all parameters of the two dictionaries have the same dimensions</span>
<span class="sd">    and the same floating point numbers up to standard precision comparison</span>
<span class="sd">    raises an assertion error if either dictionary has incorrect parameters&quot;&quot;&quot;</span>

    <span class="n">verify_diagonal_model_parameters</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
    <span class="n">verify_diagonal_model_parameters</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>

    <span class="n">A1</span><span class="p">,</span> <span class="n">N1</span> <span class="o">=</span> <span class="n">_extract_dimensions_from_dictionary</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
    <span class="n">A2</span><span class="p">,</span> <span class="n">N2</span> <span class="o">=</span> <span class="n">_extract_dimensions_from_dictionary</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">A1</span> <span class="o">!=</span> <span class="n">A2</span> <span class="ow">or</span> <span class="n">N1</span> <span class="o">!=</span> <span class="n">N2</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">new_d1</span> <span class="o">=</span> <span class="n">diagonal_model_zeros_template_json_dict</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">N1</span><span class="p">)</span>
    <span class="n">new_d1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>

    <span class="n">new_d2</span> <span class="o">=</span> <span class="n">diagonal_model_zeros_template_json_dict</span><span class="p">(</span><span class="n">A2</span><span class="p">,</span> <span class="n">N2</span><span class="p">)</span>
    <span class="n">new_d2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_d1</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">new_d1</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">new_d2</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;These diagonal models differ for key </span><span class="si">{key}</span><span class="se">\n</span><span class="s2">d1: </span><span class="si">{new_d1[key]}</span><span class="se">\n</span><span class="s2">d2: </span><span class="si">{new_d2[key]}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This line of code should not be reached!?&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="create_random_model"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.create_random_model">[docs]</a><span class="k">def</span> <span class="nf">create_random_model</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; returns a dictionary that is a valid model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;numStates&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
         <span class="s1">&#39;numModes&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
         <span class="s1">&#39;quadratic_scaling&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">),</span>
         <span class="s1">&#39;linear_scaling&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">),</span>
         <span class="s1">&#39;diagonal&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
         <span class="p">}</span>
    <span class="k">return</span> <span class="n">generate_vibronic_model_data</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_random_diagonal_model"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.create_random_diagonal_model">[docs]</a><span class="k">def</span> <span class="nf">create_random_diagonal_model</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; returns a dictionary that is a valid diagonal model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;numStates&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
         <span class="s1">&#39;numModes&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
         <span class="s1">&#39;quadratic_scaling&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">),</span>
         <span class="s1">&#39;linear_scaling&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">),</span>
         <span class="s1">&#39;diagonal&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
         <span class="p">}</span>
    <span class="k">return</span> <span class="n">generate_vibronic_model_data</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_hash</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;creates a SHA512 hash of the input string and returns the byte representation&quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha512</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>


<div class="viewcode-block" id="create_model_hash"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.create_model_hash">[docs]</a><span class="k">def</span> <span class="nf">create_model_hash</span><span class="p">(</span><span class="n">FS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; create a hash of the coupled_model.json file&#39;s contents</span>
<span class="sd">    this is used to confirm that result files were generated for the current model and not an older one</span>
<span class="sd">    uses a FileStructure or an absolute path to the file&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">FS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;no arguments provided&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span>

    <span class="k">assert</span> <span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">_hash</span><span class="p">(</span><span class="n">string</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_diagonal_model_hash"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.create_diagonal_model_hash">[docs]</a><span class="k">def</span> <span class="nf">create_diagonal_model_hash</span><span class="p">(</span><span class="n">FS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; create a hash of the sampling_model.json file&#39;s contents</span>
<span class="sd">    this is used to confirm that result files were generated for the current model and not an older one</span>
<span class="sd">    uses a FileStructure or an absolute path to the file&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">FS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;no arguments provided&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_rho_model</span>

    <span class="k">assert</span> <span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">f</span><span class="s2">&quot;The path provided is not a valid file! Path:</span><span class="se">\n</span><span class="si">{path}</span><span class="s2">&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">_hash</span><span class="p">(</span><span class="n">string</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_generate_linear_terms</span><span class="p">(</span><span class="n">linear_terms</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">displacement</span><span class="p">,</span> <span class="n">Modes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; generate linear terms that are &#39;reasonable&#39; &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Modes</span><span class="p">:</span>
        <span class="n">upTri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">displacement</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">displacement</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">])</span>
        <span class="c1"># force the linear terms to be symmetric</span>
        <span class="n">linear_terms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">upTri</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">upTri</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">_generate_quadratic_terms</span><span class="p">(</span><span class="n">quadratic_terms</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">displacement</span><span class="p">,</span> <span class="n">Modes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; generate quadratic terms that are &#39;reasonable&#39; &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">Modes</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">upTri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">displacement</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">displacement</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">])</span>
        <span class="c1"># force the quadratic terms to be symmetric</span>
        <span class="n">quadratic_terms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">upTri</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">upTri</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">quadratic_terms</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">upTri</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">upTri</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span>


<div class="viewcode-block" id="generate_vibronic_model_data"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.generate_vibronic_model_data">[docs]</a><span class="k">def</span> <span class="nf">generate_vibronic_model_data</span><span class="p">(</span><span class="n">input_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;redo this one but otherwise its fine returns e,w,l,q filled with appropriate values&quot;&quot;&quot;</span>
    <span class="n">paramDict</span> <span class="o">=</span> <span class="p">{</span>   <span class="c1"># default values</span>
                    <span class="s1">&#39;frequency_range&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">],</span>
                    <span class="s1">&#39;energy_range&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>
                    <span class="s1">&#39;quadratic_scaling&#39;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span>
                    <span class="s1">&#39;linear_scaling&#39;</span><span class="p">:</span> <span class="mf">0.04</span><span class="p">,</span>
                    <span class="s1">&#39;diagonal&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;numStates&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="s1">&#39;numModes&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="p">}</span>

    <span class="k">if</span> <span class="n">input_parameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">paramDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">input_parameters</span><span class="p">)</span>

    <span class="c1"># readability</span>
    <span class="n">minE</span><span class="p">,</span> <span class="n">maxE</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;energy_range&#39;</span><span class="p">]</span>
    <span class="n">minFreq</span><span class="p">,</span> <span class="n">maxFreq</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;frequency_range&#39;</span><span class="p">]</span>

    <span class="c1"># ranges for convenience</span>
    <span class="n">numModes</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;numModes&#39;</span><span class="p">]</span>
    <span class="n">numStates</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;numStates&#39;</span><span class="p">]</span>
    <span class="n">Modes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">numModes</span><span class="p">)</span>

    <span class="c1"># generate the array dimensions</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">model_shape_dict</span><span class="p">(</span><span class="n">numStates</span><span class="p">,</span> <span class="n">numModes</span><span class="p">)</span>

    <span class="c1"># assume we are building a coupled model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model_zeros_template_json_dict</span><span class="p">(</span><span class="n">numStates</span><span class="p">,</span> <span class="n">numModes</span><span class="p">)</span>

    <span class="c1"># generate frequencies</span>
    <span class="n">model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minFreq</span><span class="p">,</span> <span class="n">maxFreq</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">numModes</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>

    <span class="c1"># generate energy</span>
    <span class="n">model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">minE</span><span class="p">,</span> <span class="n">maxE</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">])</span>
    <span class="c1"># force the energy to be symmetric</span>
    <span class="n">model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">],</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># calculate the linear displacement</span>
    <span class="n">l_shift</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;linear_scaling&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">w</span><span class="p">]</span>
    <span class="n">_generate_linear_terms</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">],</span> <span class="n">shape</span><span class="p">,</span> <span class="n">l_shift</span><span class="p">,</span> <span class="n">Modes</span><span class="p">)</span>

    <span class="c1"># TODO - no quadratic terms for the moment - turn back on after further testing</span>
    <span class="c1"># calculate the quadratic displacement</span>
    <span class="c1"># q_shift = np.sqrt(np.outer(frequencies, frequencies)) / paramDict[&#39;quadratic_scaling&#39;]</span>
    <span class="c1"># _generate_quadratic_terms(q_terms, shape, q_shift, Modes)</span>

    <span class="c1"># if we are building a harmonic model then zero out all off-diagonal entries</span>
    <span class="k">if</span> <span class="n">paramDict</span><span class="p">[</span><span class="s1">&#39;diagonal&#39;</span><span class="p">]:</span>
        <span class="n">d_model</span> <span class="o">=</span> <span class="n">diagonal_model_zeros_template_json_dict</span><span class="p">(</span><span class="n">numStates</span><span class="p">,</span> <span class="n">numModes</span><span class="p">)</span>

        <span class="n">d_model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">])</span>
        <span class="n">d_model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">w</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Modes</span><span class="p">:</span>
            <span class="n">d_model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">Modes</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">d_model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G2</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G2</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">d_model</span>

    <span class="k">assert</span> <span class="n">model_parameters_are_symmetric_in_surfaces</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">model_parameters_are_symmetric_in_modes</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="read_model_h_file"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.read_model_h_file">[docs]</a><span class="k">def</span> <span class="nf">read_model_h_file</span><span class="p">(</span><span class="n">path_file_h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; wrapper function to maintain functionality - possible remove in the future&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">model_h</span><span class="o">.</span><span class="n">read_model_h_file</span><span class="p">(</span><span class="n">path_file_h</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_model_op_file"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.read_model_op_file">[docs]</a><span class="k">def</span> <span class="nf">read_model_op_file</span><span class="p">(</span><span class="n">path_file_op</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; wrapper function to maintain functionality - possible remove in the future&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">model_op</span><span class="o">.</span><span class="n">read_model_op_file</span><span class="p">(</span><span class="n">path_file_op</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_coupling_from_h_file"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.create_coupling_from_h_file">[docs]</a><span class="k">def</span> <span class="nf">create_coupling_from_h_file</span><span class="p">(</span><span class="n">FS</span><span class="p">,</span> <span class="n">path_file_h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;assumes that the path_file_h is in electronic_structure&quot;&quot;&quot;</span>
    <span class="c1"># A, N, E, w, l, q = read_model_h_file(path_file_h)</span>
    <span class="n">model_dict</span> <span class="o">=</span> <span class="n">read_model_h_file</span><span class="p">(</span><span class="n">path_file_h</span><span class="p">)</span>
    <span class="n">save_model_to_JSON</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">,</span> <span class="n">model_dict</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created </span><span class="se">\n</span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">from</span><span class="se">\n</span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">,</span> <span class="n">path_file_h</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span></div>


<div class="viewcode-block" id="create_coupling_from_op_file"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.create_coupling_from_op_file">[docs]</a><span class="k">def</span> <span class="nf">create_coupling_from_op_file</span><span class="p">(</span><span class="n">FS</span><span class="p">,</span> <span class="n">path_file_op</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;assumes that the path_file_op is in electronic_structure&quot;&quot;&quot;</span>
    <span class="c1"># A, N, E, w, l, q = read_model_h_file(path_file_op)</span>
    <span class="n">model_dict</span> <span class="o">=</span> <span class="n">read_model_op_file</span><span class="p">(</span><span class="n">path_file_op</span><span class="p">)</span>
    <span class="n">save_model_to_JSON</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">,</span> <span class="n">model_dict</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created </span><span class="se">\n</span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">from</span><span class="se">\n</span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">,</span> <span class="n">path_file_op</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span></div>


<div class="viewcode-block" id="create_coupling_from_op_hyperlink"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.create_coupling_from_op_hyperlink">[docs]</a><span class="k">def</span> <span class="nf">create_coupling_from_op_hyperlink</span><span class="p">(</span><span class="n">FS</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;assumes that the path_file_op is in electronic_structure&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">urllib</span>

    <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;This function is currently unfinished&quot;</span>

    <span class="n">request</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="c1"># response is now a string you can search through containing the page&#39;s html</span>
        <span class="c1"># A, N, E, w, l, q = read_model_h_file(path_file_op)</span>
        <span class="c1"># args = read_model_op_file(path_file_op)  # need to make a choice about the function here</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">save_model_to_JSON</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created </span><span class="se">\n</span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">from</span><span class="se">\n</span><span class="si">{:s}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="c1"># The URL wasn&#39;t valid</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Incorrect https link </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span></div>


<div class="viewcode-block" id="read_model_auto_file"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.read_model_auto_file">[docs]</a><span class="k">def</span> <span class="nf">read_model_auto_file</span><span class="p">(</span><span class="n">path_file_auto</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; wrapper function to maintain functionality - possible remove in the future&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">model_auto</span><span class="o">.</span><span class="n">read_model_auto_file</span><span class="p">(</span><span class="n">path_file_auto</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_extract_dimensions_from_dictionary</span><span class="p">(</span><span class="n">dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">N</span><span class="p">])</span>
    <span class="n">A</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">A</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">N</span>


<span class="k">def</span> <span class="nf">_extract_dimensions_from_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;x&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">f</span><span class="s2">&quot;invalid path:</span><span class="se">\n</span><span class="si">{path:s}</span><span class="s2">&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">input_dictionary</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">VMK</span><span class="o">.</span><span class="n">change_dictionary_keys_from_strings_to_enum_members</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_extract_dimensions_from_dictionary</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">)</span>


<div class="viewcode-block" id="extract_dimensions_of_model"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.extract_dimensions_of_model">[docs]</a><span class="k">def</span> <span class="nf">extract_dimensions_of_model</span><span class="p">(</span><span class="n">FS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;returns A, N in that order</span>
<span class="sd">    A is the number_of_surfaces and N is the number_of_modes</span>
<span class="sd">    for coupling_model.json files by using a FileStructure or an absolute path to the file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">FS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;no arguments provided&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span>
    <span class="k">return</span> <span class="n">_extract_dimensions_from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="extract_dimensions_of_diagonal_model"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.extract_dimensions_of_diagonal_model">[docs]</a><span class="k">def</span> <span class="nf">extract_dimensions_of_diagonal_model</span><span class="p">(</span><span class="n">FS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;returns A, N in that order</span>
<span class="sd">    A is the number_of_surfaces and N is the number_of_modes</span>
<span class="sd">    for sampling_model.json files by using a FileStructure or an absolute path to the file</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot; TODO - it might be nice to have the ability to specify id_data or id_rho, although this should be done in a way that queries file_structure so as to not &quot;leak&quot; the file structure out to other areas of the code</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">FS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;no arguments provided&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_rho_model</span>
    <span class="k">return</span> <span class="n">_extract_dimensions_from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_save_to_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">):</span>
    <span class="n">dict_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
    <span class="n">VMK</span><span class="o">.</span><span class="n">change_dictionary_keys_from_enum_members_to_strings</span><span class="p">(</span><span class="n">dict_copy</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot; converts each numpy array to a list so that json can serialize them properly&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_copy</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">generic</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dict_copy</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">dict_copy</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Value </span><span class="si">{value}</span><span class="s2"> with Key </span><span class="si">{key}</span><span class="s2"> does not appear to be an ndarray&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">target_file</span><span class="p">:</span>
        <span class="n">target_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dict_copy</span><span class="p">))</span>

    <span class="k">return</span>


<div class="viewcode-block" id="save_model_to_JSON"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.save_model_to_JSON">[docs]</a><span class="k">def</span> <span class="nf">save_model_to_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; wrapper for _save_to_JSON</span>
<span class="sd">    calls verify_model_parameters() before calling _save_to_JSON()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">verify_model_parameters</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Saving model to </span><span class="si">{path:s}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">_save_to_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="save_diagonal_model_to_JSON"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.save_diagonal_model_to_JSON">[docs]</a><span class="k">def</span> <span class="nf">save_diagonal_model_to_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; wrapper for _save_to_JSON</span>
<span class="sd">    calls verify_sample_parameters() before calling _save_to_JSON()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">verify_diagonal_model_parameters</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Saving sample to </span><span class="si">{path:s}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">_save_to_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">)</span>
    <span class="k">return</span></div>


<span class="k">def</span> <span class="nf">_load_inplace_from_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;overwrites all provided values in place with the values stored in the .json file located at path&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">input_dictionary</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="n">VMK</span><span class="o">.</span><span class="n">change_dictionary_keys_from_strings_to_enum_members</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">generic</span><span class="p">)):</span>
            <span class="c1"># this is a safer way of forcing the input arrays that have no corresponding key in the input_dictionary to have zero values</span>
            <span class="c1"># although this might not be necessary, it is a safer alternative at the moment</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_dictionary</span><span class="p">:</span>
                <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">_load_from_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;returns a dictionary filled with the values stored in the .json file located at path&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">input_dictionary</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="n">VMK</span><span class="o">.</span><span class="n">change_dictionary_keys_from_strings_to_enum_members</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">input_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># if we don&#39;t predefine the shape, can we run into problems?</span>
            <span class="n">input_dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>

    <span class="c1"># special case to always create an array of energies that are 0.0 if not provided in the .json file</span>
    <span class="k">if</span> <span class="n">VMK</span><span class="o">.</span><span class="n">E</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_dictionary</span><span class="p">:</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">_extract_dimensions_from_dictionary</span><span class="p">(</span><span class="n">input_dictionary</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">model_shape_dict</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">input_dictionary</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">F64</span><span class="p">)</span>

    <span class="c1"># TODO - design decision about which arrays to fill with zeros by default?</span>

    <span class="k">return</span> <span class="n">input_dictionary</span>


<div class="viewcode-block" id="load_model_from_JSON"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.load_model_from_JSON">[docs]</a><span class="k">def</span> <span class="nf">load_model_from_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dictionary</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    if kwargs is not provided then returns a dictionary filled with the values stored in the .json file located at path</span>

<span class="sd">    if kwargs is provided then all values are overwritten (in place) with the values stored in the .json file located at path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Loading model from </span><span class="si">{path:s}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># no arrays were provided so return newly created arrays after filling them with the appropriate values</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dictionary</span><span class="p">):</span>
        <span class="n">new_model_dict</span> <span class="o">=</span> <span class="n">_load_from_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># TODO - we might want to make sure that none of the values in the dictionary have all zero values or are None</span>

        <span class="n">verify_model_parameters</span><span class="p">(</span><span class="n">new_model_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_model_dict</span>

    <span class="c1"># arrays were provided so fill them with the appropriate values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">verify_model_parameters</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
        <span class="n">_load_inplace_from_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">)</span>
        <span class="c1"># check twice? might as well be cautious for the moment until test cases are written</span>
        <span class="n">verify_model_parameters</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="load_diagonal_model_from_JSON"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.load_diagonal_model_from_JSON">[docs]</a><span class="k">def</span> <span class="nf">load_diagonal_model_from_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dictionary</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    if kwargs is not provided then returns a dictionary filled with the values stored in the .json file located at path</span>

<span class="sd">    if kwargs is provided then all values are overwritten (in place) with the values stored in the .json file located at path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Loading rho model (sampling model) from </span><span class="si">{path:s}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># no arrays were provided so return newly created arrays after filling them with the appropriate values</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dictionary</span><span class="p">):</span>
        <span class="n">new_model_dict</span> <span class="o">=</span> <span class="n">_load_from_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># TODO - we might want to make sure that none of the values in the dictionary have all zero values or are None</span>

        <span class="n">verify_diagonal_model_parameters</span><span class="p">(</span><span class="n">new_model_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_model_dict</span>

    <span class="c1"># arrays were provided so fill them with the appropriate values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">verify_diagonal_model_parameters</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
        <span class="n">_load_inplace_from_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">)</span>
        <span class="c1"># check twice? might as well be cautious for the moment until test cases are written</span>
        <span class="n">verify_diagonal_model_parameters</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
    <span class="k">return</span></div>
<span class="c1"># ------------------------------------------------------------------------</span>


<div class="viewcode-block" id="simple_single_point_energy_calculation"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.simple_single_point_energy_calculation">[docs]</a><span class="k">def</span> <span class="nf">simple_single_point_energy_calculation</span><span class="p">(</span><span class="n">FS</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; generate new energy values for the diagonal model stored at the arg &#39;path&#39;</span>
<span class="sd">    this is intended to be used for re-weighting the oscillators created using the iterative method</span>

<span class="sd">    returns a list of energy values in eV which&quot;&quot;&quot;</span>

    <span class="n">iterative_model</span> <span class="o">=</span> <span class="n">load_diagonal_model_from_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VMK</span><span class="o">.</span><span class="n">G2</span> <span class="ow">in</span> <span class="n">iterative_model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">iterative_model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Support for non-zero quadratic terms in simple_single_point_energy_calculation() has not been implemented&quot;</span><span class="p">)</span>

    <span class="n">Ai</span><span class="p">,</span> <span class="n">Ni</span> <span class="o">=</span> <span class="n">_extract_dimensions_from_dictionary</span><span class="p">(</span><span class="n">iterative_model</span><span class="p">)</span>

    <span class="c1"># generate the oscillator minimum&#39;s</span>
    <span class="n">minimums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ai</span><span class="p">,</span> <span class="n">Ni</span><span class="p">))</span>

    <span class="c1"># if there is no linear term parameter in the model&#39;s dictionary, then they are all zero</span>
    <span class="c1"># and therefore are centered at the origin.</span>
    <span class="k">if</span> <span class="n">VMK</span><span class="o">.</span><span class="n">G1</span> <span class="ow">in</span> <span class="n">iterative_model</span><span class="p">:</span>
        <span class="n">w_iter</span> <span class="o">=</span> <span class="n">iterative_model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">w</span><span class="p">]</span>
        <span class="n">lin_iter</span> <span class="o">=</span> <span class="n">iterative_model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ai</span><span class="p">):</span>
            <span class="n">minimums</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="o">-</span><span class="n">lin_iter</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">],</span>  <span class="n">w_iter</span><span class="p">[:])</span>

    <span class="n">coupled_model</span> <span class="o">=</span> <span class="n">load_model_from_JSON</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">)</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">_extract_dimensions_from_dictionary</span><span class="p">(</span><span class="n">coupled_model</span><span class="p">)</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">coupled_model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">coupled_model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">w</span><span class="p">]</span>
    <span class="n">lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">model_shape_dict</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">N</span><span class="p">)[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">VMK</span><span class="o">.</span><span class="n">G1</span> <span class="ow">in</span> <span class="n">coupled_model</span><span class="p">:</span>
        <span class="n">lin</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">coupled_model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">VMK</span><span class="o">.</span><span class="n">G2</span> <span class="ow">in</span> <span class="n">coupled_model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">coupled_model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Support for non-zero quadratic terms in simple_single_point_energy_calculation() has not been implemented&quot;</span><span class="p">)</span>

    <span class="n">new_energy_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Ai</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ai</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">minimums</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># we evaluate the (R/q) point</span>

        <span class="c1"># compute the harmonic oscillator contribution</span>
        <span class="n">ho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">ho</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="n">ho</span> <span class="o">*=</span> <span class="mf">0.5</span>

        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
        <span class="n">V</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">E</span>
        <span class="n">V</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">ho</span>

        <span class="k">for</span> <span class="n">a1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">a2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
                <span class="n">V</span><span class="p">[</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lin</span><span class="p">[:,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">]</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span>

        <span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvalsh</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
        <span class="n">new_energy_values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_energy_values</span></div>


<div class="viewcode-block" id="recalculate_energy_values_of_diagonal_model"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.recalculate_energy_values_of_diagonal_model">[docs]</a><span class="k">def</span> <span class="nf">recalculate_energy_values_of_diagonal_model</span><span class="p">(</span><span class="n">FS</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; x &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot; note that these new energy values \tilde{E}^{a} values defined in equation 34 on page 4 from the archive paper, however the energy values stored in the *_model.json files are the E^{aa&#39;} values in equation 26 on page 4 so we must subtract the \Delta^{a} term from the &#39;new_energies&#39; to obtain the correct energy values which will be stored in the *_model.json file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_energies</span> <span class="o">=</span> <span class="n">simple_single_point_energy_calculation</span><span class="p">(</span><span class="n">FS</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="c1"># modify the model located at the provided path</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">load_diagonal_model_from_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># TODO - should we force that the linear terms are always present in any loaded model just like the energy values? then we don&#39;t need these checks.</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">_extract_dimensions_from_dictionary</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">diagonal_model_shape_dict</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">N</span><span class="p">)[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">VMK</span><span class="o">.</span><span class="n">G1</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">lin</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">]</span>

    <span class="n">delta_a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">lin</span><span class="o">**</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">w</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_energies</span> <span class="o">-</span> <span class="n">delta_a</span>
    <span class="n">save_diagonal_model_to_JSON</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="fill_offdiagonal_of_model_with_zeros"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.fill_offdiagonal_of_model_with_zeros">[docs]</a><span class="k">def</span> <span class="nf">fill_offdiagonal_of_model_with_zeros</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; takes a dictionary who must have values of dimensionality (..., A, A)</span>
<span class="sd">    and set the off-diagonal (surface) elements to zero</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">verify_model_parameters</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># ndims = len(value.shape)</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">VMK</span><span class="o">.</span><span class="n">A</span><span class="p">]),</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">model</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="c1"># x = np.diagonal(model[key], axis1=ndims-2, axis2=ndims-1).copy()</span>
            <span class="c1"># print(x.shape)</span>
            <span class="c1"># model[key][..., :, :] = np.diagonal(model[key], axis1=ndims-2, axis2=ndims-1).copy()</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="remove_coupling_from_model"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.remove_coupling_from_model">[docs]</a><span class="k">def</span> <span class="nf">remove_coupling_from_model</span><span class="p">(</span><span class="n">path_source</span><span class="p">,</span> <span class="n">path_destination</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;reads in a model from path_source whose values can have dimensionality (..., A, A)</span>
<span class="sd">    creates a new model whose values have dimensionality (..., A) from the diagonal of the A dimension of the input model</span>
<span class="sd">    saves the new model to the provided path_destination&quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">load_model_from_JSON</span><span class="p">(</span><span class="n">path_source</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ndims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">model</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">axis1</span><span class="o">=</span><span class="n">ndims</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="n">ndims</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">save_diagonal_model_to_JSON</span><span class="p">(</span><span class="n">path_destination</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="create_harmonic_model"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.create_harmonic_model">[docs]</a><span class="k">def</span> <span class="nf">create_harmonic_model</span><span class="p">(</span><span class="n">FS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;wrapper function to refresh harmonic model&quot;&quot;&quot;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_har_model</span>
    <span class="n">remove_coupling_from_model</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Created harmonic model </span><span class="si">{:s}</span><span class="s2"> by removing coupling from </span><span class="si">{:s}</span><span class="s2">&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">source</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dest</span></div>


<div class="viewcode-block" id="create_basic_diagonal_model"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.create_basic_diagonal_model">[docs]</a><span class="k">def</span> <span class="nf">create_basic_diagonal_model</span><span class="p">(</span><span class="n">FS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;wrapper function to make the simplest diagonal(sampling) model&quot;&quot;&quot;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">create_harmonic_model</span><span class="p">(</span><span class="n">FS</span><span class="p">)</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">FS</span><span class="o">.</span><span class="n">path_rho_model</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Sampling model </span><span class="si">{:s}</span><span class="s2"> already exists!&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest</span><span class="p">))</span>

    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Created sampling model </span><span class="si">{:s}</span><span class="s2"> by copying </span><span class="si">{:s}</span><span class="s2">&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">source</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dest</span></div>


<div class="viewcode-block" id="create_random_orthonormal_matrix"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.create_random_orthonormal_matrix">[docs]</a><span class="k">def</span> <span class="nf">create_random_orthonormal_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;returns a orthonormal matrix, just a wrapper for scipy.stats.ortho_group.rvs()&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">ortho_group</span>
    <span class="k">return</span> <span class="n">ortho_group</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">A</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_orthonormal_matrix_lambda_close_to_identity"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.create_orthonormal_matrix_lambda_close_to_identity">[docs]</a><span class="k">def</span> <span class="nf">create_orthonormal_matrix_lambda_close_to_identity</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">tuning_parameter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a wrapper for the function defined in pibronic.vibronic.orthonormal &quot;&quot;&quot;</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">orthonormal</span><span class="o">.</span><span class="n">create</span><span class="o">.</span><span class="n">create_orthonormal_matrix_lambda_close_to_identity</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">tuning_parameter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">U</span></div>


<div class="viewcode-block" id="create_fake_coupled_model"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.create_fake_coupled_model">[docs]</a><span class="k">def</span> <span class="nf">create_fake_coupled_model</span><span class="p">(</span><span class="n">FS</span><span class="p">,</span> <span class="n">tuning_parameter</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">transformation_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; take the diagonal coupled model and preform a unitary transformation on it to get a dense matrix</span>

<span class="sd">    for a tuning_parameter of 0 the transformation matrix (U) is identity</span>
<span class="sd">    the larger the value of tuning_parameter the &quot;farther&quot; away from identity U becomes</span>

<span class="sd">    if a numpy array of dim AxA is provided in the transformation_matrix then we won&#39;t create a new matrix and instead use the provided one</span>
<span class="sd">    note: if transformation_matrix is provided then the tuning_parameter is ignored</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">),</span> <span class="s2">&quot;coupled_model file doesn&#39;t exist!&quot;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">load_model_from_JSON</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">)</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">_extract_dimensions_from_dictionary</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># we will store the matrix in U</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">transformation_matrix</span>

    <span class="c1"># we now need to obtain a matrix through some means</span>
    <span class="k">if</span> <span class="n">U</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># if no parameter is provided we create a new orthonormal matrix</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">create_orthonormal_matrix_lambda_close_to_identity</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">tuning_parameter</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">U</span> <span class="o">==</span> <span class="s2">&quot;re-use&quot;</span><span class="p">:</span>
        <span class="c1"># if this special flag is provided then we will load a previous orthonormal matrix</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_ortho_mat</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="c1"># and finally we might be given the orthonormal matrix</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">A</span><span class="p">)),</span> <span class="s2">&quot;matrix is not orthonormal&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Your transformation_matrix argument is most likely incorrect?&quot;</span><span class="p">)</span>

    <span class="c1"># TODO - should we validate that the model is diagonal and not just symmetric in the surfaces?</span>
    <span class="k">assert</span> <span class="n">model_parameters_are_symmetric_in_surfaces</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">model_parameters_are_symmetric_in_modes</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">,</span> <span class="n">VMK</span><span class="o">.</span><span class="n">key_list</span><span class="p">()):</span>

        <span class="c1"># the array of coefficients that we are going to modify</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">()</span>

        <span class="c1"># simulating a case statement</span>
        <span class="n">op_switcher</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">old</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bj,jk,ck-&gt;bc&#39;</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">U</span><span class="p">),</span>
                        <span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">old</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bj,ajk,ck-&gt;abc&#39;</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">U</span><span class="p">),</span>
                        <span class="n">VMK</span><span class="o">.</span><span class="n">G2</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">old</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;cj,abjk,dk-&gt;abcd&#39;</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">U</span><span class="p">),</span>
                        <span class="n">VMK</span><span class="o">.</span><span class="n">G3</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">old</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;dj,abcjk,ek-&gt;abcde&#39;</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">U</span><span class="p">),</span>
                        <span class="n">VMK</span><span class="o">.</span><span class="n">G4</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">old</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ej,abcdjk,fk-&gt;abcdef&#39;</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">U</span><span class="p">),</span>
                        <span class="p">}</span>

        <span class="c1"># calculate the new Hamiltonian, by preforming the transformation with the matrix U</span>
        <span class="n">new_values</span> <span class="o">=</span> <span class="n">op_switcher</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">array</span><span class="p">)</span>

        <span class="c1"># number of modes in each array</span>
        <span class="n">mode_switcher</span> <span class="o">=</span> <span class="p">{</span><span class="n">VMK</span><span class="o">.</span><span class="n">E</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VMK</span><span class="o">.</span><span class="n">G1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">VMK</span><span class="o">.</span><span class="n">G2</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">VMK</span><span class="o">.</span><span class="n">G3</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">VMK</span><span class="o">.</span><span class="n">G4</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>

        <span class="c1"># make sure that the transformation was indeed unitary</span>
        <span class="k">for</span> <span class="n">iters</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">mode_switcher</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">iters</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">new_values</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">U</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>

        <span class="c1"># overwrite the previous array with the new values</span>
        <span class="n">array</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">new_values</span>

    <span class="c1"># backup the old model, i.e. the &quot;original&quot; model</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">,</span>  <span class="n">FS</span><span class="o">.</span><span class="n">path_orig_model</span><span class="p">)</span>

    <span class="c1"># overwrite the old model with the new model</span>
    <span class="n">save_model_to_JSON</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_vib_model</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

    <span class="c1"># save the orthogonal matrix in case we need to use it later</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">FS</span><span class="o">.</span><span class="n">path_ortho_mat</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../pibronic.vibronic.html#pibronic.vibronic.vibronic_model_io.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; currently does nothing &quot;&quot;&quot;</span>
    <span class="k">return</span></div>


<span class="k">if</span> <span class="p">(</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">):</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Pibronic</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pibronic.html">pibronic package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Neil Raymond.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>